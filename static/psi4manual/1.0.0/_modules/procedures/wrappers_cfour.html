

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>procedures.wrappers_cfour &mdash; Psi4 [1.0.0 6a9a71b] Docs</title>
    
    <link rel="stylesheet" href="../../_static/psi4.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0.0 6a9a71b',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="../../_static/toggle_sections.js"></script>
    <script type="text/javascript" src="../../_static/toggle_sidebar.js"></script>
    <script type="text/javascript" src="../../_static/toggle_codeprompt.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon-psi4.ico"/>
    <link rel="top" title="Psi4 [1.0.0 6a9a71b] Docs" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body role="document">
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="../../contents.html" title="Table Of Contents"
             accesskey="C">toc</a> &nbsp; &nbsp;</li>
    <li><a href="../../index.html">Psi4 [1.0.0 6a9a71b]</a> &raquo; </li>

          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for procedures.wrappers_cfour</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># @BEGIN LICENSE</span>
<span class="c1">#</span>
<span class="c1"># Psi4: an open-source quantum chemistry software package</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2007-2016 The Psi4 Developers.</span>
<span class="c1">#</span>
<span class="c1"># The copyrights for code used from other parties are included in</span>
<span class="c1"># the corresponding files.</span>
<span class="c1">#</span>
<span class="c1"># This program is free software; you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation; either version 2 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License along</span>
<span class="c1"># with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="c1"># 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="c1">#</span>
<span class="c1"># @END LICENSE</span>
<span class="c1">#</span>

<span class="sd">&quot;&quot;&quot;Module with functions for Psi4/Cfour interface. Portions that require</span>
<span class="sd">calls to Boost Python psi4 module are here, otherwise in qcdb module.</span>
<span class="sd">Also calls to qcdb module are here and not elsewhere in driver.</span>
<span class="sd">Organizationally, this module isolates qcdb code from psi4 code.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">shelve</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">difflib</span>
<span class="c1">#from driver import *</span>
<span class="c1"># Relative hack for now</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">inspect</span>
<span class="n">path_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span> <span class="p">))[</span><span class="mi">0</span><span class="p">],</span><span class="s2">&quot;../&quot;</span><span class="p">)))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path_dir</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">p4util.exceptions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="c1"># never import driver, wrappers, or aliases into this file</span>


<div class="viewcode-block" id="run_cfour_module"><a class="viewcode-back" href="../../autodoc_driver.html#procedures.wrappers_cfour.run_cfour_module">[docs]</a><span class="k">def</span> <span class="nf">run_cfour_module</span><span class="p">(</span><span class="n">xmod</span><span class="p">):</span>
    <span class="c1"># Find environment by merging PSIPATH and PATH environment variables</span>
    <span class="n">lenv</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;PATH&#39;</span><span class="p">:</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PSIPATH&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">])</span> <span class="o">+</span> \
                <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH&#39;</span><span class="p">)</span> <span class="o">+</span> \
                <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">psi4</span><span class="o">.</span><span class="n">Process</span><span class="o">.</span><span class="n">environment</span><span class="p">[</span><span class="s2">&quot;PSIDATADIR&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/basis&#39;</span> <span class="o">+</span> \
                <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">psi4</span><span class="o">.</span><span class="n">psi_top_srcdir</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;/share/basis&#39;</span><span class="p">,</span>
        <span class="s1">&#39;LD_LIBRARY_PATH&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;LD_LIBRARY_PATH&#39;</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="c1">#   Filter out None values as subprocess will fault on them</span>
    <span class="n">lenv</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">lenv</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">}</span>

    <span class="c1"># Call executable xcfour, directing cfour output to the psi4 output file</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">retcode</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">xmod</span><span class="p">],</span> <span class="n">bufsize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">lenv</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Program </span><span class="si">%s</span><span class="s1"> not found in path or execution failed: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cfour_executable</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">))</span>
        <span class="c1">#p4out.write(&#39;Program %s not found in path or execution failed: %s\n&#39; % (cfour_executable, e.strerror))</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Program </span><span class="si">%s</span><span class="s1"> not found in path or execution failed: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cfour_executable</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">))</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>        

    <span class="n">c4out</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">retcode</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="c1">#if psi4.outfile_name() == &#39;stdout&#39;:</span>
        <span class="c1">#    sys.stdout.write(data)</span>
        <span class="c1">#else:</span>
        <span class="c1">#    p4out.write(data)</span>
        <span class="c1">#    p4out.flush()</span>
        <span class="n">c4out</span> <span class="o">+=</span> <span class="n">data</span>
    <span class="c1">#internal_p4c4_info[&#39;output&#39;] = c4out</span>
    <span class="k">return</span> <span class="n">c4out</span></div>


<div class="viewcode-block" id="vpt2"><a class="viewcode-back" href="../../autodoc_driver.html#procedures.wrappers_cfour.vpt2">[docs]</a><span class="k">def</span> <span class="nf">vpt2</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perform vibrational second-order perturbation computation through</span>
<span class="sd">    Cfour to get anharmonic frequencies. This version uses c4 for the disp</span>
<span class="sd">    and pt2 but gets gradients from p4.</span>

<span class="sd">    :type c4full: :ref:`boolean &lt;op_py_boolean&gt;`</span>
<span class="sd">    :param c4full: ``&#39;on&#39;`` || |dl| ``&#39;off&#39;`` |dr|</span>

<span class="sd">        Indicates whether when *name* indicates a Cfour method and *mode*</span>
<span class="sd">        indicates a sow/reap approach, sown files are direct ZMAT files</span>
<span class="sd">        and FJOBARC files are expected to reap, so that Cfour only, not</span>
<span class="sd">        Cfour-through-Psi4, is needed for distributed jobs.</span>

<span class="sd">    .. caution:: Some features are not yet implemented. Buy a developer a coffee.</span>

<span class="sd">       - Presently uses all gradients. Could mix in analytic 2nd-derivs.</span>

<span class="sd">       - Collect resutls.</span>

<span class="sd">       - Manage scratch / subdir better.</span>

<span class="sd">       - Untangle CCSD(T) vs CCSD[T] and FJOBARC issue</span>

<span class="sd">       - Allow CFOUR_BASIS</span>

<span class="sd">       - Consider forcing some tighter convcrit, c4 and p4</span>

<span class="sd">       - sow/reap</span>

<span class="sd">       - mixed ang/bohr signals</span>

<span class="sd">       - error by converting to ang in psi?</span>

<span class="sd">       - Expand CURRENT DIPOLE XYZ beyond SCF</span>

<span class="sd">       - Remember additional FJOBARC record TOTENER2 if EXCITE .ne. NONE</span>

<span class="sd">       - S/R P4grad</span>

<span class="sd">       - S/R C4grad</span>

<span class="sd">       - C P4grad</span>

<span class="sd">       - C C4grad</span>

<span class="sd">       - switch C --&gt; S/R with recovery using shelf</span>

<span class="sd">       - pure C mode where only need P4 for wrapper</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">kwargs_lower</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s1">&#39;BASIS&#39;</span><span class="p">])</span>

    <span class="c1"># Option mode of operation- whether vpt2 run in one job or files farmed out</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="s1">&#39;vpt2_mode&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;mode&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;vpt2_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;vpt2_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;continuous&#39;</span>

    <span class="c1"># Switches for route through code- S/R or continuous &amp; Psi4 or Cfour gradients</span>
    <span class="n">isSowReap</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;vpt2_mode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;sowreap&#39;</span> <span class="k">else</span> <span class="bp">False</span>
    <span class="n">isC4notP4</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;cfour&#39;</span><span class="p">,</span> <span class="n">lowername</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;c4-&#39;</span><span class="p">,</span> <span class="n">lowername</span><span class="p">))</span>
    <span class="n">isC4fully</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;c4full&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">yes</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;c4full&#39;</span><span class="p">]))</span> <span class="ow">and</span> <span class="n">isC4notP4</span> <span class="ow">and</span> <span class="n">isSowReap</span><span class="p">)</span> <span class="k">else</span> <span class="bp">False</span>

    <span class="c1"># Save submission directory and basis set</span>
    <span class="n">current_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">user_basis</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s1">&#39;BASIS&#39;</span><span class="p">)</span>

    <span class="c1"># Open data persistence shelf- vital for sowreap, checkpoint for continuouw</span>
    <span class="n">shelf</span> <span class="o">=</span> <span class="n">shelve</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">current_directory</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">outfile_name</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.shelf&#39;</span><span class="p">,</span> <span class="n">writeback</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># Cfour keywords to request vpt2 analysis through findif gradients</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s1">&#39;CFOUR&#39;</span><span class="p">,</span> <span class="s1">&#39;CFOUR_VIBRATION&#39;</span><span class="p">,</span> <span class="s1">&#39;FINDIF&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s1">&#39;CFOUR&#39;</span><span class="p">,</span> <span class="s1">&#39;CFOUR_FREQ_ALGORITHM&#39;</span><span class="p">,</span> <span class="s1">&#39;PARALLEL&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s1">&#39;CFOUR&#39;</span><span class="p">,</span> <span class="s1">&#39;CFOUR_ANH_ALGORITHM&#39;</span><span class="p">,</span> <span class="s1">&#39;PARALLEL&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s1">&#39;CFOUR&#39;</span><span class="p">,</span> <span class="s1">&#39;CFOUR_ANHARMONIC&#39;</span><span class="p">,</span> <span class="s1">&#39;VPT2&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s1">&#39;CFOUR&#39;</span><span class="p">,</span> <span class="s1">&#39;CFOUR_FD_PROJECT&#39;</span><span class="p">,</span> <span class="s1">&#39;OFF&#39;</span><span class="p">)</span>

    <span class="c1"># When a Psi4 method is requested for vpt2, a skeleton of</span>
    <span class="c1">#   computations in Cfour is still required to hang the gradients</span>
    <span class="c1">#   upon. The skeleton is as cheap as possible (integrals only</span>
    <span class="c1">#   &amp; sto-3g) and set up here.</span>
    <span class="k">if</span> <span class="n">isC4notP4</span><span class="p">:</span>
        <span class="n">skelname</span> <span class="o">=</span> <span class="n">lowername</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">skelname</span> <span class="o">=</span> <span class="s1">&#39;c4-scf&#39;</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s1">&#39;BASIS&#39;</span><span class="p">,</span> <span class="s1">&#39;STO-3G&#39;</span><span class="p">)</span>
    <span class="c1">#    P4  &#39;c4-scf&#39;/&#39;cfour&#39;CALC_LEVEL      lowername  # temporary</span>
    <span class="c1">#    C4  lowername                       cfour{}  # temporary</span>

    <span class="k">if</span> <span class="s1">&#39;status&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">shelf</span><span class="p">:</span>
        <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;initialized&#39;</span>
        <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;linkage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;zmat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Cfour-generated ZMAT files with finite difference geometries</span>
        <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;fjobarc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Cfour- or Psi4-generated ascii files with packaged gradient results</span>
        <span class="n">shelf</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>
        <span class="c1"># how decide whether to use. keep precedent of intco.dat in mind</span>

    <span class="c1"># Construct and move into directory job scratch / cfour scratch / harm</span>
    <span class="n">psioh</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">IOManager</span><span class="o">.</span><span class="n">shared_object</span><span class="p">()</span>
    <span class="n">psio</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">shared_object</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">psioh</span><span class="o">.</span><span class="n">get_default_path</span><span class="p">())</span>  <span class="c1"># psi_scratch</span>
    <span class="n">cfour_tmpdir</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;path&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> \
        <span class="s1">&#39;psi.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">psio</span><span class="o">.</span><span class="n">get_default_namespace</span><span class="p">()</span> <span class="o">+</span> \
        <span class="s1">&#39;.cfour.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">99999</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cfour_tmpdir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">cfour_tmpdir</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cfour_tmpdir</span><span class="p">)</span>  <span class="c1"># psi_scratch/cfour</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;harm&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s1">&#39;harm&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;harm&#39;</span><span class="p">)</span>  <span class="c1"># psi_scratch/cfour/harm</span>

    <span class="n">psioh</span><span class="o">.</span><span class="n">set_specific_retention</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>  <span class="c1"># temporary, to track p4 scratch</span>
    <span class="c1">#shelf[&#39;status&#39;] = &#39;anharm_jobs_sown&#39;  # temporary to force backtrack</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;STAT&#39;</span><span class="p">,</span> <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">])</span>  <span class="c1"># temporary</span>

    <span class="c1"># Generate the ZMAT input file in scratch</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;ZMAT&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
        <span class="n">cfour_infile</span> <span class="o">=</span> <span class="n">write_zmat</span><span class="p">(</span><span class="n">skelname</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cfour_infile</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">====== Begin ZMAT input for CFOUR ======&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;ZMAT&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;======= End ZMAT input for CFOUR =======</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;genbas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;GENBAS&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="c1"># Check existing shelf consistent with generated ZMAT, store</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;000-000&#39;</span> <span class="ow">in</span> <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;zmat&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;zmat&#39;</span><span class="p">][</span><span class="s1">&#39;000-000&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">cfour_infile</span><span class="p">):</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">Differ</span><span class="p">()</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;zmat&#39;</span><span class="p">][</span><span class="s1">&#39;000-000&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(),</span> <span class="n">cfour_infile</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Input file translated to Cfour ZMAT does not match ZMAT stored in shelf.</span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">+</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">diff</span><span class="p">)))</span>
    <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;zmat&#39;</span><span class="p">][</span><span class="s1">&#39;000-000&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfour_infile</span>
    <span class="n">shelf</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>

    <span class="c1"># Reset basis after Cfour skeleton seeded</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s1">&#39;BASIS&#39;</span><span class="p">,</span> <span class="n">user_basis</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;initialized&#39;</span><span class="p">:</span>
        <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s1">&#39; VPT2 Setup: Harmonic &#39;</span><span class="p">)</span>

        <span class="c1"># Generate the displacements that will form the harmonic freq</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">psioh</span><span class="o">.</span><span class="n">get_default_path</span><span class="p">()</span> <span class="o">+</span> <span class="n">cfour_tmpdir</span> <span class="o">+</span> <span class="s1">&#39;/harm&#39;</span><span class="p">)</span>  <span class="c1"># psi_scratch/cfour/harm</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;partial.out&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">run_cfour_module</span><span class="p">(</span><span class="s1">&#39;xjoda&#39;</span><span class="p">))</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">run_cfour_module</span><span class="p">(</span><span class="s1">&#39;xsymcor&#39;</span><span class="p">))</span>

        <span class="c1"># Read the displacements that will form the harmonic freq</span>
        <span class="n">zmats0N</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;000-&#39;</span> <span class="o">+</span> <span class="n">item</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;zmat*&#39;</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">zm12</span> <span class="ow">in</span> <span class="n">zmats0N</span><span class="p">:</span>
            <span class="n">zm1</span><span class="p">,</span> <span class="n">zm2</span> <span class="o">=</span> <span class="n">zm12</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;zmat&#39;</span> <span class="o">+</span> <span class="n">zm2</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;zmat&#39;</span><span class="p">][</span><span class="n">zm12</span><span class="p">]</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">shelf</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s1">&#39;  CFOUR scratch file </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1"> has been read</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;zmat&#39;</span> <span class="o">+</span> <span class="n">zm2</span><span class="p">,</span> <span class="n">zm1</span><span class="p">,</span> <span class="n">zm2</span><span class="p">))</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;zmat&#39;</span><span class="p">][</span><span class="n">zm12</span><span class="p">])</span>

        <span class="c1"># S/R: Write distributed input files for harmonic freq</span>
        <span class="k">if</span> <span class="n">isSowReap</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">current_directory</span><span class="p">)</span>
            <span class="n">inputSansMol</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">format_currentstate_for_input</span><span class="p">(</span><span class="n">gradient</span><span class="p">,</span> <span class="n">lowername</span><span class="p">,</span> <span class="n">allButMol</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">zm12</span> <span class="ow">in</span> <span class="n">zmats0N</span><span class="p">:</span>
                <span class="n">zm1</span><span class="p">,</span> <span class="n">zm2</span> <span class="o">=</span> <span class="n">zm12</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>

                <span class="n">ifile</span> <span class="o">=</span> <span class="n">vpt2_sow_files</span><span class="p">(</span><span class="n">zm12</span><span class="p">,</span> <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;linkage&#39;</span><span class="p">],</span> <span class="n">isC4notP4</span><span class="p">,</span> <span class="n">isC4fully</span><span class="p">,</span>
                    <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;zmat&#39;</span><span class="p">][</span><span class="n">zm12</span><span class="p">],</span> <span class="n">inputSansMol</span><span class="p">,</span> <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;genbas&#39;</span><span class="p">])</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;VPT2-&#39;</span> <span class="o">+</span> <span class="n">zm12</span> <span class="o">+</span> <span class="s1">&#39;.in&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                    <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ifile</span><span class="p">)</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="n">vpt2_instructions</span><span class="p">(</span><span class="s1">&#39;harmonic&#39;</span><span class="p">,</span> <span class="n">current_directory</span><span class="p">,</span> <span class="n">zmats0N</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;harm_jobs_sown&#39;</span>

        <span class="c1"># S/R: Pause for distributed calculations</span>
        <span class="k">if</span> <span class="n">isSowReap</span><span class="p">:</span>
            <span class="n">shelf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="mf">0.0</span>

    <span class="k">if</span> <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;harm_jobs_sown&#39;</span><span class="p">:</span>
        <span class="n">zmats0N</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;zmat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;000&#39;</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">!=</span> <span class="s1">&#39;000&#39;</span><span class="p">)]</span>

        <span class="c1"># S/R: Check that distributed calcs all completed correctly</span>
        <span class="k">if</span> <span class="n">isSowReap</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">vpt2_instructions</span><span class="p">(</span><span class="s1">&#39;harmonic&#39;</span><span class="p">,</span> <span class="n">current_directory</span><span class="p">,</span> <span class="n">zmats0N</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">isOk</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">sown_jobs_status</span><span class="p">(</span><span class="n">current_directory</span><span class="p">,</span> <span class="s1">&#39;VPT2&#39;</span><span class="p">,</span> <span class="n">zmats0N</span><span class="p">,</span> <span class="n">reap_job_validate</span><span class="p">,</span>
                <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;linkage&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">,</span> <span class="s1">&#39;CURRENT DIPOLE&#39;</span><span class="p">,</span> <span class="s1">&#39;CURRENT GRADIENT&#39;</span><span class="p">])</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">isOk</span><span class="p">:</span>
                <span class="n">shelf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">return</span> <span class="mf">0.0</span>

        <span class="c1"># Collect all results from gradients forming the harmonic freq</span>
        <span class="k">for</span> <span class="n">zm12</span> <span class="ow">in</span> <span class="n">zmats0N</span><span class="p">:</span>
            <span class="n">zm1</span><span class="p">,</span> <span class="n">zm2</span> <span class="o">=</span> <span class="n">zm12</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">zm12</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;fjobarc&#39;</span><span class="p">]:</span>
                <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s1">&#39; VPT2 Computation: </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">zm12</span><span class="p">))</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39; VPT2 Computation: </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">zm12</span><span class="p">))</span>

                <span class="n">fjobarc</span> <span class="o">=</span> <span class="n">vpt2_reaprun_files</span><span class="p">(</span><span class="n">zm12</span><span class="p">,</span> <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;linkage&#39;</span><span class="p">],</span> <span class="n">isSowReap</span><span class="p">,</span> <span class="n">isC4notP4</span><span class="p">,</span> <span class="n">isC4fully</span><span class="p">,</span>
                    <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;zmat&#39;</span><span class="p">][</span><span class="n">zm12</span><span class="p">],</span> <span class="n">current_directory</span><span class="p">,</span> <span class="n">psioh</span><span class="o">.</span><span class="n">get_default_path</span><span class="p">(),</span> <span class="n">cfour_tmpdir</span><span class="p">,</span>
                    <span class="n">lowername</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
                <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;fjobarc&#39;</span><span class="p">][</span><span class="n">zm12</span><span class="p">]</span> <span class="o">=</span> <span class="n">fjobarc</span>
                <span class="n">shelf</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>
        <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;harm_jobs_reaped&#39;</span>

    <span class="k">if</span> <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;harm_jobs_reaped&#39;</span><span class="p">:</span>
        <span class="n">zmats0N</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;zmat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;000&#39;</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">!=</span> <span class="s1">&#39;000&#39;</span><span class="p">)]</span>

        <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s1">&#39; VPT2 Results: Harmonic &#39;</span><span class="p">)</span>

        <span class="c1"># Process the gradients into harmonic freq</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">psioh</span><span class="o">.</span><span class="n">get_default_path</span><span class="p">()</span> <span class="o">+</span> <span class="n">cfour_tmpdir</span> <span class="o">+</span> <span class="s1">&#39;/harm&#39;</span><span class="p">)</span>  <span class="c1"># psi_scratch/cfour/harm</span>
        <span class="n">harmout</span> <span class="o">=</span> <span class="n">run_cfour_module</span><span class="p">(</span><span class="s1">&#39;xjoda&#39;</span><span class="p">)</span>
        <span class="n">harmout</span> <span class="o">+=</span> <span class="n">run_cfour_module</span><span class="p">(</span><span class="s1">&#39;xsymcor&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">zm12</span> <span class="ow">in</span> <span class="n">zmats0N</span><span class="p">:</span>
            <span class="n">zm1</span><span class="p">,</span> <span class="n">zm2</span> <span class="o">=</span> <span class="n">zm12</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;FJOBARC&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;fjobarc&#39;</span><span class="p">][</span><span class="n">zm12</span><span class="p">])</span>
            <span class="n">harmout</span> <span class="o">+=</span> <span class="n">run_cfour_module</span><span class="p">(</span><span class="s1">&#39;xja2fja&#39;</span><span class="p">)</span>
            <span class="n">harmout</span> <span class="o">+=</span> <span class="n">run_cfour_module</span><span class="p">(</span><span class="s1">&#39;xsymcor&#39;</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="s1">&#39;FJOBARC&#39;</span><span class="p">,</span> <span class="s1">&#39;fja.&#39;</span> <span class="o">+</span> <span class="n">zm12</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;zmat&#39;</span> <span class="o">+</span> <span class="n">zm2</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">harmout</span> <span class="o">+=</span> <span class="n">run_cfour_module</span><span class="p">(</span><span class="s1">&#39;xjoda&#39;</span><span class="p">)</span>
        <span class="n">harmout</span> <span class="o">+=</span> <span class="n">run_cfour_module</span><span class="p">(</span><span class="s1">&#39;xcubic&#39;</span><span class="p">)</span>

        <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">harmout</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;harm.out&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">harmout</span><span class="p">)</span>

        <span class="c1"># Generate displacements along harmonic normal modes</span>
        <span class="n">zmatsN0</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;zmat*&#39;</span><span class="p">))]</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>  <span class="c1"># psi_scratch/cfour</span>
        <span class="k">for</span> <span class="n">zm1</span> <span class="ow">in</span> <span class="n">zmatsN0</span><span class="p">:</span>
            <span class="n">zm12</span> <span class="o">=</span> <span class="n">zm1</span> <span class="o">+</span> <span class="s1">&#39;-000&#39;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">psioh</span><span class="o">.</span><span class="n">get_default_path</span><span class="p">()</span> <span class="o">+</span> <span class="n">cfour_tmpdir</span> <span class="o">+</span> <span class="s1">&#39;/harm/zmat&#39;</span> <span class="o">+</span> <span class="n">zm1</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;zmat&#39;</span><span class="p">][</span><span class="n">zm12</span><span class="p">]</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">shelf</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>
                <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s1">&#39;  CFOUR scratch file </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1"> has been read</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;zmat&#39;</span> <span class="o">+</span> <span class="n">zm1</span><span class="p">,</span> <span class="n">zm12</span><span class="p">))</span>
                <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;zmat&#39;</span><span class="p">][</span><span class="n">zm12</span><span class="p">])</span>

            <span class="c1"># Collect displacements along the normal coordinates generated by the harmonic freq.</span>
            <span class="c1">#   Further harmonic freqs are to be run at each of these to produce quartic force field.</span>
            <span class="c1">#   To carry these out, generate displacements for findif by gradient at each displacement.</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">zm1</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">zm1</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">zm1</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">zm1</span><span class="p">)</span>  <span class="c1"># psi_scratch/cfour/004</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;ZMAT&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;zmat&#39;</span><span class="p">][</span><span class="n">zm12</span><span class="p">])</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="s1">&#39;../harm/GENBAS&#39;</span><span class="p">,</span> <span class="s1">&#39;GENBAS&#39;</span><span class="p">)</span>  <span class="c1"># ln -s $ecpdir/ECPDATA $j/ECPDATA</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;partial.out&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">run_cfour_module</span><span class="p">(</span><span class="s1">&#39;xjoda&#39;</span><span class="p">))</span>
                <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">run_cfour_module</span><span class="p">(</span><span class="s1">&#39;xsymcor&#39;</span><span class="p">))</span>

            <span class="c1"># Read the displacements that will form the anharmonic freq</span>
            <span class="n">zmatsNN</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;zmat*&#39;</span><span class="p">))]</span>
            <span class="k">for</span> <span class="n">zm2</span> <span class="ow">in</span> <span class="n">zmatsNN</span><span class="p">:</span>
                <span class="n">zm12</span> <span class="o">=</span> <span class="n">zm1</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">zm2</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">psioh</span><span class="o">.</span><span class="n">get_default_path</span><span class="p">()</span> <span class="o">+</span> <span class="n">cfour_tmpdir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">zm1</span> <span class="o">+</span> <span class="s1">&#39;/zmat&#39;</span> <span class="o">+</span> <span class="n">zm2</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                    <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;zmat&#39;</span><span class="p">][</span><span class="n">zm12</span><span class="p">]</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="n">shelf</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>
                    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s1">&#39;  CFOUR scratch file </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1"> has been read</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;zmat&#39;</span> <span class="o">+</span> <span class="n">zm2</span><span class="p">,</span> <span class="n">zm12</span><span class="p">))</span>
                    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;zmat&#39;</span><span class="p">][</span><span class="n">zm12</span><span class="p">])</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>  <span class="c1"># psi_scratch/cfour</span>

        <span class="n">zmatsNN</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;zmat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;000&#39;</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">!=</span> <span class="s1">&#39;000&#39;</span><span class="p">)]</span>

        <span class="c1"># S/R: Write distributed input files for anharmonic freq</span>
        <span class="k">if</span> <span class="n">isSowReap</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">current_directory</span><span class="p">)</span>
            <span class="n">inputSansMol</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">format_currentstate_for_input</span><span class="p">(</span><span class="n">gradient</span><span class="p">,</span> <span class="n">lowername</span><span class="p">,</span> <span class="n">allButMol</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">zm12</span> <span class="ow">in</span> <span class="n">zmatsNN</span><span class="p">:</span>
                <span class="n">zm1</span><span class="p">,</span> <span class="n">zm2</span> <span class="o">=</span> <span class="n">zm12</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>

                <span class="n">ifile</span> <span class="o">=</span> <span class="n">vpt2_sow_files</span><span class="p">(</span><span class="n">zm12</span><span class="p">,</span> <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;linkage&#39;</span><span class="p">],</span> <span class="n">isC4notP4</span><span class="p">,</span> <span class="n">isC4fully</span><span class="p">,</span>
                    <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;zmat&#39;</span><span class="p">][</span><span class="n">zm12</span><span class="p">],</span> <span class="n">inputSansMol</span><span class="p">,</span> <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;genbas&#39;</span><span class="p">])</span>
                <span class="c1"># GENBAS needed here</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;VPT2-&#39;</span> <span class="o">+</span> <span class="n">zm12</span> <span class="o">+</span> <span class="s1">&#39;.in&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                    <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ifile</span><span class="p">)</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="n">vpt2_instructions</span><span class="p">(</span><span class="s1">&#39;anharmonic&#39;</span><span class="p">,</span> <span class="n">current_directory</span><span class="p">,</span> <span class="n">zmatsNN</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;anharm_jobs_sown&#39;</span>

        <span class="c1"># S/R: Pause for distributed calculations</span>
        <span class="k">if</span> <span class="n">isSowReap</span><span class="p">:</span>
            <span class="n">shelf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="mf">0.0</span>

    <span class="k">if</span> <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;anharm_jobs_sown&#39;</span><span class="p">:</span>
        <span class="n">zmatsNN</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;zmat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;000&#39;</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">!=</span> <span class="s1">&#39;000&#39;</span><span class="p">)]</span>

        <span class="c1"># S/R: Check that distributed calcs all completed correctly</span>
        <span class="k">if</span> <span class="n">isSowReap</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">vpt2_instructions</span><span class="p">(</span><span class="s1">&#39;anharmonic&#39;</span><span class="p">,</span> <span class="n">current_directory</span><span class="p">,</span> <span class="n">zmatsNN</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">isOk</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">sown_jobs_status</span><span class="p">(</span><span class="n">current_directory</span><span class="p">,</span> <span class="s1">&#39;VPT2&#39;</span><span class="p">,</span> <span class="n">zmatsNN</span><span class="p">,</span> 
                <span class="n">reap_job_validate</span><span class="p">,</span> <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;linkage&#39;</span><span class="p">],</span> 
                <span class="p">[</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">,</span> <span class="s1">&#39;CURRENT DIPOLE&#39;</span><span class="p">,</span> <span class="s1">&#39;CURRENT GRADIENT&#39;</span><span class="p">])</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">isOk</span><span class="p">:</span>
                <span class="n">shelf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">return</span> <span class="mf">0.0</span>

        <span class="c1"># Collect all results from gradients forming the anharmonic freq</span>
        <span class="k">for</span> <span class="n">zm12</span> <span class="ow">in</span> <span class="n">zmatsNN</span><span class="p">:</span>
            <span class="n">zm1</span><span class="p">,</span> <span class="n">zm2</span> <span class="o">=</span> <span class="n">zm12</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">zm12</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;fjobarc&#39;</span><span class="p">]:</span>
                <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s1">&#39; VPT2 Computation: </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">zm12</span><span class="p">))</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39; VPT2 Computation: </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">zm12</span><span class="p">))</span>

                <span class="n">fjobarc</span> <span class="o">=</span> <span class="n">vpt2_reaprun_files</span><span class="p">(</span><span class="n">zm12</span><span class="p">,</span> <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;linkage&#39;</span><span class="p">],</span> <span class="n">isSowReap</span><span class="p">,</span> <span class="n">isC4notP4</span><span class="p">,</span> <span class="n">isC4fully</span><span class="p">,</span>
                    <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;zmat&#39;</span><span class="p">][</span><span class="n">zm12</span><span class="p">],</span> <span class="n">current_directory</span><span class="p">,</span> <span class="n">psioh</span><span class="o">.</span><span class="n">get_default_path</span><span class="p">(),</span> <span class="n">cfour_tmpdir</span><span class="p">,</span>
                    <span class="n">lowername</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
                <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;fjobarc&#39;</span><span class="p">][</span><span class="n">zm12</span><span class="p">]</span> <span class="o">=</span> <span class="n">fjobarc</span>
                <span class="n">shelf</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>
        <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;anharm_jobs_reaped&#39;</span>

    <span class="k">if</span> <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;anharm_jobs_reaped&#39;</span><span class="p">:</span>
        <span class="n">zmats0N</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;zmat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;000&#39;</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">!=</span> <span class="s1">&#39;000&#39;</span><span class="p">)]</span>
        <span class="n">zmatsN0</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;zmat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;000&#39;</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;000&#39;</span><span class="p">)]</span>
        <span class="n">zmatsNN</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;zmat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;000&#39;</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">!=</span> <span class="s1">&#39;000&#39;</span><span class="p">)]</span>

        <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s1">&#39; VPT2 Results: Harmonic &#39;</span><span class="p">)</span>

        <span class="c1"># Process the gradients into harmonic freq</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">psioh</span><span class="o">.</span><span class="n">get_default_path</span><span class="p">()</span> <span class="o">+</span> <span class="n">cfour_tmpdir</span><span class="p">)</span>  <span class="c1"># psi_scratch/cfour</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;anharm&#39;</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s1">&#39;anharm&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s1">&#39;anharm&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;harm&#39;</span><span class="p">)</span>  <span class="c1"># psi_scratch/cfour/harm</span>
        <span class="n">run_cfour_module</span><span class="p">(</span><span class="s1">&#39;xclean&#39;</span><span class="p">)</span>
        <span class="n">anharmout</span> <span class="o">=</span> <span class="n">run_cfour_module</span><span class="p">(</span><span class="s1">&#39;xjoda&#39;</span><span class="p">)</span>
        <span class="n">anharmout</span> <span class="o">+=</span> <span class="n">run_cfour_module</span><span class="p">(</span><span class="s1">&#39;xsymcor&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">zm12</span> <span class="ow">in</span> <span class="n">zmats0N</span><span class="p">:</span>
            <span class="n">zm1</span><span class="p">,</span> <span class="n">zm2</span> <span class="o">=</span> <span class="n">zm12</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;FJOBARC&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;fjobarc&#39;</span><span class="p">][</span><span class="n">zm12</span><span class="p">])</span>
            <span class="n">anharmout</span> <span class="o">+=</span> <span class="n">run_cfour_module</span><span class="p">(</span><span class="s1">&#39;xja2fja&#39;</span><span class="p">)</span>
            <span class="n">anharmout</span> <span class="o">+=</span> <span class="n">run_cfour_module</span><span class="p">(</span><span class="s1">&#39;xsymcor&#39;</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="s1">&#39;FJOBARC&#39;</span><span class="p">,</span> <span class="s1">&#39;fja.&#39;</span> <span class="o">+</span> <span class="n">zm12</span><span class="p">)</span>
        <span class="n">anharmout</span> <span class="o">+=</span> <span class="n">run_cfour_module</span><span class="p">(</span><span class="s1">&#39;xjoda&#39;</span><span class="p">)</span>
        <span class="n">anharmout</span> <span class="o">+=</span> <span class="n">run_cfour_module</span><span class="p">(</span><span class="s1">&#39;xcubic&#39;</span><span class="p">)</span>

        <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">anharmout</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;harm.out&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">anharmout</span><span class="p">)</span>

        <span class="c1"># Process the gradients into harmonic freq at each normco displaced point</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>  <span class="c1"># psi_scratch/cfour</span>
        <span class="k">for</span> <span class="n">zm11</span> <span class="ow">in</span> <span class="n">zmatsN0</span><span class="p">:</span>
            <span class="n">zm1</span> <span class="o">=</span> <span class="n">zm11</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">zm1</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">zm1</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">zm1</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">zm1</span><span class="p">)</span>  <span class="c1"># psi_scratch/cfour/004</span>

            <span class="n">run_cfour_module</span><span class="p">(</span><span class="s1">&#39;xclean&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;ZMAT&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;zmat&#39;</span><span class="p">][</span><span class="n">zm11</span><span class="p">])</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="s1">&#39;../harm/GENBAS&#39;</span><span class="p">,</span> <span class="s1">&#39;GENBAS&#39;</span><span class="p">)</span>
            <span class="n">anharmout</span> <span class="o">=</span> <span class="n">run_cfour_module</span><span class="p">(</span><span class="s1">&#39;xjoda&#39;</span><span class="p">)</span>
            <span class="n">anharmout</span> <span class="o">+=</span> <span class="n">run_cfour_module</span><span class="p">(</span><span class="s1">&#39;xsymcor&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">zm22</span> <span class="ow">in</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">zmatsNN</span> <span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">zm1</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">!=</span> <span class="s1">&#39;000&#39;</span><span class="p">)]:</span>
                <span class="n">zm2</span> <span class="o">=</span> <span class="n">zm22</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span>
                <span class="n">zm12</span> <span class="o">=</span> <span class="n">zm1</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">zm2</span>
                <span class="k">print</span><span class="p">(</span><span class="n">zm12</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;FJOBARC&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                    <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;fjobarc&#39;</span><span class="p">][</span><span class="n">zm12</span><span class="p">])</span>
                <span class="n">anharmout</span> <span class="o">+=</span> <span class="n">run_cfour_module</span><span class="p">(</span><span class="s1">&#39;xja2fja&#39;</span><span class="p">)</span>
                <span class="n">anharmout</span> <span class="o">+=</span> <span class="n">run_cfour_module</span><span class="p">(</span><span class="s1">&#39;xsymcor&#39;</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="s1">&#39;FJOBARC&#39;</span><span class="p">,</span> <span class="s1">&#39;fja.&#39;</span> <span class="o">+</span> <span class="n">zm12</span><span class="p">)</span>
            <span class="n">anharmout</span> <span class="o">+=</span> <span class="n">run_cfour_module</span><span class="p">(</span><span class="s1">&#39;xjoda&#39;</span><span class="p">)</span>
            <span class="n">anharmout</span> <span class="o">+=</span> <span class="n">run_cfour_module</span><span class="p">(</span><span class="s1">&#39;xja2fja&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;FJOBARC&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;fjobarc&#39;</span><span class="p">][</span><span class="n">zm11</span><span class="p">]</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">shelf</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>

            <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">anharmout</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;partial.out&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">anharmout</span><span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>  <span class="c1"># psi_scratch/cfour</span>

        <span class="c1"># Process the harmonic freqs at normco displacements into anharmonic freq</span>
        <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s1">&#39; VPT2 Results: Anharmonic &#39;</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;anharm&#39;</span><span class="p">)</span>  <span class="c1"># psi_scratch/cfour/anharm</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="s1">&#39;../harm/JOBARC&#39;</span><span class="p">,</span> <span class="s1">&#39;JOBARC&#39;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="s1">&#39;../harm/JAINDX&#39;</span><span class="p">,</span> <span class="s1">&#39;JAINDX&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">zm12</span> <span class="ow">in</span> <span class="n">zmatsN0</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;FJOBARC&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;fjobarc&#39;</span><span class="p">][</span><span class="n">zm12</span><span class="p">])</span>
            <span class="n">anharmout</span> <span class="o">=</span> <span class="n">run_cfour_module</span><span class="p">(</span><span class="s1">&#39;xja2fja&#39;</span><span class="p">)</span>
            <span class="n">anharmout</span> <span class="o">+=</span> <span class="n">run_cfour_module</span><span class="p">(</span><span class="s1">&#39;xcubic&#39;</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="s1">&#39;FJOBARC&#39;</span><span class="p">,</span> <span class="s1">&#39;fja.&#39;</span> <span class="o">+</span> <span class="n">zm12</span><span class="p">)</span>

        <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">anharmout</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;anharm.out&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">anharmout</span><span class="p">)</span>

        <span class="n">shelf</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;vpt2_completed&#39;</span>

    <span class="c1"># Finish up</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">current_directory</span><span class="p">)</span>
    <span class="n">shelf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span></div>


<div class="viewcode-block" id="vpt2_sow_files"><a class="viewcode-back" href="../../autodoc_driver.html#procedures.wrappers_cfour.vpt2_sow_files">[docs]</a><span class="k">def</span> <span class="nf">vpt2_sow_files</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">linkage</span><span class="p">,</span> <span class="n">isC4notP4</span><span class="p">,</span> <span class="n">isC4fully</span><span class="p">,</span> <span class="n">zmat</span><span class="p">,</span> <span class="n">inputSansMol</span><span class="p">,</span> <span class="n">inputGenbas</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Provided with the particular displacement number *item* and the</span>
<span class="sd">    associated *zmat* file contents and *linkage*, and common contents</span>
<span class="sd">    *inputSansMol*, returns contents of input file to be sown.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">inputReapOrders</span> <span class="o">=</span> <span class="s2">r&quot;&quot;&quot;</span>
<span class="s2">print_variables()</span>

<span class="s2">print_out(&#39;VPT2 RESULT: linkage {0} for item {1} yields CURRENT ENERGY being </span><span class="si">%r</span><span class="s2">\n&#39; % (get_variable(&#39;CURRENT ENERGY&#39;)))</span>
<span class="s2">print_out(&#39;VPT2 RESULT: linkage {0} for item {1} yields CURRENT GRADIENT being </span><span class="si">%r</span><span class="s2">\n&#39; % (p4util.mat2arr(psi4.get_gradient())))</span>
<span class="s2">print_out(&#39;VPT2 RESULT: linkage {0} for item {1} yields CURRENT DIPOLE being [</span><span class="si">%r</span><span class="s2">, </span><span class="si">%r</span><span class="s2">, </span><span class="si">%r</span><span class="s2">]\n&#39; % (get_variable(&#39;CURRENT DIPOLE X&#39;), get_variable(&#39;CURRENT DIPOLE Y&#39;), get_variable(&#39;CURRENT DIPOLE Z&#39;)))</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">linkage</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

    <span class="c1"># Direct Cfour for gradients</span>
    <span class="k">if</span> <span class="n">isC4fully</span><span class="p">:</span>
        <span class="n">inputString</span> <span class="o">=</span> <span class="n">zmat</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;VPT2-GENBAS&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">inputGenbas</span><span class="p">)</span>

    <span class="c1"># Cfour for gradients</span>
    <span class="k">elif</span> <span class="n">isC4notP4</span><span class="p">:</span>
        <span class="c1"># GENBAS needed here</span>
        <span class="n">inputString</span> <span class="o">=</span> <span class="s1">&#39;extracted_genbas = &quot;&quot;&quot;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">inputGenbas</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">blankline</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&quot;&quot;&quot;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
        <span class="n">inputString</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;cfour {</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">}</span><span class="se">\n\n</span><span class="s2">energy(&#39;cfour&#39;, genbas=extracted_genbas)</span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">zmat</span><span class="p">)</span>
        <span class="n">inputString</span> <span class="o">+=</span> <span class="n">inputReapOrders</span>
        <span class="n">inputString</span> <span class="o">+=</span> <span class="s2">r&quot;&quot;&quot;</span>
<span class="s2">print_out(&#39;VPT2 RESULT: linkage {0} for item {1} yields CURRENT MOLECULE being </span><span class="si">%r</span><span class="s2">\n&#39; % (get_active_molecule().create_psi4_string_from_molecule()))</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">linkage</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

    <span class="c1"># Psi4 for gradients</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inputString</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">format_molecule_for_input</span><span class="p">(</span>
            <span class="n">qcdb</span><span class="o">.</span><span class="n">cfour</span><span class="o">.</span><span class="n">harvest_zmat</span><span class="p">(</span><span class="n">zmat</span><span class="p">)</span><span class="o">.</span><span class="n">create_psi4_string_from_molecule</span><span class="p">(),</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;disp&#39;</span> <span class="o">+</span> <span class="n">item</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">item</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:])</span>
        <span class="n">inputString</span> <span class="o">+=</span> <span class="n">inputSansMol</span>
        <span class="n">inputString</span> <span class="o">+=</span> <span class="n">inputReapOrders</span>

    <span class="k">return</span> <span class="n">inputString</span></div>


<div class="viewcode-block" id="vpt2_reaprun_files"><a class="viewcode-back" href="../../autodoc_driver.html#procedures.wrappers_cfour.vpt2_reaprun_files">[docs]</a><span class="k">def</span> <span class="nf">vpt2_reaprun_files</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">linkage</span><span class="p">,</span> <span class="n">isSowReap</span><span class="p">,</span> <span class="n">isC4notP4</span><span class="p">,</span> <span class="n">isC4fully</span><span class="p">,</span> <span class="n">zmat</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">scrdir</span><span class="p">,</span> <span class="n">c4scrdir</span><span class="p">,</span> <span class="n">lowername</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Provided with the particular displacement number *item* and the</span>
<span class="sd">    associated *zmat* file with geometry and *linkage*, returns the</span>
<span class="sd">    FJOBARC contents. Depending on the mode settings of *isC4notP4*,</span>
<span class="sd">    *isSowReap*, and *isC4fully*, either runs (using *lowername* and</span>
<span class="sd">    *kwargs*) or reaps contents. *outdir* is where psi4 was invoked,</span>
<span class="sd">    *scrdir* is the psi4 scratch directory, and *c4scrdir* is Cfour</span>
<span class="sd">    scratch directory within.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>  <span class="c1"># current_directory</span>
    <span class="c1"># Extract qcdb.Molecule at findif orientation</span>
    <span class="n">zmmol</span> <span class="o">=</span> <span class="n">qcdb</span><span class="o">.</span><span class="n">cfour</span><span class="o">.</span><span class="n">harvest_zmat</span><span class="p">(</span><span class="n">zmat</span><span class="p">)</span>

    <span class="c1"># Cfour S/R Direct for gradients</span>
    <span class="k">if</span> <span class="n">isC4fully</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;VPT2-&#39;</span> <span class="o">+</span> <span class="n">item</span> <span class="o">+</span> <span class="s1">&#39;.fja&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="n">fjobarc</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="c1"># Cfour for gradients</span>
    <span class="k">elif</span> <span class="n">isC4notP4</span><span class="p">:</span>

        <span class="c1"># S/R: Reap results from output file</span>
        <span class="k">if</span> <span class="n">isSowReap</span><span class="p">:</span>
            <span class="n">isOk</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">results</span> <span class="o">=</span> <span class="n">reap_job_validate</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;VPT2&#39;</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">linkage</span><span class="p">,</span>
                <span class="p">[</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">,</span> <span class="s1">&#39;CURRENT DIPOLE&#39;</span><span class="p">,</span> <span class="s1">&#39;CURRENT GRADIENT&#39;</span><span class="p">,</span> <span class="s1">&#39;CURRENT MOLECULE&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">isOk</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="n">fje</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">]</span>
            <span class="n">fjgrd</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;CURRENT GRADIENT&#39;</span><span class="p">]</span>
            <span class="n">fjdip</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="o">/</span> <span class="n">p4const</span><span class="o">.</span><span class="n">psi_dipmom_au2debye</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;CURRENT DIPOLE&#39;</span><span class="p">]]</span>
            <span class="n">c4mol</span> <span class="o">=</span> <span class="n">qcdb</span><span class="o">.</span><span class="n">Molecule</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;CURRENT MOLECULE&#39;</span><span class="p">])</span>
            <span class="n">c4mol</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>

        <span class="c1"># C: Run the job and collect results</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Prepare Cfour skeleton calc directory</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">scrdir</span> <span class="o">+</span> <span class="n">c4scrdir</span><span class="p">)</span>  <span class="c1"># psi_scratch/cfour</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;scr.&#39;</span> <span class="o">+</span> <span class="n">item</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s1">&#39;scr.&#39;</span> <span class="o">+</span> <span class="n">item</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s1">&#39;scr.&#39;</span> <span class="o">+</span> <span class="n">item</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;scr.&#39;</span> <span class="o">+</span> <span class="n">item</span><span class="p">)</span>  <span class="c1"># psi_scratch/cfour/scr.000-004</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;ZMAT&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">zmat</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="s1">&#39;../harm/GENBAS&#39;</span><span class="p">,</span> <span class="s1">&#39;GENBAS&#39;</span><span class="p">)</span>

            <span class="c1">#os.chdir(scrdir + &#39;/scr.&#39; + item)</span>
            <span class="c1">#run_cfour_module(&#39;xja2fja&#39;)</span>
            <span class="c1">#with open(&#39;FJOBARC&#39;, &#39;r&#39;) as handle:</span>
            <span class="c1">#    fjobarc = handle.read()</span>

            <span class="c1"># Run Cfour calc using ZMAT &amp; GENBAS in scratch, outdir redirects to outfile</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>  <span class="c1"># current_directory</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">()</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s1">&#39;blank_molecule_psi4_yo&#39;</span><span class="p">)</span>
            <span class="n">energy</span><span class="p">(</span><span class="s1">&#39;cfour&#39;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">c4scrdir</span> <span class="o">+</span> <span class="s1">&#39;/scr.&#39;</span> <span class="o">+</span> <span class="n">item</span><span class="p">)</span>
<span class="c1">#            os.chdir(scrdir + &#39;/scr.&#39; + item)</span>

            <span class="n">fje</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">)</span>
            <span class="n">fjgrd</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">mat2arr</span><span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_gradient</span><span class="p">())</span>
            <span class="n">fjdip</span> <span class="o">=</span> <span class="p">[</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;CURRENT DIPOLE X&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">p4const</span><span class="o">.</span><span class="n">psi_dipmom_au2debye</span><span class="p">,</span>
                     <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;CURRENT DIPOLE Y&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">p4const</span><span class="o">.</span><span class="n">psi_dipmom_au2debye</span><span class="p">,</span>
                     <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;CURRENT DIPOLE Z&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">p4const</span><span class="o">.</span><span class="n">psi_dipmom_au2debye</span><span class="p">]</span>
            <span class="n">c4mol</span> <span class="o">=</span> <span class="n">qcdb</span><span class="o">.</span><span class="n">Molecule</span><span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">()</span><span class="o">.</span><span class="n">create_psi4_string_from_molecule</span><span class="p">())</span>
            <span class="n">c4mol</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>

        <span class="c1"># Get map btwn ZMAT and C4 orientation, then use it, grad and dipole to forge FJOBARC file</span>
        <span class="n">fjobarc</span> <span class="o">=</span> <span class="n">qcdb</span><span class="o">.</span><span class="n">cfour</span><span class="o">.</span><span class="n">format_fjobarc</span><span class="p">(</span><span class="n">fje</span><span class="p">,</span>
            <span class="o">*</span><span class="n">qcdb</span><span class="o">.</span><span class="n">cfour</span><span class="o">.</span><span class="n">backtransform</span><span class="p">(</span><span class="n">chgeMol</span><span class="o">=</span><span class="n">zmmol</span><span class="p">,</span> <span class="n">permMol</span><span class="o">=</span><span class="n">c4mol</span><span class="p">),</span> <span class="n">gradient</span><span class="o">=</span><span class="n">fjgrd</span><span class="p">,</span> <span class="n">dipole</span><span class="o">=</span><span class="n">fjdip</span><span class="p">)</span>

    <span class="c1"># Psi4 for gradients</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Prepare Cfour skeleton calc directory</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">scrdir</span> <span class="o">+</span> <span class="n">c4scrdir</span><span class="p">)</span>  <span class="c1"># psi_scratch/cfour</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;scr.&#39;</span> <span class="o">+</span> <span class="n">item</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s1">&#39;scr.&#39;</span> <span class="o">+</span> <span class="n">item</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s1">&#39;scr.&#39;</span> <span class="o">+</span> <span class="n">item</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;scr.&#39;</span> <span class="o">+</span> <span class="n">item</span><span class="p">)</span>  <span class="c1"># psi_scratch/cfour/scr.000-004</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;ZMAT&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">zmat</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="s1">&#39;../harm/GENBAS&#39;</span><span class="p">,</span> <span class="s1">&#39;GENBAS&#39;</span><span class="p">)</span>

        <span class="c1"># Run Cfour skeleton calc and extract qcdb.Molecule at needed C4 orientation</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;partial.out&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">run_cfour_module</span><span class="p">(</span><span class="s1">&#39;xjoda&#39;</span><span class="p">))</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">run_cfour_module</span><span class="p">(</span><span class="s1">&#39;xvmol&#39;</span><span class="p">))</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">run_cfour_module</span><span class="p">(</span><span class="s1">&#39;xvmol2ja&#39;</span><span class="p">))</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s1">&#39;  CFOUR scratch file </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1"> has been read</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;JOBARC (binary)&#39;</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span>
        <span class="n">c4mol</span> <span class="o">=</span> <span class="n">qcdb</span><span class="o">.</span><span class="n">cfour</span><span class="o">.</span><span class="n">jajo2mol</span><span class="p">(</span><span class="n">qcdb</span><span class="o">.</span><span class="n">jajo</span><span class="o">.</span><span class="n">getrec</span><span class="p">([</span><span class="s1">&#39;COORD   &#39;</span><span class="p">,</span> <span class="s1">&#39;ATOMCHRG&#39;</span><span class="p">,</span> <span class="s1">&#39;MAP2ZMAT&#39;</span><span class="p">]))</span>

        <span class="c1"># S/R: Reap results from output file</span>
        <span class="k">if</span> <span class="n">isSowReap</span><span class="p">:</span>
            <span class="n">isOk</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">results</span> <span class="o">=</span> <span class="n">reap_job_validate</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;VPT2&#39;</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">linkage</span><span class="p">,</span>
                <span class="p">[</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">,</span> <span class="s1">&#39;CURRENT DIPOLE&#39;</span><span class="p">,</span> <span class="s1">&#39;CURRENT GRADIENT&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">isOk</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="n">fje</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">]</span>
            <span class="n">fjgrd</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;CURRENT GRADIENT&#39;</span><span class="p">]</span>
            <span class="n">fjdip</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="o">/</span> <span class="n">p4const</span><span class="o">.</span><span class="n">psi_dipmom_au2debye</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;CURRENT DIPOLE&#39;</span><span class="p">]]</span>

        <span class="c1"># C: Run the job and collect results</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">set_default_namespace</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">molecule</span> <span class="o">=</span> <span class="n">geometry</span><span class="p">(</span><span class="n">zmmol</span><span class="o">.</span><span class="n">create_psi4_string_from_molecule</span><span class="p">(),</span> <span class="s1">&#39;disp-&#39;</span> <span class="o">+</span> <span class="n">item</span><span class="p">)</span>
            <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>
            <span class="n">gradient</span><span class="p">(</span><span class="n">lowername</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">fje</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">)</span>
            <span class="n">fjgrd</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">mat2arr</span><span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_gradient</span><span class="p">())</span>
            <span class="n">fjdip</span> <span class="o">=</span> <span class="p">[</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;CURRENT DIPOLE X&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">p4const</span><span class="o">.</span><span class="n">psi_dipmom_au2debye</span><span class="p">,</span>
                     <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;CURRENT DIPOLE Y&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">p4const</span><span class="o">.</span><span class="n">psi_dipmom_au2debye</span><span class="p">,</span>
                     <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;CURRENT DIPOLE Z&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">p4const</span><span class="o">.</span><span class="n">psi_dipmom_au2debye</span><span class="p">]</span>

        <span class="c1"># Transform results into C4 orientation (defined by c4mol) &amp; forge FJOBARC file</span>
        <span class="n">fjobarc</span> <span class="o">=</span> <span class="n">qcdb</span><span class="o">.</span><span class="n">cfour</span><span class="o">.</span><span class="n">format_fjobarc</span><span class="p">(</span><span class="n">fje</span><span class="p">,</span>
            <span class="o">*</span><span class="n">qcdb</span><span class="o">.</span><span class="n">cfour</span><span class="o">.</span><span class="n">backtransform</span><span class="p">(</span><span class="n">chgeMol</span><span class="o">=</span><span class="n">zmmol</span><span class="p">,</span> <span class="n">permMol</span><span class="o">=</span><span class="n">c4mol</span><span class="p">,</span> <span class="n">chgeGrad</span><span class="o">=</span><span class="n">fjgrd</span><span class="p">,</span> <span class="n">chgeDip</span><span class="o">=</span><span class="n">fjdip</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">fjobarc</span></div>


<div class="viewcode-block" id="vpt2_instructions"><a class="viewcode-back" href="../../autodoc_driver.html#procedures.wrappers_cfour.vpt2_instructions">[docs]</a><span class="k">def</span> <span class="nf">vpt2_instructions</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">zmats</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Stores all the instructions to the user for running</span>
<span class="sd">    :py:func:`~wrappers_cfour.vpt2` in sowreap mode. Depending on the</span>
<span class="sd">    *stage*, Pieces together instruction strings for the appropriate</span>
<span class="sd">    *stage* individualized by working directory *dir* and sown inputs</span>
<span class="sd">    *zmats* information.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stepFiles</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">zm12</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">zmats</span><span class="p">):</span>
        <span class="n">stepFiles</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;             psi4 </span><span class="si">%-27s</span><span class="s2"> </span><span class="si">%-27s</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;VPT2-&#39;</span> <span class="o">+</span> <span class="n">zm12</span> <span class="o">+</span> <span class="s1">&#39;.in&#39;</span><span class="p">,</span> <span class="s1">&#39;VPT2-&#39;</span> <span class="o">+</span> <span class="n">zm12</span> <span class="o">+</span> <span class="s1">&#39;.out&#39;</span><span class="p">)</span>

    <span class="n">step0</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    The vpt2 sow/reap procedure has been selected through mode=&#39;sowreap&#39;. This</span>
<span class="s2">    output file, the corresponding input file, and the data persistence file</span>
<span class="s2">    must not be edited by the user over the course of the sow/reap procedure.</span>
<span class="s2">    Throughout, psi4 can be invoked to move to the next stage of the procedure</span>
<span class="s2">    or to tally up the &#39;sown&#39; jobs. This output file is overwritten each time</span>
<span class="s2">    psi4 is invoked, but all results and instructions accumulate.</span>

<span class="s2">    This procedure involves two stages of distributed calculations, harmonic and</span>
<span class="s2">    anharmonic, and a mimimum of three invokations of psi4 on the original input</span>
<span class="s2">    file (including the one that initially generated this text). From the input</span>
<span class="s2">    geometry (0), displacements are generated for which gradients are required.</span>
<span class="s2">    Input files for these are &#39;sown&#39; in the current directory (1). Upon</span>
<span class="s2">    completion, their output files are &#39;reaped&#39; into a harmonic force field (2).</span>
<span class="s2">    At displacements along the normal coordinates, further displacements are</span>
<span class="s2">    generated for which gradients are required. Input files for these are again</span>
<span class="s2">    &#39;sown&#39; in the current directory (3). Upon completion, their output files are</span>
<span class="s2">    &#39;reaped&#39; into an anharmonic force field (4), terminating the vpt2 procedure.</span>
<span class="s2">    Follow the instructions below to continue.</span>

<span class="s2">    (0)  Read Only</span>
<span class="s2">    --------------</span>
<span class="s2">       </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">       </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">       </span><span class="si">%s</span><span class="s2"></span>

<span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">outfile_name</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.in&#39;</span><span class="p">,</span>
       <span class="nb">dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">psi4</span><span class="o">.</span><span class="n">outfile_name</span><span class="p">(),</span>
       <span class="nb">dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">outfile_name</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.shelf&#39;</span><span class="p">)</span>
    <span class="n">step1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    (1)  Sow</span>
<span class="s2">    --------</span>
<span class="s2">       Run all of the VPT2-000-*.in input files on any variety of computer</span>
<span class="s2">       architecture. The output file names must be as given below (default).</span>

<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">step2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    (2)  Reap</span>
<span class="s2">    ---------</span>
<span class="s2">       Gather all the resulting output files in this directory along with the</span>
<span class="s2">       three read-only files from (0). Invoke psi4 again. The job will be</span>
<span class="s2">       trivial in length (unless sto-3g integrals on the molecule are costly)</span>
<span class="s2">       and give results for the harmonic frequency stage in this output file. It</span>
<span class="s2">       will also supply the next set of instructions.</span>

<span class="s2">             psi4 </span><span class="si">%-27s</span><span class="s2"> </span><span class="si">%-27s</span><span class="s2"></span>

<span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">outfile_name</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.in&#39;</span><span class="p">,</span> <span class="n">psi4</span><span class="o">.</span><span class="n">outfile_name</span><span class="p">())</span>
    <span class="n">step3</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    (3)  Sow</span>
<span class="s2">    --------</span>
<span class="s2">       Run all of the VPT2-*-*.in input files on any variety of computer</span>
<span class="s2">       architecture. The output file names must be as given below (default).</span>

<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">step4</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    (4)  Reap</span>
<span class="s2">    ---------</span>
<span class="s2">       Gather all the resulting output files in this directory along with the</span>
<span class="s2">       three read-only files from (0). Invoke psi4 again. The job will be</span>
<span class="s2">       trivial in length (unless sto-3g integrals on the molecule are costly)</span>
<span class="s2">       and give results for the harmonic and anharmonic frequency stages in this</span>
<span class="s2">       output file.</span>

<span class="s2">             psi4 </span><span class="si">%-27s</span><span class="s2"> </span><span class="si">%-27s</span><span class="s2"></span>

<span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">outfile_name</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.in&#39;</span><span class="p">,</span> <span class="n">psi4</span><span class="o">.</span><span class="n">outfile_name</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">stage</span> <span class="o">==</span> <span class="s1">&#39;harmonic&#39;</span><span class="p">:</span>
        <span class="n">instructions</span> <span class="o">=</span> <span class="n">step0</span> <span class="o">+</span> <span class="n">step1</span> <span class="o">+</span> <span class="n">stepFiles</span> <span class="o">+</span> <span class="n">step2</span>
    <span class="k">elif</span> <span class="n">stage</span> <span class="o">==</span> <span class="s1">&#39;anharmonic&#39;</span><span class="p">:</span>
        <span class="n">instructions</span> <span class="o">=</span> <span class="n">step0</span> <span class="o">+</span> <span class="n">step3</span> <span class="o">+</span> <span class="n">stepFiles</span> <span class="o">+</span> <span class="n">step4</span>

    <span class="k">return</span> <span class="n">instructions</span></div>


<div class="viewcode-block" id="sown_jobs_status"><a class="viewcode-back" href="../../autodoc_driver.html#procedures.wrappers_cfour.sown_jobs_status">[docs]</a><span class="k">def</span> <span class="nf">sown_jobs_status</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">zmats</span><span class="p">,</span> <span class="n">validate_func</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">linkage</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Evaluate the output file status of jobs in *zmats* which should</span>
<span class="sd">    exist at *dir* + &#39;/&#39; + prefix + &#39;-&#39; + job + &#39;.out&#39;. Returns string with</span>
<span class="sd">    formatted summary of job status and boolean of whether all complete.</span>
<span class="sd">    Return boolean *isOk* signals whether all *zmats* have completed and,</span>
<span class="sd">    if *validate_func* present, are validated.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">isOk</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">msgError</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">instructions</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">instructions</span> <span class="o">+=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39; Status: &#39;</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">),</span> <span class="n">strNotOutfile</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">instructions</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">zmats</span><span class="p">):</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="nb">dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">job</span> <span class="o">+</span> <span class="s1">&#39;.out&#39;</span>
        <span class="n">fjafile</span> <span class="o">=</span> <span class="nb">dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">job</span> <span class="o">+</span> <span class="s1">&#39;.fja&#39;</span>
        <span class="n">formatArgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">job</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">outfile</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">handle</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Buy a developer a beer!&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">formatArgs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Completed&#39;</span>
                        <span class="k">if</span> <span class="n">reap_job_validate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">isOkJob</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">reap_job_validate</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">linkage</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">isOkJob</span><span class="p">:</span>
                                <span class="n">formatArgs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&amp; Validated&#39;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">isOk</span> <span class="o">=</span> <span class="bp">False</span>
                                <span class="n">msgError</span> <span class="o">+=</span> <span class="n">msg</span>
                                <span class="n">formatArgs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;INVALID&#39;</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">isOk</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="n">formatArgs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Running&#39;</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fjafile</span><span class="p">):</span>
            <span class="n">formatArgs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Completed&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">isOk</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">formatArgs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Waiting&#39;</span>
        <span class="n">instructions</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;             {0:&lt;27} {1:^10} {2:^10} {3:^10} {4:^10}</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">formatArgs</span><span class="p">)</span>
    <span class="n">instructions</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">msgError</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>

    <span class="k">return</span> <span class="n">isOk</span><span class="p">,</span> <span class="n">instructions</span></div>


<div class="viewcode-block" id="reap_job_validate"><a class="viewcode-back" href="../../autodoc_driver.html#procedures.wrappers_cfour.reap_job_validate">[docs]</a><span class="k">def</span> <span class="nf">reap_job_validate</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">linkage</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;For a given output file whose path is constructed with</span>
<span class="sd">    *dir* + &#39;/&#39; + *prefix* + &#39;-&#39; + *item* + &#39;.out&#39;, tests that the file</span>
<span class="sd">    exists and has *prefix* RESULTS lines for each piece of information</span>
<span class="sd">    requested in list *keys* and that those lines correspond to the</span>
<span class="sd">    appropriate *linkage* and *item*. Returns *keys* along with their</span>
<span class="sd">    scanned values in dict *reapings*, along with error and success</span>
<span class="sd">    messages in *instructions* and a boolean *isOk* indicating whether</span>
<span class="sd">    all *keys* reaped sucessfully.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">isOk</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">instructions</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">reapings</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">outfile</span> <span class="o">=</span> <span class="nb">dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">item</span> <span class="o">+</span> <span class="s1">&#39;.out&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">handle</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39; RESULT:&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sline</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">sline</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;linkage&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">linkage</span><span class="p">),</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span> <span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="n">item</span><span class="p">]:</span>
                        <span class="n">yieldsAt</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;yields&#39;</span><span class="p">)</span>
                        <span class="n">beingAt</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;being&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">beingAt</span> <span class="o">&gt;</span> <span class="n">yieldsAt</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">key</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">yieldsAt</span> <span class="o">+</span> <span class="mi">6</span><span class="p">:</span><span class="n">beingAt</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">beingAt</span> <span class="o">+</span> <span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                                <span class="n">reapings</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                                <span class="c1">#psi4.print_out(&#39;  CFOUR scratch file %s for %s has been read\n&#39; % (&#39;JOBARC&#39;, zm12))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">isOk</span> <span class="o">=</span> <span class="bp">False</span>
                            <span class="n">instructions</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;Outfile file </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">    has corrupted sowreap result line:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">isOk</span> <span class="o">=</span> <span class="bp">False</span>
                        <span class="n">instructions</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;Outfile file </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">    has sowreap result of either incompatible linkage (observed: </span><span class="si">%s</span><span class="s2">, expected: </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">    or incompatible job affiliation (observed: </span><span class="si">%s</span><span class="s2">, expected: </span><span class="si">%s</span><span class="s2">).</span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> \
                            <span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">sline</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">linkage</span><span class="p">,</span> <span class="n">sline</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">item</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reapings</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
                    <span class="n">isOk</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="n">instructions</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;Output file </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">    has missing results (observed: </span><span class="si">%s</span><span class="s2">, expected: </span><span class="si">%s</span><span class="s2">).</span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">reapings</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">keys</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">isOk</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">instructions</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;Output file </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">    that was judged present and complete at the beginning of this</span>
<span class="s2">    job is now missing. Replace it and invoke psi4 again.</span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">outfile</span><span class="p">)</span>

    <span class="c1"># return file contents in instructions</span>
    <span class="k">return</span> <span class="n">isOk</span><span class="p">,</span> <span class="n">instructions</span><span class="p">,</span> <span class="n">reapings</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="../../contents.html" title="Table Of Contents"
             >toc</a> &nbsp; &nbsp;</li>
    <li><a href="../../index.html">Psi4 [1.0.0 6a9a71b]</a> &raquo; </li>

          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2016, The Psi4 Project.
      Last updated on Tuesday, 05 July 2016 02:54AM.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.5.
    </div>
    <!-- cloud_sptheme 1.3 -->
  </body>
</html>