


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>proc &mdash; PSI4 [beta5] documentation</title>
    
    <link rel="stylesheet" href="../_static/psi4.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     'beta5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="../_static/toggle_sections.js"></script>
    <script type="text/javascript" src="../_static/toggle_sidebar.js"></script>
    <script type="text/javascript" src="../_static/toggle_codeprompt.js"></script>
    <link rel="top" title="PSI4 [beta5] documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="relbar-top">
        
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="../contents.html" title="Table Of Contents"
             accesskey="C">toc</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">PSI4 [beta5]</a> &raquo; </li>

          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for proc</h1><div class="highlight"><pre>
<span class="c">#</span>
<span class="c">#@BEGIN LICENSE</span>
<span class="c">#</span>
<span class="c"># PSI4: an ab initio quantum chemistry software package</span>
<span class="c">#</span>
<span class="c"># This program is free software; you can redistribute it and/or modify</span>
<span class="c"># it under the terms of the GNU General Public License as published by</span>
<span class="c"># the Free Software Foundation; either version 2 of the License, or</span>
<span class="c"># (at your option) any later version.</span>
<span class="c">#</span>
<span class="c"># This program is distributed in the hope that it will be useful,</span>
<span class="c"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c"># GNU General Public License for more details.</span>
<span class="c">#</span>
<span class="c"># You should have received a copy of the GNU General Public License along</span>
<span class="c"># with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="c"># 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="c">#</span>
<span class="c">#@END LICENSE</span>
<span class="c">#</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="sd">&quot;&quot;&quot;Module with functions that encode the sequence of PSI module</span>
<span class="sd">calls for each of the *name* values of the energy(), optimize(),</span>
<span class="sd">response(), and frequency() function.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">psi4</span>
<span class="kn">import</span> <span class="nn">p4const</span>
<span class="kn">import</span> <span class="nn">p4util</span>
<span class="kn">from</span> <span class="nn">p4regex</span> <span class="kn">import</span> <span class="o">*</span>
<span class="c">#from extend_Molecule import *</span>
<span class="kn">from</span> <span class="nn">molutil</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">functional</span> <span class="kn">import</span> <span class="o">*</span>
<span class="c"># never import driver, wrappers, or aliases into this file</span>

<span class="c"># ATTN NEW ADDITIONS!</span>
<span class="c"># consult http://sirius.chem.vt.edu/psi4manual/master/proc_py.html</span>

<div class="viewcode-block" id="run_dcft"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_dcft">[docs]</a><span class="k">def</span> <span class="nf">run_dcft</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a density cumulant functional theory calculation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;DCFT&#39;</span><span class="p">,</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">])</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">,</span> <span class="s">&#39;UHF&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;DCFT&#39;</span><span class="p">,</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">,</span> <span class="s">&#39;UHF&#39;</span><span class="p">)</span>

    <span class="c"># Bypass routine scf if user did something special to get it to converge</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="s">&#39;bypass_scf&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">yes</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;bypass_scf&#39;</span><span class="p">]))):</span>
        <span class="n">scf_helper</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">dcft</span><span class="p">()</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_dcft_gradient"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_dcft_gradient">[docs]</a><span class="k">def</span> <span class="nf">run_dcft_gradient</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    DCFT gradient calculation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;GLOBALS&#39;</span><span class="p">,</span> <span class="s">&#39;DERTYPE&#39;</span><span class="p">])</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DERTYPE&#39;</span><span class="p">,</span> <span class="s">&#39;FIRST&#39;</span><span class="p">)</span>
    <span class="n">run_dcft</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">deriv</span><span class="p">()</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_omp2"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_omp2">[docs]</a><span class="k">def</span> <span class="nf">run_omp2</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    an orbital-optimized MP2 computation</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Bypass routine scf if user did something special to get it to converge</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="s">&#39;bypass_scf&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">yes</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;bypass_scf&#39;</span><span class="p">]))):</span>
        <span class="n">scf_helper</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">psi4</span><span class="o">.</span><span class="n">occ</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_omp2_gradient"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_omp2_gradient">[docs]</a><span class="k">def</span> <span class="nf">run_omp2_gradient</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    OMP2 gradient calculation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;REFERENCE&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;GLOBALS&#39;</span><span class="p">,</span> <span class="s">&#39;DERTYPE&#39;</span><span class="p">])</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DERTYPE&#39;</span><span class="p">,</span> <span class="s">&#39;FIRST&#39;</span><span class="p">)</span>
    <span class="n">run_omp2</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">deriv</span><span class="p">()</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_mp2"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_mp2">[docs]</a><span class="k">def</span> <span class="nf">run_mp2</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a MP2 calculation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;ORB_OPT&#39;</span><span class="p">])</span>

    <span class="c"># If the scf type is DF/CD, then the AO integrals were never written to disk</span>
    <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;DF&#39;</span> <span class="ow">or</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;CD&#39;</span><span class="p">:</span>
            <span class="n">mints</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">MintsHelper</span><span class="p">()</span>
            <span class="n">mints</span><span class="o">.</span><span class="n">integrals</span><span class="p">()</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;ORB_OPT&#39;</span><span class="p">,</span> <span class="s">&#39;FALSE&#39;</span><span class="p">)</span>
    <span class="n">run_omp2</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_oldmp2"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_oldmp2">[docs]</a><span class="k">def</span> <span class="nf">run_oldmp2</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a MP2 calculation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;CCSORT&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;MP2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">])</span>

    <span class="c"># Bypass routine scf if user did something special to get it to converge</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="s">&#39;bypass_scf&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">yes</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;bypass_scf&#39;</span><span class="p">]))):</span>
        <span class="n">scf_helper</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c"># If the scf type is DF/CD, then the AO integrals were never written to disk</span>
        <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;DF&#39;</span> <span class="ow">or</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;CD&#39;</span><span class="p">:</span>
            <span class="n">mints</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">MintsHelper</span><span class="p">()</span>
            <span class="n">mints</span><span class="o">.</span><span class="n">integrals</span><span class="p">()</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;MP2&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCSORT&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;MP2&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;MP2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;MP2&#39;</span><span class="p">)</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">transqt2</span><span class="p">()</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">ccsort</span><span class="p">()</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">mp2</span><span class="p">()</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_mp2_gradient"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_mp2_gradient">[docs]</a><span class="k">def</span> <span class="nf">run_mp2_gradient</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a MP2 gradient calculation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;REFERENCE&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;GLOBALS&#39;</span><span class="p">,</span> <span class="s">&#39;DERTYPE&#39;</span><span class="p">])</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DERTYPE&#39;</span><span class="p">,</span> <span class="s">&#39;FIRST&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;ORB_OPT&#39;</span><span class="p">,</span> <span class="s">&#39;FALSE&#39;</span><span class="p">)</span>
    <span class="n">run_omp2</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">deriv</span><span class="p">()</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_scs_omp2"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_scs_omp2">[docs]</a><span class="k">def</span> <span class="nf">run_scs_omp2</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a spin-component scaled OMP2 computation</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;SCS_TYPE&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;DO_SCS&#39;</span><span class="p">])</span>

    <span class="c"># what type of scs?</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;scs-omp2&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;SCS_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;SCS&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;scsn-omp2&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;SCS_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;SCSN&#39;</span><span class="p">)</span>
    <span class="c">#elif (lowername == &#39;scs-mi-omp2&#39;):</span>
    <span class="c">#    psi4.set_local_option(&#39;OCC&#39;, &#39;SCS_TYPE&#39;, &#39;SCSMI&#39;)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;scs-omp2-vdw&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;SCS_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;SCSVDW&#39;</span><span class="p">)</span>

    <span class="c"># Bypass routine scf if user did something special to get it to converge</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="s">&#39;bypass_scf&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">yes</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;bypass_scf&#39;</span><span class="p">]))):</span>
        <span class="n">scf_helper</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;DO_SCS&#39;</span><span class="p">,</span> <span class="s">&#39;TRUE&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">occ</span><span class="p">()</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_sos_omp2"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_sos_omp2">[docs]</a><span class="k">def</span> <span class="nf">run_sos_omp2</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a spin-opposite scaled OMP2 computation</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;SOS_TYPE&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;DO_SOS&#39;</span><span class="p">])</span>

    <span class="c"># what type of sos?</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;sos-omp2&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;SOS_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;SOS&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;sos-pi-omp2&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;SOS_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;SOSPI&#39;</span><span class="p">)</span>

    <span class="c"># Bypass routine scf if user did something special to get it to converge</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="s">&#39;bypass_scf&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">yes</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;bypass_scf&#39;</span><span class="p">]))):</span>
        <span class="n">scf_helper</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;DO_SOS&#39;</span><span class="p">,</span> <span class="s">&#39;TRUE&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">occ</span><span class="p">()</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_omp3"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_omp3">[docs]</a><span class="k">def</span> <span class="nf">run_omp3</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    an orbital-optimized MP3 computation</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;WFN_TYPE&#39;</span><span class="p">])</span>

    <span class="c"># Bypass routine scf if user did something special to get it to converge</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="s">&#39;bypass_scf&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">yes</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;bypass_scf&#39;</span><span class="p">]))):</span>
        <span class="n">scf_helper</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;WFN_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;OMP3&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">occ</span><span class="p">()</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_omp3_gradient"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_omp3_gradient">[docs]</a><span class="k">def</span> <span class="nf">run_omp3_gradient</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    OMP3 gradient calculation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;WFN_TYPE&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;GLOBALS&#39;</span><span class="p">,</span> <span class="s">&#39;DERTYPE&#39;</span><span class="p">])</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DERTYPE&#39;</span><span class="p">,</span> <span class="s">&#39;FIRST&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;WFN_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;OMP3&#39;</span><span class="p">)</span>
    <span class="n">run_omp3</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">deriv</span><span class="p">()</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_mp3"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_mp3">[docs]</a><span class="k">def</span> <span class="nf">run_mp3</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a MP3 calculation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;ORB_OPT&#39;</span><span class="p">])</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;ORB_OPT&#39;</span><span class="p">,</span> <span class="s">&#39;FALSE&#39;</span><span class="p">)</span>
    <span class="n">run_omp3</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_mp3_gradient"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_mp3_gradient">[docs]</a><span class="k">def</span> <span class="nf">run_mp3_gradient</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a MP3 gradient calculation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;GLOBALS&#39;</span><span class="p">,</span> <span class="s">&#39;DERTYPE&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;WFN_TYPE&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;ORB_OPT&#39;</span><span class="p">])</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DERTYPE&#39;</span><span class="p">,</span> <span class="s">&#39;FIRST&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;WFN_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;OMP3&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;ORB_OPT&#39;</span><span class="p">,</span> <span class="s">&#39;FALSE&#39;</span><span class="p">)</span>
    <span class="n">run_omp3</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">deriv</span><span class="p">()</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_scs_omp3"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_scs_omp3">[docs]</a><span class="k">def</span> <span class="nf">run_scs_omp3</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a spin-component scaled OMP3 computation</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;SCS_TYPE&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;DO_SCS&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;WFN_TYPE&#39;</span><span class="p">])</span>

    <span class="c"># what type of scs?</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;scs-omp3&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;SCS_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;SCS&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;scsn-omp3&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;SCS_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;SCSN&#39;</span><span class="p">)</span>
    <span class="c">#elif (lowername == &#39;scs-mi-omp3&#39;):</span>
    <span class="c">#    psi4.set_local_option(&#39;OCC&#39;, &#39;SCS_TYPE&#39;, &#39;SCSMI&#39;)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;scs-omp3-vdw&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;SCS_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;SCSVDW&#39;</span><span class="p">)</span>

    <span class="c"># Bypass routine scf if user did something special to get it to converge</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="s">&#39;bypass_scf&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">yes</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;bypass_scf&#39;</span><span class="p">]))):</span>
        <span class="n">scf_helper</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;DO_SCS&#39;</span><span class="p">,</span> <span class="s">&#39;TRUE&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;WFN_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;OMP3&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">occ</span><span class="p">()</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_sos_omp3"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_sos_omp3">[docs]</a><span class="k">def</span> <span class="nf">run_sos_omp3</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a spin-opposite scaled OMP3 computation</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;SOS_TYPE&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;DO_SOS&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;WFN_TYPE&#39;</span><span class="p">])</span>

    <span class="c"># what type of sos?</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;sos-omp3&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;SOS_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;SOS&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;sos-pi-omp3&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;SOS_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;SOSPI&#39;</span><span class="p">)</span>

    <span class="c"># Bypass routine scf if user did something special to get it to converge</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="s">&#39;bypass_scf&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">yes</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;bypass_scf&#39;</span><span class="p">]))):</span>
        <span class="n">scf_helper</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;DO_SOS&#39;</span><span class="p">,</span> <span class="s">&#39;TRUE&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;WFN_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;OMP3&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">occ</span><span class="p">()</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_ocepa"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_ocepa">[docs]</a><span class="k">def</span> <span class="nf">run_ocepa</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    an orbital-optimized CEPA computation</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;WFN_TYPE&#39;</span><span class="p">])</span>

    <span class="c"># Bypass routine scf if user did something special to get it to converge</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="s">&#39;bypass_scf&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">yes</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;bypass_scf&#39;</span><span class="p">]))):</span>
        <span class="n">scf_helper</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;WFN_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;OCEPA&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">occ</span><span class="p">()</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_ocepa_gradient"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_ocepa_gradient">[docs]</a><span class="k">def</span> <span class="nf">run_ocepa_gradient</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    OCEPA gradient calculation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;GLOBALS&#39;</span><span class="p">,</span> <span class="s">&#39;DERTYPE&#39;</span><span class="p">])</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DERTYPE&#39;</span><span class="p">,</span> <span class="s">&#39;FIRST&#39;</span><span class="p">)</span>
    <span class="n">run_ocepa</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">deriv</span><span class="p">()</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_cepa0"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_cepa0">[docs]</a><span class="k">def</span> <span class="nf">run_cepa0</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a CEPA (LCCD) computation</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;WFN_TYPE&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;ORB_OPT&#39;</span><span class="p">])</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;WFN_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;OCEPA&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;ORB_OPT&#39;</span><span class="p">,</span> <span class="s">&#39;FALSE&#39;</span><span class="p">)</span>
    <span class="n">run_ocepa</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_cepa0_gradient"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_cepa0_gradient">[docs]</a><span class="k">def</span> <span class="nf">run_cepa0_gradient</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a CEPA(0) gradient calculation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;GLOBALS&#39;</span><span class="p">,</span> <span class="s">&#39;DERTYPE&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;WFN_TYPE&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;ORB_OPT&#39;</span><span class="p">])</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DERTYPE&#39;</span><span class="p">,</span> <span class="s">&#39;FIRST&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;WFN_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;OCEPA&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;ORB_OPT&#39;</span><span class="p">,</span> <span class="s">&#39;FALSE&#39;</span><span class="p">)</span>
    <span class="n">run_ocepa</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">deriv</span><span class="p">()</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_omp2_5"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_omp2_5">[docs]</a><span class="k">def</span> <span class="nf">run_omp2_5</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    an orbital-optimized MP2.5 computation</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;WFN_TYPE&#39;</span><span class="p">])</span>

    <span class="c"># Bypass routine scf if user did something special to get it to converge</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="s">&#39;bypass_scf&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">yes</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;bypass_scf&#39;</span><span class="p">]))):</span>
        <span class="n">scf_helper</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;WFN_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;OMP2.5&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">occ</span><span class="p">()</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_omp2_5_gradient"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_omp2_5_gradient">[docs]</a><span class="k">def</span> <span class="nf">run_omp2_5_gradient</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    OMP2.5 gradient calculation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;GLOBALS&#39;</span><span class="p">,</span> <span class="s">&#39;DERTYPE&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;WFN_TYPE&#39;</span><span class="p">])</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DERTYPE&#39;</span><span class="p">,</span> <span class="s">&#39;FIRST&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;WFN_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;OMP2.5&#39;</span><span class="p">)</span>
    <span class="n">run_omp2_5</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">deriv</span><span class="p">()</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_mp2_5"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_mp2_5">[docs]</a><span class="k">def</span> <span class="nf">run_mp2_5</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a MP2.5 calculation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;ORB_OPT&#39;</span><span class="p">])</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;ORB_OPT&#39;</span><span class="p">,</span> <span class="s">&#39;FALSE&#39;</span><span class="p">)</span>
    <span class="n">run_omp2_5</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_mp2_5_gradient"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_mp2_5_gradient">[docs]</a><span class="k">def</span> <span class="nf">run_mp2_5_gradient</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a MP3 gradient calculation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;GLOBALS&#39;</span><span class="p">,</span> <span class="s">&#39;DERTYPE&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;WFN_TYPE&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;ORB_OPT&#39;</span><span class="p">])</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DERTYPE&#39;</span><span class="p">,</span> <span class="s">&#39;FIRST&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;WFN_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;OMP2.5&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;OCC&#39;</span><span class="p">,</span> <span class="s">&#39;ORB_OPT&#39;</span><span class="p">,</span> <span class="s">&#39;FALSE&#39;</span><span class="p">)</span>
    <span class="n">run_omp2_5</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">deriv</span><span class="p">()</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_scf"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_scf">[docs]</a><span class="k">def</span> <span class="nf">run_scf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a self-consistent-field theory (HF &amp; DFT) calculation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;DFT_FUNCTIONAL&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">])</span>

    <span class="c"># Alter default algorithm</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">psi4</span><span class="o">.</span><span class="n">has_option_changed</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;DF&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;hf&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;RKS&#39;</span><span class="p">:</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">,</span> <span class="s">&#39;RHF&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;UKS&#39;</span><span class="p">:</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">,</span> <span class="s">&#39;UHF&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;rhf&#39;</span><span class="p">:</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">,</span> <span class="s">&#39;RHF&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;uhf&#39;</span><span class="p">:</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">,</span> <span class="s">&#39;UHF&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;rohf&#39;</span><span class="p">:</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">,</span> <span class="s">&#39;ROHF&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;rscf&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;DFT_FUNCTIONAL&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;DFT_CUSTOM_FUNCTIONAL&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">,</span> <span class="s">&#39;RKS&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">,</span> <span class="s">&#39;RHF&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;uscf&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;DFT_FUNCTIONAL&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;DFT_CUSTOM_FUNCTIONAL&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">,</span> <span class="s">&#39;UKS&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">,</span> <span class="s">&#39;UHF&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;roscf&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;DFT_FUNCTIONAL&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;DFT_CUSTOM_FUNCTIONAL&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;ROHF reference for DFT is not available.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">,</span> <span class="s">&#39;ROHF&#39;</span><span class="p">)</span>

    <span class="n">scf_helper</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_scf_gradient"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_scf_gradient">[docs]</a><span class="k">def</span> <span class="nf">run_scf_gradient</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a SCF gradient calculation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;DF_BASIS_SCF&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">])</span>

    <span class="c"># Alter default algorithm</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">psi4</span><span class="o">.</span><span class="n">has_option_changed</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;DF&#39;</span><span class="p">)</span>

    <span class="n">run_scf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;DF&#39;</span><span class="p">):</span>

        <span class="c"># if the df_basis_scf basis is not set, pick a sensible one.</span>
        <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&#39;DF_BASIS_SCF&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="n">jkbasis</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">corresponding_jkfit</span><span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&#39;BASIS&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">jkbasis</span><span class="p">:</span>
                <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_BASIS_SCF&#39;</span><span class="p">,</span> <span class="n">jkbasis</span><span class="p">)</span>
                <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">  No DF_BASIS_SCF auxiliary basis selected, defaulting to </span><span class="si">%s</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jkbasis</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Keyword DF_BASIS_SCF is required.&#39;</span><span class="p">)</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">scfgrad</span><span class="p">()</span>
    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_libfock"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_libfock">[docs]</a><span class="k">def</span> <span class="nf">run_libfock</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a calculation through libfock, namely RCPHF,</span>
<span class="sd">    RCIS, RTDHF, RTDA, and RTDDFT.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;cphf&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;MODULE&#39;</span><span class="p">,</span> <span class="s">&#39;RCPHF&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;cis&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;MODULE&#39;</span><span class="p">,</span> <span class="s">&#39;RCIS&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;tdhf&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;MODULE&#39;</span><span class="p">,</span> <span class="s">&#39;RTDHF&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;cpks&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;MODULE&#39;</span><span class="p">,</span> <span class="s">&#39;RCPKS&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;tda&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;MODULE&#39;</span><span class="p">,</span> <span class="s">&#39;RTDA&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;tddft&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;MODULE&#39;</span><span class="p">,</span> <span class="s">&#39;RTDDFT&#39;</span><span class="p">)</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">libfock</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_mcscf"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_mcscf">[docs]</a><span class="k">def</span> <span class="nf">run_mcscf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a multiconfigurational self-consistent-field calculation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">psi4</span><span class="o">.</span><span class="n">mcscf</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="scf_helper"><a class="viewcode-back" href="../autodoc_driver.html#proc.scf_helper">[docs]</a><span class="k">def</span> <span class="nf">scf_helper</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function serving as helper to SCF, choosing whether to cast</span>
<span class="sd">    up or just run SCF with a standard guess. This preserves</span>
<span class="sd">    previous SCF options set by other procedures (e.g., SAPT</span>
<span class="sd">    output file types for SCF).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;PUREAM&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;BASIS&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;DF_BASIS_SCF&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;GUESS&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;DF_INTS_IO&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">]</span> <span class="c"># Hack: scope gets changed internally with the Andy trick</span>
    <span class="p">)</span>

    <span class="c"># if the df_basis_scf basis is not set, pick a sensible one.</span>
    <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;DF&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&#39;DF_BASIS_SCF&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="n">jkbasis</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">corresponding_jkfit</span><span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&#39;BASIS&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">jkbasis</span><span class="p">:</span>
                <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_BASIS_SCF&#39;</span><span class="p">,</span> <span class="n">jkbasis</span><span class="p">)</span>
                <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">  No DF_BASIS_SCF auxiliary basis selected, defaulting to </span><span class="si">%s</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jkbasis</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Keyword DF_BASIS_SCF is required.&#39;</span><span class="p">)</span>

    <span class="n">optstash2</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;BASIS&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;DF_BASIS_SCF&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;DF_INTS_IO&#39;</span><span class="p">])</span>

    <span class="c"># sort out cast_up settings. no need to stash these since only read, never reset</span>
    <span class="n">cast</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">has_option_changed</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;BASIS_GUESS&#39;</span><span class="p">):</span>
        <span class="n">cast</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;BASIS_GUESS&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">yes</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cast</span><span class="p">)):</span>
            <span class="n">cast</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">no</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cast</span><span class="p">)):</span>
            <span class="n">cast</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;DF&#39;</span><span class="p">:</span>
            <span class="n">castdf</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">castdf</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">has_option_changed</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;DF_BASIS_GUESS&#39;</span><span class="p">):</span>
            <span class="n">castdf</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;DF_BASIS_GUESS&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">yes</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">castdf</span><span class="p">)):</span>
                <span class="n">castdf</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">no</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">castdf</span><span class="p">)):</span>
                <span class="n">castdf</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c"># sort out broken_symmetry settings.</span>
    <span class="k">if</span> <span class="s">&#39;brokensymmetry&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">molecule</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">()</span>
        <span class="n">multp</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">multp</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Broken symmetry is only for singlets.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span><span class="s">&#39;REFERENCE&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#39;UHF&#39;</span> <span class="ow">and</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span><span class="s">&#39;REFERENCE&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#39;UKS&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;You must specify &quot;set reference uhf&quot; to use broken symmetry.&#39;</span><span class="p">)</span>
        <span class="n">do_broken</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">do_broken</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">precallback</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="s">&#39;precallback&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">precallback</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;precallback&#39;</span><span class="p">)</span>

    <span class="n">postcallback</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="s">&#39;postcallback&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">postcallback</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;postcallback&#39;</span><span class="p">)</span>

    <span class="c"># Hack to ensure cartesian or pure are used throughout</span>
    <span class="c"># Note that can&#39;t query PUREAM option directly, as it only</span>
    <span class="c">#   reflects user changes to value, so load basis and</span>
    <span class="c">#   read effective PUREAM setting off of it</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;BASIS&#39;</span><span class="p">,</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&#39;BASIS&#39;</span><span class="p">))</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;PUREAM&#39;</span><span class="p">,</span> <span class="n">psi4</span><span class="o">.</span><span class="n">MintsHelper</span><span class="p">()</span><span class="o">.</span><span class="n">basisset</span><span class="p">()</span><span class="o">.</span><span class="n">has_puream</span><span class="p">())</span>

    <span class="c"># broken set-up</span>
    <span class="k">if</span> <span class="n">do_broken</span><span class="p">:</span>
        <span class="n">molecule</span><span class="o">.</span><span class="n">set_multiplicity</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s">&#39;  Computing high-spin triplet guess  &#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="c"># cast set-up</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cast</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">yes</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cast</span><span class="p">)):</span>
            <span class="n">guessbasis</span> <span class="o">=</span> <span class="s">&#39;3-21G&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">guessbasis</span> <span class="o">=</span> <span class="n">cast</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">castdf</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">yes</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">castdf</span><span class="p">)):</span>
                <span class="n">guessbasisdf</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">corresponding_jkfit</span><span class="p">(</span><span class="n">guessbasis</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">guessbasisdf</span> <span class="o">=</span> <span class="n">castdf</span>

        <span class="c"># Switch to the guess namespace</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">get_default_namespace</span><span class="p">()</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">set_default_namespace</span><span class="p">((</span><span class="n">namespace</span> <span class="o">+</span> <span class="s">&#39;.guess&#39;</span><span class="p">))</span>

        <span class="c"># Setup initial SCF</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;BASIS&#39;</span><span class="p">,</span> <span class="n">guessbasis</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">castdf</span><span class="p">):</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;DF&#39;</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;DF_INTS_IO&#39;</span><span class="p">,</span> <span class="s">&#39;none&#39;</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_BASIS_SCF&#39;</span><span class="p">,</span> <span class="n">guessbasisdf</span><span class="p">)</span>

        <span class="c"># Print some info about the guess</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s">&#39;Guess SCF, </span><span class="si">%s</span><span class="s"> Basis&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">guessbasis</span><span class="p">))</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="c"># the FIRST scf call</span>
    <span class="k">if</span> <span class="n">cast</span> <span class="ow">or</span> <span class="n">do_broken</span><span class="p">:</span>
        <span class="c"># Perform the guess scf</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">scf</span><span class="p">()</span>

    <span class="c"># broken clean-up</span>
    <span class="k">if</span> <span class="n">do_broken</span><span class="p">:</span>
        <span class="n">molecule</span><span class="o">.</span><span class="n">set_multiplicity</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;GUESS&#39;</span><span class="p">,</span> <span class="s">&#39;READ&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s">&#39;  Computing broken symmetry solution from high-spin triplet guess  &#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="c"># cast clean-up</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cast</span><span class="p">):</span>

        <span class="c"># Move files to proper namespace</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">change_file_namespace</span><span class="p">(</span><span class="mi">180</span><span class="p">,</span> <span class="p">(</span><span class="n">namespace</span> <span class="o">+</span> <span class="s">&#39;.guess&#39;</span><span class="p">),</span> <span class="n">namespace</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">set_default_namespace</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>

        <span class="c"># Set to read and project, and reset bases to final ones</span>
        <span class="n">optstash2</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;GUESS&#39;</span><span class="p">,</span> <span class="s">&#39;READ&#39;</span><span class="p">)</span>

        <span class="c"># Print the banner for the standard operation</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>


    <span class="c"># the SECOND scf call</span>
    <span class="n">e_scf</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">scf</span><span class="p">(</span><span class="n">precallback</span><span class="p">,</span> <span class="n">postcallback</span><span class="p">)</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">e_scf</span>

</div>
<div class="viewcode-block" id="run_mp2_select"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_mp2_select">[docs]</a><span class="k">def</span> <span class="nf">run_mp2_select</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function selecting the algorithm for a MP2 energy call</span>
<span class="sd">    and directing toward the OCC (conv MP2) or the DFMP2 modules.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&quot;DFMP2&quot;</span><span class="p">,</span> <span class="s">&quot;MP2_TYPE&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;CONV&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&quot;OCC&quot;</span><span class="p">,</span> <span class="s">&quot;MP2_TYPE&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;CONV&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">run_mp2</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">run_dfmp2</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="run_mp2_select_gradient"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_mp2_select_gradient">[docs]</a><span class="k">def</span> <span class="nf">run_mp2_select_gradient</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function selecting the algorithm for a MP2 gradient call</span>
<span class="sd">    and directing toward the OCC (conv MP2) or the DFMP2 modules.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&quot;DFMP2&quot;</span><span class="p">,</span> <span class="s">&quot;MP2_TYPE&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;CONV&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&quot;OCC&quot;</span><span class="p">,</span> <span class="s">&quot;MP2_TYPE&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;CONV&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">run_mp2_gradient</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">run_dfmp2_gradient</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="run_dfmp2_gradient"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_dfmp2_gradient">[docs]</a><span class="k">def</span> <span class="nf">run_dfmp2_gradient</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a DFMP2 gradient calculation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;DF_BASIS_SCF&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;DF_BASIS_MP2&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;SCF_TYPE&#39;</span><span class="p">])</span>

    <span class="c"># Alter default algorithm</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">psi4</span><span class="o">.</span><span class="n">has_option_changed</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">):</span>
        <span class="c">#psi4.set_local_option(&#39;SCF&#39;, &#39;SCF_TYPE&#39;, &#39;DF&#39;)  # insufficient b/c SCF option read in DFMP2</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;SCF_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;DF&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;DF&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;DF-MP2 gradients need DF-SCF reference, for now.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s">&#39;restart_file&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">restartfile</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;restart_file&#39;</span><span class="p">)</span>
        <span class="c"># Rename the checkpoint file to be consistent with psi4&#39;s file system</span>
        <span class="n">psioh</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">IOManager</span><span class="o">.</span><span class="n">shared_object</span><span class="p">()</span>
        <span class="n">psio</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">shared_object</span><span class="p">()</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">psioh</span><span class="o">.</span><span class="n">get_file_path</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="n">psio</span><span class="o">.</span><span class="n">get_default_namespace</span><span class="p">()</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s">&#39;psi&#39;</span>
        <span class="n">targetfile</span> <span class="o">=</span> <span class="n">filepath</span> <span class="o">+</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">pid</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">namespace</span> <span class="o">+</span> <span class="s">&#39;.32&#39;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">me</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">restartfile</span><span class="p">,</span> <span class="n">targetfile</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># if the df_basis_scf basis is not set, pick a sensible one.</span>
        <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&#39;DF_BASIS_SCF&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="n">jkbasis</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">corresponding_jkfit</span><span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&#39;BASIS&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">jkbasis</span><span class="p">:</span>
                <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_BASIS_SCF&#39;</span><span class="p">,</span> <span class="n">jkbasis</span><span class="p">)</span>
                <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">  No DF_BASIS_SCF auxiliary basis selected, defaulting to </span><span class="si">%s</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jkbasis</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Keyword DF_BASIS_SCF is required.&#39;</span><span class="p">)</span>

        <span class="n">scf_helper</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s">&#39;DFMP2&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="c"># if the df_basis_mp2 basis is not set, pick a sensible one.</span>
    <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&#39;DF_BASIS_MP2&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="n">ribasis</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">corresponding_rifit</span><span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&#39;BASIS&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ribasis</span><span class="p">:</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_BASIS_MP2&#39;</span><span class="p">,</span> <span class="n">ribasis</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;  No DF_BASIS_MP2 auxiliary basis selected, defaulting to </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ribasis</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Keyword DF_BASIS_MP2 is required.&#39;</span><span class="p">)</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">dfmp2grad</span><span class="p">()</span>
    <span class="n">e_dfmp2</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&#39;MP2 TOTAL ENERGY&#39;</span><span class="p">)</span>
    <span class="n">e_scs_dfmp2</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&#39;SCS-MP2 TOTAL ENERGY&#39;</span><span class="p">)</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;SCS-MP2&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">e_scs_dfmp2</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;DF-MP2&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;DFMP2&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;MP2&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">e_dfmp2</span>

</div>
<div class="viewcode-block" id="run_ccenergy"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_ccenergy">[docs]</a><span class="k">def</span> <span class="nf">run_ccenergy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a CCSD, CC2, and CC3 calculation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;CCSORT&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;CCENERGY&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;ccsd&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;CCSD&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCSORT&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;CCSD&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCENERGY&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;CCSD&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;ccsd(t)&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;CCSD_T&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCSORT&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;CCSD_T&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCENERGY&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;CCSD_T&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;ccsd(at)&#39;</span> <span class="ow">or</span> <span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;a-ccsd(t)&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;CCSD_AT&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCSORT&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;CCSD_AT&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCENERGY&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;CCSD_AT&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCHBAR&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;CCSD_AT&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCLAMBDA&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;CCSD_AT&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;cc2&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;CC2&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCSORT&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;CC2&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCENERGY&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;CC2&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;cc3&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;CC3&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCSORT&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;CC3&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCENERGY&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;CC3&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;eom-cc2&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CC2&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCSORT&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CC2&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCENERGY&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CC2&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;eom-ccsd&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CCSD&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCSORT&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CCSD&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCENERGY&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CCSD&#39;</span><span class="p">)</span>
    <span class="c"># Call a plain energy(&#39;ccenergy&#39;) and have full control over options, incl. wfn</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;ccenergy&#39;</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="c"># Bypass routine scf if user did something special to get it to converge</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="s">&#39;bypass_scf&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">yes</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;bypass_scf&#39;</span><span class="p">]))):</span>
        <span class="n">scf_helper</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c"># If the scf type is DF/CD, then the AO integrals were never written to disk</span>
        <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;DF&#39;</span> <span class="ow">or</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;CD&#39;</span><span class="p">:</span>
            <span class="n">mints</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">MintsHelper</span><span class="p">()</span>
            <span class="n">mints</span><span class="o">.</span><span class="n">integrals</span><span class="p">()</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">transqt2</span><span class="p">()</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">ccsort</span><span class="p">()</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">ccenergy</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;ccsd(at)&#39;</span> <span class="ow">or</span> <span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;a-ccsd(t)&#39;</span><span class="p">):</span>
	<span class="n">psi4</span><span class="o">.</span><span class="n">cchbar</span><span class="p">()</span>
	<span class="n">psi4</span><span class="o">.</span><span class="n">cclambda</span><span class="p">()</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_cc_gradient"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_cc_gradient">[docs]</a><span class="k">def</span> <span class="nf">run_cc_gradient</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a CCSD and CCSD(T) gradient calculation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;GLOBALS&#39;</span><span class="p">,</span> <span class="s">&#39;DERTYPE&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;CCLAMBDA&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;CCDENSITY&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">])</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DERTYPE&#39;</span><span class="p">,</span> <span class="s">&#39;FIRST&#39;</span><span class="p">)</span>

    <span class="n">run_ccenergy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;ccsd&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCLAMBDA&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;CCSD&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCDENSITY&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;CCSD&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;ccsd(t)&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCLAMBDA&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;CCSD_T&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCDENSITY&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;CCSD_T&#39;</span><span class="p">)</span>

        <span class="n">user_ref</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;CCENERGY&#39;</span><span class="p">,</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">user_ref</span> <span class="o">!=</span> <span class="s">&#39;RHF&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">user_ref</span> <span class="o">!=</span> <span class="s">&#39;UHF&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Reference </span><span class="si">%s</span><span class="s"> for CCSD(T) gradients is not available.&#39;</span> <span class="o">%</span> <span class="n">user_ref</span><span class="p">)</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">cchbar</span><span class="p">()</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">cclambda</span><span class="p">()</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">ccdensity</span><span class="p">()</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">deriv</span><span class="p">()</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_bccd"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_bccd">[docs]</a><span class="k">def</span> <span class="nf">run_bccd</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a Brueckner CCD calculation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;DELETE_TEI&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;CCSORT&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;CCENERGY&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;bccd&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;BCCD&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCSORT&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;BCCD&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCENERGY&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;BCCD&#39;</span><span class="p">)</span>

    <span class="c"># Bypass routine scf if user did something special to get it to converge</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="s">&#39;bypass_scf&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">yes</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;bypass_scf&#39;</span><span class="p">]))):</span>
        <span class="n">scf_helper</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c"># If the scf type is DF/CD, then the AO integrals were never written to disk</span>
        <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;DF&#39;</span> <span class="ow">or</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;CD&#39;</span><span class="p">:</span>
            <span class="n">mints</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">MintsHelper</span><span class="p">()</span>
            <span class="n">mints</span><span class="o">.</span><span class="n">integrals</span><span class="p">()</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;DELETE_TEI&#39;</span><span class="p">,</span> <span class="s">&#39;false&#39;</span><span class="p">)</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">transqt2</span><span class="p">()</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">ccsort</span><span class="p">()</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">ccenergy</span><span class="p">()</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;Brueckner convergence check: </span><span class="si">%d</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&#39;BRUECKNER CONVERGED&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&#39;BRUECKNER CONVERGED&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">True</span><span class="p">):</span>
            <span class="k">break</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_bccd_t"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_bccd_t">[docs]</a><span class="k">def</span> <span class="nf">run_bccd_t</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a Brueckner CCD(T) calculation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;CCSORT&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;CCENERGY&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;CCTRIPLES&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">])</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;BCCD_T&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCSORT&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;BCCD_T&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCENERGY&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;BCCD_T&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCTRIPLES&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;BCCD_T&#39;</span><span class="p">)</span>
    <span class="n">run_bccd</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">cctriples</span><span class="p">()</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_scf_property"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_scf_property">[docs]</a><span class="k">def</span> <span class="nf">run_scf_property</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    SCF calculations. This is a simple alias to :py:func:`~proc.run_scf`</span>
<span class="sd">    since SCF properties all handled through oeprop.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">])</span>

    <span class="c"># Alter default algorithm</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">psi4</span><span class="o">.</span><span class="n">has_option_changed</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;DF&#39;</span><span class="p">)</span>

    <span class="n">run_scf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_cc_property"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_cc_property">[docs]</a><span class="k">def</span> <span class="nf">run_cc_property</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    all CC property calculations.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">oneel_properties</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;dipole&#39;</span><span class="p">,</span> <span class="s">&#39;quadrupole&#39;</span><span class="p">]</span>
    <span class="n">twoel_properties</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">response_properties</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;polarizability&#39;</span><span class="p">,</span> <span class="s">&#39;rotation&#39;</span><span class="p">,</span> <span class="s">&#39;roa&#39;</span><span class="p">]</span>
    <span class="n">excited_properties</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;oscillator_strength&#39;</span><span class="p">,</span> <span class="s">&#39;rotational_strength&#39;</span><span class="p">]</span>

    <span class="n">one</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">two</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">excited</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">invalid</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="s">&#39;properties&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;properties&#39;</span><span class="p">)</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">oneel_properties</span><span class="p">:</span>
                <span class="n">one</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">twoel_properties</span><span class="p">:</span>
                <span class="n">two</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">response_properties</span><span class="p">:</span>
                <span class="n">response</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">excited_properties</span><span class="p">:</span>
                <span class="n">excited</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">invalid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&quot;The </span><span class="se">\&quot;</span><span class="s">properties</span><span class="se">\&quot;</span><span class="s"> keyword is required with the property() function.&quot;</span><span class="p">)</span>

    <span class="n">n_one</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">one</span><span class="p">)</span>
    <span class="n">n_two</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">two</span><span class="p">)</span>
    <span class="n">n_response</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="n">n_excited</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">excited</span><span class="p">)</span>
    <span class="n">n_invalid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">invalid</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">n_invalid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;The following properties are not currently supported: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">invalid</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">n_excited</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&#39;eom-ccsd&#39;</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&#39;eom-cc2&#39;</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&quot;Excited state CC properties require EOM-CC2 or EOM-CCSD.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;eom-ccsd&#39;</span> <span class="ow">or</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;eom-cc2&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">n_response</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&quot;Cannot (yet) compute response properties for excited states.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">n_one</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">n_two</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">n_response</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Computing both density- and response-based properties.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;ccsd&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;CCSD&#39;</span><span class="p">)</span>
        <span class="n">run_ccenergy</span><span class="p">(</span><span class="s">&#39;ccsd&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;CCSD&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;cc2&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;CC2&#39;</span><span class="p">)</span>
        <span class="n">run_ccenergy</span><span class="p">(</span><span class="s">&#39;cc2&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;CC2&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;eom-ccsd&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CCSD&#39;</span><span class="p">)</span>
        <span class="n">run_ccenergy</span><span class="p">(</span><span class="s">&#39;eom-ccsd&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CCSD&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;eom-cc2&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CC2&#39;</span><span class="p">)</span>
        <span class="n">run_ccenergy</span><span class="p">(</span><span class="s">&#39;eom-cc2&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CC2&#39;</span><span class="p">)</span>

    <span class="c"># Need cchbar for everything</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">cchbar</span><span class="p">()</span>

    <span class="c"># Need ccdensity at this point only for density-based props</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n_one</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">n_two</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;eom-ccsd&#39;</span><span class="p">):</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CCSD&#39;</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DERTYPE&#39;</span><span class="p">,</span> <span class="s">&#39;NONE&#39;</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;ONEPDM&#39;</span><span class="p">,</span> <span class="s">&#39;TRUE&#39;</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">cceom</span><span class="p">()</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;eom-cc2&#39;</span><span class="p">):</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CC2&#39;</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DERTYPE&#39;</span><span class="p">,</span> <span class="s">&#39;NONE&#39;</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;ONEPDM&#39;</span><span class="p">,</span> <span class="s">&#39;TRUE&#39;</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">cceom</span><span class="p">()</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DERTYPE&#39;</span><span class="p">,</span> <span class="s">&#39;NONE&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;ONEPDM&#39;</span><span class="p">,</span> <span class="s">&#39;TRUE&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">cclambda</span><span class="p">()</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">ccdensity</span><span class="p">()</span>

    <span class="c"># Need ccresponse only for response-type props</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n_response</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DERTYPE&#39;</span><span class="p">,</span> <span class="s">&#39;RESPONSE&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">cclambda</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;PROPERTY&#39;</span><span class="p">,</span> <span class="n">prop</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">ccresponse</span><span class="p">()</span>

    <span class="c"># Excited-state transition properties</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n_excited</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;eom-ccsd&#39;</span><span class="p">):</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CCSD&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;eom-cc2&#39;</span><span class="p">):</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CC2&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&quot;Unknown excited-state CC wave function.&quot;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DERTYPE&#39;</span><span class="p">,</span> <span class="s">&#39;NONE&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;ONEPDM&#39;</span><span class="p">,</span> <span class="s">&#39;TRUE&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">cceom</span><span class="p">()</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">cclambda</span><span class="p">()</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">ccdensity</span><span class="p">()</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;SCF&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">revoke_global_option_changed</span><span class="p">(</span><span class="s">&#39;WFN&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DERTYPE&#39;</span><span class="p">,</span> <span class="s">&#39;NONE&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">revoke_global_option_changed</span><span class="p">(</span><span class="s">&#39;DERTYPE&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="run_dfmp2_property"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_dfmp2_property">[docs]</a><span class="k">def</span> <span class="nf">run_dfmp2_property</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a DFMP2 property calculation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;DF_BASIS_SCF&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;DF_BASIS_MP2&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;SCF_TYPE&#39;</span><span class="p">])</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;ONEPDM&#39;</span><span class="p">,</span> <span class="s">&#39;TRUE&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;OPDM_RELAX&#39;</span><span class="p">,</span> <span class="s">&#39;TRUE&#39;</span><span class="p">)</span>

    <span class="c"># Alter default algorithm</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">psi4</span><span class="o">.</span><span class="n">has_option_changed</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">):</span>
        <span class="c">#psi4.set_local_option(&#39;SCF&#39;, &#39;SCF_TYPE&#39;, &#39;DF&#39;)  # insufficient b/c SCF option read in DFMP2</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;SCF_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;DF&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;DF&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;DF-MP2 properties need DF-SCF reference, for now.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s">&#39;restart_file&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">restartfile</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;restart_file&#39;</span><span class="p">)</span>
        <span class="c"># Rename the checkpoint file to be consistent with psi4&#39;s file system</span>
        <span class="n">psioh</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">IOManager</span><span class="o">.</span><span class="n">shared_object</span><span class="p">()</span>
        <span class="n">psio</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">shared_object</span><span class="p">()</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">psioh</span><span class="o">.</span><span class="n">get_file_path</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="n">psio</span><span class="o">.</span><span class="n">get_default_namespace</span><span class="p">()</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s">&#39;psi&#39;</span>
        <span class="n">targetfile</span> <span class="o">=</span> <span class="n">filepath</span> <span class="o">+</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">pid</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">namespace</span> <span class="o">+</span> <span class="s">&#39;.32&#39;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">me</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">restartfile</span><span class="p">,</span> <span class="n">targetfile</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># if the df_basis_scf basis is not set, pick a sensible one.</span>
        <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&#39;DF_BASIS_SCF&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="n">jkbasis</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">corresponding_jkfit</span><span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&#39;BASIS&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">jkbasis</span><span class="p">:</span>
                <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_BASIS_SCF&#39;</span><span class="p">,</span> <span class="n">jkbasis</span><span class="p">)</span>
                <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">No DF_BASIS_SCF auxiliary basis selected, defaulting to </span><span class="si">%s</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jkbasis</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Keyword DF_BASIS_SCF is required.&#39;</span><span class="p">)</span>

        <span class="n">scf_helper</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s">&#39;DFMP2&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="c"># if the df_basis_mp2 basis is not set, pick a sensible one.</span>
    <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&#39;DF_BASIS_MP2&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="n">ribasis</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">corresponding_rifit</span><span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&#39;BASIS&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ribasis</span><span class="p">:</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_BASIS_MP2&#39;</span><span class="p">,</span> <span class="n">ribasis</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;No DF_BASIS_MP2 auxiliary basis selected, defaulting to </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ribasis</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Keyword DF_BASIS_MP2 is required.&#39;</span><span class="p">)</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">dfmp2grad</span><span class="p">()</span>
    <span class="n">e_dfmp2</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&#39;MP2 TOTAL ENERGY&#39;</span><span class="p">)</span>
    <span class="n">e_scs_dfmp2</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&#39;SCS-MP2 TOTAL ENERGY&#39;</span><span class="p">)</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;SCS-MP2&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">e_scs_dfmp2</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;DF-MP2&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;DFMP2&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;MP2&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">e_dfmp2</span>

</div>
<div class="viewcode-block" id="run_eom_cc"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_eom_cc">[docs]</a><span class="k">def</span> <span class="nf">run_eom_cc</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    an EOM-CC calculation, namely EOM-CC2, EOM-CCSD, and EOM-CC3.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;CCSORT&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;CCENERGY&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;CCHBAR&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;CCEOM&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;eom-ccsd&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CCSD&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCSORT&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CCSD&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCENERGY&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CCSD&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCHBAR&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CCSD&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCEOM&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CCSD&#39;</span><span class="p">)</span>
        <span class="n">run_ccenergy</span><span class="p">(</span><span class="s">&#39;ccsd&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;eom-cc2&#39;</span><span class="p">):</span>

        <span class="n">user_ref</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;CCENERGY&#39;</span><span class="p">,</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">user_ref</span> <span class="o">!=</span> <span class="s">&#39;RHF&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">user_ref</span> <span class="o">!=</span> <span class="s">&#39;UHF&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Reference </span><span class="si">%s</span><span class="s"> for EOM-CC2 is not available.&#39;</span> <span class="o">%</span> <span class="n">user_ref</span><span class="p">)</span>

        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CC2&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCSORT&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CC2&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCENERGY&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CC2&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCHBAR&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CC2&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCEOM&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CC2&#39;</span><span class="p">)</span>
        <span class="n">run_ccenergy</span><span class="p">(</span><span class="s">&#39;cc2&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;eom-cc3&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CC3&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCSORT&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CC3&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCENERGY&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CC3&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCHBAR&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CC3&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCEOM&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CC3&#39;</span><span class="p">)</span>
        <span class="n">run_ccenergy</span><span class="p">(</span><span class="s">&#39;cc3&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">cchbar</span><span class="p">()</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">cceom</span><span class="p">()</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_eom_cc_gradient"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_eom_cc_gradient">[docs]</a><span class="k">def</span> <span class="nf">run_eom_cc_gradient</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    an EOM-CCSD gradient calculation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;CCDENSITY&#39;</span><span class="p">,</span> <span class="s">&#39;XI&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;CCDENSITY&#39;</span><span class="p">,</span> <span class="s">&#39;ZETA&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;CCLAMBDA&#39;</span><span class="p">,</span> <span class="s">&#39;ZETA&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;DERTYPE&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;CCDENSITY&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;CCLAMBDA&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">])</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DERTYPE&#39;</span><span class="p">,</span> <span class="s">&#39;FIRST&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;eom-ccsd&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCLAMBDA&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CCSD&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCDENSITY&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;EOM_CCSD&#39;</span><span class="p">)</span>
        <span class="n">run_eom_cc</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCLAMBDA&#39;</span><span class="p">,</span> <span class="s">&#39;ZETA&#39;</span><span class="p">,</span> <span class="s">&#39;FALSE&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCDENSITY&#39;</span><span class="p">,</span> <span class="s">&#39;ZETA&#39;</span><span class="p">,</span> <span class="s">&#39;FALSE&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCDENSITY&#39;</span><span class="p">,</span> <span class="s">&#39;XI&#39;</span><span class="p">,</span> <span class="s">&#39;TRUE&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">cclambda</span><span class="p">()</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">ccdensity</span><span class="p">()</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCLAMBDA&#39;</span><span class="p">,</span> <span class="s">&#39;ZETA&#39;</span><span class="p">,</span> <span class="s">&#39;TRUE&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCDENSITY&#39;</span><span class="p">,</span> <span class="s">&#39;ZETA&#39;</span><span class="p">,</span> <span class="s">&#39;TRUE&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;CCDENSITY&#39;</span><span class="p">,</span> <span class="s">&#39;XI&#39;</span><span class="p">,</span> <span class="s">&#39;FALSE&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">cclambda</span><span class="p">()</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">ccdensity</span><span class="p">()</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">deriv</span><span class="p">()</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_adc"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_adc">[docs]</a><span class="k">def</span> <span class="nf">run_adc</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    an algebraic diagrammatic construction calculation.</span>

<span class="sd">    .. caution:: Get rid of active molecule lines- should be handled in energy.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;ADC&#39;</span><span class="p">,</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#39;RHF&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;ADC requires reference RHF&#39;</span><span class="p">)</span>

    <span class="c"># Bypass routine scf if user did something special to get it to converge</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="s">&#39;bypass_scf&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">yes</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;bypass_scf&#39;</span><span class="p">]))):</span>
        <span class="n">scf_helper</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">psi4</span><span class="o">.</span><span class="n">adc</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_dft"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_dft">[docs]</a><span class="k">def</span> <span class="nf">run_dft</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a density-functional-theory calculation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;DFT_FUNCTIONAL&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;DF_BASIS_MP2&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;DFMP2&#39;</span><span class="p">,</span> <span class="s">&#39;MP2_OS_SCALE&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;DFMP2&#39;</span><span class="p">,</span> <span class="s">&#39;MP2_SS_SCALE&#39;</span><span class="p">])</span>

    <span class="c"># Alter default algorithm</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">psi4</span><span class="o">.</span><span class="n">has_option_changed</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;DF&#39;</span><span class="p">)</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;DFT_FUNCTIONAL&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="n">user_ref</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">user_ref</span> <span class="o">==</span> <span class="s">&#39;RHF&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">,</span> <span class="s">&#39;RKS&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">user_ref</span> <span class="o">==</span> <span class="s">&#39;UHF&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">,</span> <span class="s">&#39;UKS&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">user_ref</span> <span class="o">==</span> <span class="s">&#39;ROHF&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;ROHF reference for DFT is not available.&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">user_ref</span> <span class="o">==</span> <span class="s">&#39;CUHF&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;CUHF reference for DFT is not available.&#39;</span><span class="p">)</span>

    <span class="n">run_scf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">returnvalue</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&#39;CURRENT ENERGY&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ssuper</span> <span class="ow">in</span> <span class="n">superfunctional_list</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">ssuper</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">dfun</span> <span class="o">=</span> <span class="n">ssuper</span>

    <span class="k">if</span> <span class="n">dfun</span><span class="o">.</span><span class="n">is_c_hybrid</span><span class="p">():</span>

        <span class="c"># if the df_basis_mp2 basis is not set, pick a sensible one.</span>
        <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&#39;DF_BASIS_MP2&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="n">ribasis</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">corresponding_rifit</span><span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&#39;BASIS&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">ribasis</span><span class="p">:</span>
                <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_BASIS_MP2&#39;</span><span class="p">,</span> <span class="n">ribasis</span><span class="p">)</span>
                <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;  No DF_BASIS_MP2 auxiliary basis selected, defaulting to </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ribasis</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Keyword DF_BASIS_MP2 is required.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dfun</span><span class="o">.</span><span class="n">is_c_scs_hybrid</span><span class="p">():</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;DFMP2&#39;</span><span class="p">,</span> <span class="s">&#39;MP2_OS_SCALE&#39;</span><span class="p">,</span> <span class="n">dfun</span><span class="o">.</span><span class="n">c_os_alpha</span><span class="p">())</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;DFMP2&#39;</span><span class="p">,</span> <span class="s">&#39;MP2_SS_SCALE&#39;</span><span class="p">,</span> <span class="n">dfun</span><span class="o">.</span><span class="n">c_ss_alpha</span><span class="p">())</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">dfmp2</span><span class="p">()</span>
            <span class="n">vdh</span> <span class="o">=</span> <span class="n">dfun</span><span class="o">.</span><span class="n">c_alpha</span><span class="p">()</span> <span class="o">*</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&#39;SCS-MP2 CORRELATION ENERGY&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">dfmp2</span><span class="p">()</span>
            <span class="n">vdh</span> <span class="o">=</span> <span class="n">dfun</span><span class="o">.</span><span class="n">c_alpha</span><span class="p">()</span> <span class="o">*</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&#39;MP2 CORRELATION ENERGY&#39;</span><span class="p">)</span>

        <span class="n">psi4</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&#39;DOUBLE-HYBRID CORRECTION ENERGY&#39;</span><span class="p">,</span> <span class="n">vdh</span><span class="p">)</span>
        <span class="n">returnvalue</span> <span class="o">+=</span> <span class="n">vdh</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&#39;DFT TOTAL ENERGY&#39;</span><span class="p">,</span> <span class="n">returnvalue</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&#39;CURRENT ENERGY&#39;</span><span class="p">,</span> <span class="n">returnvalue</span><span class="p">)</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_dft_gradient"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_dft_gradient">[docs]</a><span class="k">def</span> <span class="nf">run_dft_gradient</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a density-functional-theory gradient calculation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;DFT_FUNCTIONAL&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">])</span>

    <span class="c"># Alter default algorithm</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">psi4</span><span class="o">.</span><span class="n">has_option_changed</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;DF&#39;</span><span class="p">)</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;DFT_FUNCTIONAL&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="n">user_ref</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">user_ref</span> <span class="o">==</span> <span class="s">&#39;RHF&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">,</span> <span class="s">&#39;RKS&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">user_ref</span> <span class="o">==</span> <span class="s">&#39;UHF&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">,</span> <span class="s">&#39;UKS&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">user_ref</span> <span class="o">==</span> <span class="s">&#39;ROHF&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;ROHF reference for DFT is not available.&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">user_ref</span> <span class="o">==</span> <span class="s">&#39;CUHF&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;CUHF reference for DFT is not available.&#39;</span><span class="p">)</span>

    <span class="n">run_scf_gradient</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_detci"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_detci">[docs]</a><span class="k">def</span> <span class="nf">run_detci</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a configuration interaction calculation, namely FCI,</span>
<span class="sd">    CIn, MPn, and ZAPTn.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;DETCI&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;DETCI&#39;</span><span class="p">,</span> <span class="s">&#39;MAX_NUM_VECS&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;DETCI&#39;</span><span class="p">,</span> <span class="s">&#39;MPN_ORDER_SAVE&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;DETCI&#39;</span><span class="p">,</span> <span class="s">&#39;MPN&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;DETCI&#39;</span><span class="p">,</span> <span class="s">&#39;FCI&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;DETCI&#39;</span><span class="p">,</span> <span class="s">&#39;EX_LEVEL&#39;</span><span class="p">])</span>

    <span class="n">user_ref</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;DETCI&#39;</span><span class="p">,</span> <span class="s">&#39;REFERENCE&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">user_ref</span> <span class="o">!=</span> <span class="s">&#39;RHF&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">user_ref</span> <span class="o">!=</span> <span class="s">&#39;ROHF&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Reference </span><span class="si">%s</span><span class="s"> for DETCI is not available.&#39;</span> <span class="o">%</span> <span class="n">user_ref</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;zapt&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;ZAPTN&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;DETCI&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;ZAPTN&#39;</span><span class="p">)</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;level&#39;</span><span class="p">]</span>
        <span class="n">maxnvect</span> <span class="o">=</span> <span class="p">(</span><span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;DETCI&#39;</span><span class="p">,</span> <span class="s">&#39;MAX_NUM_VECS&#39;</span><span class="p">,</span> <span class="n">maxnvect</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;DETCI&#39;</span><span class="p">,</span> <span class="s">&#39;MPN_ORDER_SAVE&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;DETCI&#39;</span><span class="p">,</span> <span class="s">&#39;MPN_ORDER_SAVE&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;detci-mp&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;mp&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;DETCI&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;DETCI&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;DETCI&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;DETCI&#39;</span><span class="p">,</span> <span class="s">&#39;MPN&#39;</span><span class="p">,</span> <span class="s">&#39;TRUE&#39;</span><span class="p">)</span>

        <span class="n">level</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;level&#39;</span><span class="p">]</span>
        <span class="n">maxnvect</span> <span class="o">=</span> <span class="p">(</span><span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;DETCI&#39;</span><span class="p">,</span> <span class="s">&#39;MAX_NUM_VECS&#39;</span><span class="p">,</span> <span class="n">maxnvect</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;DETCI&#39;</span><span class="p">,</span> <span class="s">&#39;MPN_ORDER_SAVE&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;DETCI&#39;</span><span class="p">,</span> <span class="s">&#39;MPN_ORDER_SAVE&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;fci&#39;</span><span class="p">):</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;DETCI&#39;</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;DETCI&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;DETCI&#39;</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;DETCI&#39;</span><span class="p">,</span> <span class="s">&#39;FCI&#39;</span><span class="p">,</span> <span class="s">&#39;TRUE&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;cisd&#39;</span><span class="p">):</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;DETCI&#39;</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;DETCI&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;DETCI&#39;</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;DETCI&#39;</span><span class="p">,</span> <span class="s">&#39;EX_LEVEL&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;cisdt&#39;</span><span class="p">):</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;DETCI&#39;</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;DETCI&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;DETCI&#39;</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;DETCI&#39;</span><span class="p">,</span> <span class="s">&#39;EX_LEVEL&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;cisdtq&#39;</span><span class="p">):</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;DETCI&#39;</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;DETCI&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;DETCI&#39;</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;DETCI&#39;</span><span class="p">,</span> <span class="s">&#39;EX_LEVEL&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;ci&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;DETCI&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;DETCI&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;DETCI&#39;</span><span class="p">)</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;level&#39;</span><span class="p">]</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;DETCI&#39;</span><span class="p">,</span> <span class="s">&#39;EX_LEVEL&#39;</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
    <span class="c"># Call a plain energy(&#39;detci&#39;) and have full control over options</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;detci&#39;</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="c"># Bypass routine scf if user did something special to get it to converge</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="s">&#39;bypass_scf&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">yes</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;bypass_scf&#39;</span><span class="p">]))):</span>
        <span class="n">scf_helper</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c"># If the scf type is DF/CD, then the AO integrals were never written to disk</span>
        <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;DF&#39;</span> <span class="ow">or</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;CD&#39;</span><span class="p">:</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">MintsHelper</span><span class="p">()</span><span class="o">.</span><span class="n">integrals</span><span class="p">()</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">transqt2</span><span class="p">()</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">detci</span><span class="p">()</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="run_dfmp2"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_dfmp2">[docs]</a><span class="k">def</span> <span class="nf">run_dfmp2</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a density-fitted MP2 calculation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;DF_BASIS_MP2&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">])</span>

    <span class="c"># Alter default algorithm</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">psi4</span><span class="o">.</span><span class="n">has_option_changed</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;DF&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s">&#39;restart_file&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">restartfile</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;restart_file&#39;</span><span class="p">)</span>
        <span class="c"># Rename the checkpoint file to be consistent with psi4&#39;s file system</span>
        <span class="n">psioh</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">IOManager</span><span class="o">.</span><span class="n">shared_object</span><span class="p">()</span>
        <span class="n">psio</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">shared_object</span><span class="p">()</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">psioh</span><span class="o">.</span><span class="n">get_file_path</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="n">psio</span><span class="o">.</span><span class="n">get_default_namespace</span><span class="p">()</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s">&#39;psi&#39;</span>
        <span class="n">targetfile</span> <span class="o">=</span> <span class="n">filepath</span> <span class="o">+</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">pid</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">namespace</span> <span class="o">+</span> <span class="s">&#39;.32&#39;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">me</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">restartfile</span><span class="p">,</span> <span class="n">targetfile</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scf_helper</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s">&#39;DFMP2&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="c"># if the df_basis_mp2 basis is not set, pick a sensible one.</span>
    <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&#39;DF_BASIS_MP2&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="n">ribasis</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">corresponding_rifit</span><span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&#39;BASIS&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ribasis</span><span class="p">:</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_BASIS_MP2&#39;</span><span class="p">,</span> <span class="n">ribasis</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;  No DF_BASIS_MP2 auxiliary basis selected, defaulting to </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ribasis</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Keyword DF_BASIS_MP2 is required.&#39;</span><span class="p">)</span>

    <span class="n">e_dfmp2</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">dfmp2</span><span class="p">()</span>
    <span class="n">e_scs_dfmp2</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&#39;SCS-MP2 TOTAL ENERGY&#39;</span><span class="p">)</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;SCS-MP2&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">e_scs_dfmp2</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;DF-MP2&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;DFMP2&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;MP2&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">e_dfmp2</span>

</div>
<div class="viewcode-block" id="run_psimrcc"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_psimrcc">[docs]</a><span class="k">def</span> <span class="nf">run_psimrcc</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for a PSIMRCC computation</span>
<span class="sd">     using a reference from the MCSCF module</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">run_mcscf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">psimrcc</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&quot;CURRENT ENERGY&quot;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="run_psimrcc_scf"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_psimrcc_scf">[docs]</a><span class="k">def</span> <span class="nf">run_psimrcc_scf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for a PSIMRCC computation</span>
<span class="sd">     using a reference from the SCF module</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Bypass routine scf if user did something special to get it to converge</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="s">&#39;bypass_scf&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">yes</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;bypass_scf&#39;</span><span class="p">]))):</span>
        <span class="n">scf_helper</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">psimrcc</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&quot;CURRENT ENERGY&quot;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="run_mp2c"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_mp2c">[docs]</a><span class="k">def</span> <span class="nf">run_mp2c</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a coupled MP2 calculation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;DF_BASIS_MP2&#39;</span><span class="p">])</span>

    <span class="n">molecule</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">()</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>
    <span class="n">monomerA</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">extract_subsets</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">monomerA</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s">&#39;monomerA&#39;</span><span class="p">)</span>
    <span class="n">monomerB</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">extract_subsets</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">monomerB</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s">&#39;monomerB&#39;</span><span class="p">)</span>

    <span class="c"># if the df_basis_mp2 basis is not set, pick a sensible one.</span>
    <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&#39;DF_BASIS_MP2&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="n">ribasis</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">corresponding_rifit</span><span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&#39;BASIS&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ribasis</span><span class="p">:</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_BASIS_MP2&#39;</span><span class="p">,</span> <span class="n">ribasis</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;  No DF_BASIS_MP2 auxiliary basis selected, defaulting to </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ribasis</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Keyword DF_BASIS_MP2 is required.&#39;</span><span class="p">)</span>

    <span class="n">ri</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">)</span>
    <span class="n">df_ints_io</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;DF_INTS_IO&#39;</span><span class="p">)</span>
    <span class="c"># inquire if above at all applies to dfmp2</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">set_default_namespace</span><span class="p">(</span><span class="s">&#39;dimer&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;2-dimer&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s">&#39;Dimer HF&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_INTS_IO&#39;</span><span class="p">,</span> <span class="s">&#39;SAVE&#39;</span><span class="p">)</span>
    <span class="n">e_dimer</span> <span class="o">=</span> <span class="n">scf_helper</span><span class="p">(</span><span class="s">&#39;RHF&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s">&#39;Dimer DFMP2&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">e_dimer_mp2</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">dfmp2</span><span class="p">()</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_INTS_IO&#39;</span><span class="p">,</span> <span class="s">&#39;LOAD&#39;</span><span class="p">)</span>

    <span class="n">activate</span><span class="p">(</span><span class="n">monomerA</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span> <span class="o">==</span> <span class="s">&#39;DF&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">change_file_namespace</span><span class="p">(</span><span class="mi">97</span><span class="p">,</span> <span class="s">&#39;dimer&#39;</span><span class="p">,</span> <span class="s">&#39;monomerA&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">set_default_namespace</span><span class="p">(</span><span class="s">&#39;monomerA&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;2-monomer_A&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s">&#39;Monomer A HF&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">e_monomerA</span> <span class="o">=</span> <span class="n">scf_helper</span><span class="p">(</span><span class="s">&#39;RHF&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s">&#39;Monomer A DFMP2&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">e_monomerA_mp2</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">dfmp2</span><span class="p">()</span>

    <span class="n">activate</span><span class="p">(</span><span class="n">monomerB</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span> <span class="o">==</span> <span class="s">&#39;DF&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">change_file_namespace</span><span class="p">(</span><span class="mi">97</span><span class="p">,</span> <span class="s">&#39;monomerA&#39;</span><span class="p">,</span> <span class="s">&#39;monomerB&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">set_default_namespace</span><span class="p">(</span><span class="s">&#39;monomerB&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;2-monomer_B&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s">&#39;Monomer B HF&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">e_monomerB</span> <span class="o">=</span> <span class="n">scf_helper</span><span class="p">(</span><span class="s">&#39;RHF&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s">&#39;Monomer B DFMP2&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">e_monomerB_mp2</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">dfmp2</span><span class="p">()</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_INTS_IO&#39;</span><span class="p">,</span> <span class="n">df_ints_io</span><span class="p">)</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">change_file_namespace</span><span class="p">(</span><span class="n">p4const</span><span class="o">.</span><span class="n">PSIF_SAPT_MONOMERA</span><span class="p">,</span> <span class="s">&#39;monomerA&#39;</span><span class="p">,</span> <span class="s">&#39;dimer&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">change_file_namespace</span><span class="p">(</span><span class="n">p4const</span><span class="o">.</span><span class="n">PSIF_SAPT_MONOMERB</span><span class="p">,</span> <span class="s">&#39;monomerB&#39;</span><span class="p">,</span> <span class="s">&#39;dimer&#39;</span><span class="p">)</span>

    <span class="n">activate</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">set_default_namespace</span><span class="p">(</span><span class="s">&#39;dimer&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;E_CONVERGENCE&#39;</span><span class="p">,</span> <span class="mf">10e-10</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;D_CONVERGENCE&#39;</span><span class="p">,</span> <span class="mf">10e-10</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT_LEVEL&#39;</span><span class="p">,</span> <span class="s">&#39;MP2C&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s">&#39;MP2C&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&#39;MP2C DIMER MP2 ENERGY&#39;</span><span class="p">,</span> <span class="n">e_dimer_mp2</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&#39;MP2C MONOMER A MP2 ENERGY&#39;</span><span class="p">,</span> <span class="n">e_monomerA_mp2</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&#39;MP2C MONOMER B MP2 ENERGY&#39;</span><span class="p">,</span> <span class="n">e_monomerB_mp2</span><span class="p">)</span>

    <span class="n">e_sapt</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">sapt</span><span class="p">()</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">e_sapt</span>

</div>
<div class="viewcode-block" id="run_sapt"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_sapt">[docs]</a><span class="k">def</span> <span class="nf">run_sapt</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a SAPT calculation of any level.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">])</span>

    <span class="c"># Alter default algorithm</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">psi4</span><span class="o">.</span><span class="n">has_option_changed</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;DF&#39;</span><span class="p">)</span>

    <span class="n">molecule</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">()</span>
    <span class="n">user_pg</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">schoenflies_symbol</span><span class="p">()</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">reset_point_group</span><span class="p">(</span><span class="s">&#39;c1&#39;</span><span class="p">)</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">fix_orientation</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">fix_com</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span> <span class="c"># This should always have been set, very dangerous bug here</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user_pg</span> <span class="o">!=</span> <span class="s">&#39;c1&#39;</span><span class="p">:</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;  SAPT does not make use of molecular symmetry, further calculations in C1 point group.</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span><span class="s">&#39;REFERENCE&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#39;RHF&#39;</span> <span class="p">):</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;SAPT requires requires </span><span class="se">\&quot;</span><span class="s">reference rhf</span><span class="se">\&quot;</span><span class="s">.&#39;</span><span class="p">)</span>

    <span class="n">nfrag</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">nfragments</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">nfrag</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;SAPT requires active molecule to have 2 fragments, not </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nfrag</span><span class="p">))</span>

    <span class="n">sapt_basis</span> <span class="o">=</span> <span class="s">&#39;dimer&#39;</span>
    <span class="k">if</span> <span class="s">&#39;sapt_basis&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">sapt_basis</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;sapt_basis&#39;</span><span class="p">)</span>
    <span class="n">sapt_basis</span> <span class="o">=</span> <span class="n">sapt_basis</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">sapt_basis</span> <span class="o">==</span> <span class="s">&#39;dimer&#39;</span><span class="p">):</span>
        <span class="c">#molecule.update_geometry()</span>
        <span class="n">monomerA</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">extract_subsets</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">monomerA</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s">&#39;monomerA&#39;</span><span class="p">)</span>
        <span class="n">monomerB</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">extract_subsets</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">monomerB</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s">&#39;monomerB&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">sapt_basis</span> <span class="o">==</span> <span class="s">&#39;monomer&#39;</span><span class="p">):</span>
        <span class="c">#molecule.update_geometry()</span>
        <span class="n">monomerA</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">extract_subsets</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">monomerA</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s">&#39;monomerA&#39;</span><span class="p">)</span>
        <span class="n">monomerB</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">extract_subsets</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">monomerB</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s">&#39;monomerB&#39;</span><span class="p">)</span>

    <span class="n">ri</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">)</span>
    <span class="n">df_ints_io</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;DF_INTS_IO&#39;</span><span class="p">)</span>
    <span class="c"># inquire if above at all applies to dfmp2</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">set_default_namespace</span><span class="p">(</span><span class="s">&#39;dimer&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;2-dimer&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s">&#39;Dimer HF&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sapt_basis</span> <span class="o">==</span> <span class="s">&#39;dimer&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_INTS_IO&#39;</span><span class="p">,</span> <span class="s">&#39;SAVE&#39;</span><span class="p">)</span>
    <span class="n">e_dimer</span> <span class="o">=</span> <span class="n">scf_helper</span><span class="p">(</span><span class="s">&#39;RHF&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sapt_basis</span> <span class="o">==</span> <span class="s">&#39;dimer&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_INTS_IO&#39;</span><span class="p">,</span> <span class="s">&#39;LOAD&#39;</span><span class="p">)</span>

    <span class="n">activate</span><span class="p">(</span><span class="n">monomerA</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span> <span class="o">==</span> <span class="s">&#39;DF&#39;</span> <span class="ow">and</span> <span class="n">sapt_basis</span> <span class="o">==</span> <span class="s">&#39;dimer&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">change_file_namespace</span><span class="p">(</span><span class="mi">97</span><span class="p">,</span> <span class="s">&#39;dimer&#39;</span><span class="p">,</span> <span class="s">&#39;monomerA&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">set_default_namespace</span><span class="p">(</span><span class="s">&#39;monomerA&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;2-monomer_A&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s">&#39;Monomer A HF&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">e_monomerA</span> <span class="o">=</span> <span class="n">scf_helper</span><span class="p">(</span><span class="s">&#39;RHF&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">activate</span><span class="p">(</span><span class="n">monomerB</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span> <span class="o">==</span> <span class="s">&#39;DF&#39;</span> <span class="ow">and</span> <span class="n">sapt_basis</span> <span class="o">==</span> <span class="s">&#39;dimer&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">change_file_namespace</span><span class="p">(</span><span class="mi">97</span><span class="p">,</span> <span class="s">&#39;monomerA&#39;</span><span class="p">,</span> <span class="s">&#39;monomerB&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">set_default_namespace</span><span class="p">(</span><span class="s">&#39;monomerB&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;2-monomer_B&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s">&#39;Monomer B HF&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">e_monomerB</span> <span class="o">=</span> <span class="n">scf_helper</span><span class="p">(</span><span class="s">&#39;RHF&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_INTS_IO&#39;</span><span class="p">,</span> <span class="n">df_ints_io</span><span class="p">)</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">change_file_namespace</span><span class="p">(</span><span class="n">p4const</span><span class="o">.</span><span class="n">PSIF_SAPT_MONOMERA</span><span class="p">,</span> <span class="s">&#39;monomerA&#39;</span><span class="p">,</span> <span class="s">&#39;dimer&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">change_file_namespace</span><span class="p">(</span><span class="n">p4const</span><span class="o">.</span><span class="n">PSIF_SAPT_MONOMERB</span><span class="p">,</span> <span class="s">&#39;monomerB&#39;</span><span class="p">,</span> <span class="s">&#39;dimer&#39;</span><span class="p">)</span>

    <span class="n">activate</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">set_default_namespace</span><span class="p">(</span><span class="s">&#39;dimer&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;E_CONVERGENCE&#39;</span><span class="p">,</span> <span class="mf">10e-10</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;D_CONVERGENCE&#39;</span><span class="p">,</span> <span class="mf">10e-10</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;sapt0&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT_LEVEL&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT0&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;sapt2&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT_LEVEL&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT2&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;sapt2+&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT_LEVEL&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT2+&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;DO_CCD_DISP&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;sapt2+(3)&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT_LEVEL&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT2+3&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;DO_THIRD_ORDER&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;DO_CCD_DISP&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;sapt2+3&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT_LEVEL&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT2+3&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;DO_THIRD_ORDER&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;DO_CCD_DISP&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;sapt2+(ccd)&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT_LEVEL&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT2+&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;DO_CCD_DISP&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;sapt2+(3)(ccd)&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT_LEVEL&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT2+3&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;DO_THIRD_ORDER&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;DO_CCD_DISP&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;sapt2+3(ccd)&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT_LEVEL&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT2+3&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;DO_THIRD_ORDER&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;DO_CCD_DISP&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

    <span class="c"># if the df_basis_sapt basis is not set, pick a sensible one.</span>
    <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&#39;DF_BASIS_SAPT&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="n">ribasis</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">corresponding_rifit</span><span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&#39;BASIS&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ribasis</span><span class="p">:</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_BASIS_SAPT&#39;</span><span class="p">,</span> <span class="n">ribasis</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;  No DF_BASIS_SAPT auxiliary basis selected, defaulting to </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ribasis</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Keyword DF_BASIS_SAPT is required.&#39;</span><span class="p">)</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">e_sapt</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">sapt</span><span class="p">()</span>

    <span class="n">molecule</span><span class="o">.</span><span class="n">reset_point_group</span><span class="p">(</span><span class="n">user_pg</span><span class="p">)</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">e_sapt</span>
</div>
<div class="viewcode-block" id="run_sapt_ct"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_sapt_ct">[docs]</a><span class="k">def</span> <span class="nf">run_sapt_ct</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a charge-transfer SAPT calcuation of any level.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">])</span>

    <span class="c"># Alter default algorithm</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">psi4</span><span class="o">.</span><span class="n">has_option_changed</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;DF&#39;</span><span class="p">)</span>

    <span class="n">molecule</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">()</span>
    <span class="n">user_pg</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">schoenflies_symbol</span><span class="p">()</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">reset_point_group</span><span class="p">(</span><span class="s">&#39;c1&#39;</span><span class="p">)</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">fix_orientation</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user_pg</span> <span class="o">!=</span> <span class="s">&#39;c1&#39;</span><span class="p">:</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;  SAPT does not make use of molecular symmetry, further calculations in C1 point group.</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span><span class="s">&#39;REFERENCE&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#39;RHF&#39;</span> <span class="p">):</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;SAPT requires requires </span><span class="se">\&quot;</span><span class="s">reference rhf</span><span class="se">\&quot;</span><span class="s">.&#39;</span><span class="p">)</span>

    <span class="n">nfrag</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">nfragments</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">nfrag</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;SAPT requires active molecule to have 2 fragments, not </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nfrag</span><span class="p">))</span>

    <span class="n">monomerA</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">extract_subsets</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">monomerA</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s">&#39;monomerA&#39;</span><span class="p">)</span>
    <span class="n">monomerB</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">extract_subsets</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">monomerB</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s">&#39;monomerB&#39;</span><span class="p">)</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>
    <span class="n">monomerAm</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">extract_subsets</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">monomerAm</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s">&#39;monomerAm&#39;</span><span class="p">)</span>
    <span class="n">monomerBm</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">extract_subsets</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">monomerBm</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s">&#39;monomerBm&#39;</span><span class="p">)</span>

    <span class="n">ri</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">)</span>
    <span class="n">df_ints_io</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;DF_INTS_IO&#39;</span><span class="p">)</span>
    <span class="c"># inquire if above at all applies to dfmp2</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">set_default_namespace</span><span class="p">(</span><span class="s">&#39;dimer&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;2-dimer&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s">&#39;Dimer HF&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_INTS_IO&#39;</span><span class="p">,</span> <span class="s">&#39;SAVE&#39;</span><span class="p">)</span>
    <span class="n">e_dimer</span> <span class="o">=</span> <span class="n">scf_helper</span><span class="p">(</span><span class="s">&#39;RHF&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_INTS_IO&#39;</span><span class="p">,</span> <span class="s">&#39;LOAD&#39;</span><span class="p">)</span>

    <span class="n">activate</span><span class="p">(</span><span class="n">monomerA</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span> <span class="o">==</span> <span class="s">&#39;DF&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">change_file_namespace</span><span class="p">(</span><span class="mi">97</span><span class="p">,</span> <span class="s">&#39;dimer&#39;</span><span class="p">,</span> <span class="s">&#39;monomerA&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">set_default_namespace</span><span class="p">(</span><span class="s">&#39;monomerA&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;2-monomer_A&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s">&#39;Monomer A HF (Dimer Basis)&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">e_monomerA</span> <span class="o">=</span> <span class="n">scf_helper</span><span class="p">(</span><span class="s">&#39;RHF&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">activate</span><span class="p">(</span><span class="n">monomerB</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ri</span> <span class="o">==</span> <span class="s">&#39;DF&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">change_file_namespace</span><span class="p">(</span><span class="mi">97</span><span class="p">,</span> <span class="s">&#39;monomerA&#39;</span><span class="p">,</span> <span class="s">&#39;monomerB&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">set_default_namespace</span><span class="p">(</span><span class="s">&#39;monomerB&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;2-monomer_B&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s">&#39;Monomer B HF (Dimer Basis)&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">e_monomerB</span> <span class="o">=</span> <span class="n">scf_helper</span><span class="p">(</span><span class="s">&#39;RHF&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_INTS_IO&#39;</span><span class="p">,</span> <span class="n">df_ints_io</span><span class="p">)</span>

    <span class="n">activate</span><span class="p">(</span><span class="n">monomerAm</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">set_default_namespace</span><span class="p">(</span><span class="s">&#39;monomerAm&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;2-monomer_A&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s">&#39;Monomer A HF (Monomer Basis)&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">e_monomerA</span> <span class="o">=</span> <span class="n">scf_helper</span><span class="p">(</span><span class="s">&#39;RHF&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">activate</span><span class="p">(</span><span class="n">monomerBm</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">set_default_namespace</span><span class="p">(</span><span class="s">&#39;monomerBm&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;2-monomer_B&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s">&#39;Monomer B HF (Monomer Basis)&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">e_monomerB</span> <span class="o">=</span> <span class="n">scf_helper</span><span class="p">(</span><span class="s">&#39;RHF&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">activate</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">set_default_namespace</span><span class="p">(</span><span class="s">&#39;dimer&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;E_CONVERGENCE&#39;</span><span class="p">,</span> <span class="mf">10e-10</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;D_CONVERGENCE&#39;</span><span class="p">,</span> <span class="mf">10e-10</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;sapt0-ct&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT_LEVEL&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT0&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;sapt2-ct&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT_LEVEL&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT2&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;sapt2+-ct&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT_LEVEL&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT2+&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;sapt2+(3)-ct&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT_LEVEL&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT2+3&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;DO_THIRD_ORDER&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;sapt2+3-ct&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT_LEVEL&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT2+3&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;DO_THIRD_ORDER&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;sapt2+(ccd)-ct&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT_LEVEL&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT2+&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;DO_CCD_DISP&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;sapt2+(3)(ccd)-ct&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT_LEVEL&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT2+3&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;DO_THIRD_ORDER&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;DO_CCD_DISP&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;sapt2+3(ccd)-ct&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT_LEVEL&#39;</span><span class="p">,</span> <span class="s">&#39;SAPT2+3&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;DO_THIRD_ORDER&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SAPT&#39;</span><span class="p">,</span> <span class="s">&#39;DO_CCD_DISP&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s">&#39;SAPT Charge Transfer&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="c"># if the df_basis_sapt basis is not set, pick a sensible one.</span>
    <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&#39;DF_BASIS_SAPT&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="n">ribasis</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">corresponding_rifit</span><span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&#39;BASIS&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ribasis</span><span class="p">:</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_BASIS_SAPT&#39;</span><span class="p">,</span> <span class="n">ribasis</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;  No DF_BASIS_SAPT auxiliary basis selected, defaulting to </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ribasis</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Keyword DF_BASIS_SAPT is required.&#39;</span><span class="p">)</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s">&#39;Dimer Basis SAPT&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">change_file_namespace</span><span class="p">(</span><span class="n">p4const</span><span class="o">.</span><span class="n">PSIF_SAPT_MONOMERA</span><span class="p">,</span> <span class="s">&#39;monomerA&#39;</span><span class="p">,</span> <span class="s">&#39;dimer&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">change_file_namespace</span><span class="p">(</span><span class="n">p4const</span><span class="o">.</span><span class="n">PSIF_SAPT_MONOMERB</span><span class="p">,</span> <span class="s">&#39;monomerB&#39;</span><span class="p">,</span> <span class="s">&#39;dimer&#39;</span><span class="p">)</span>
    <span class="n">e_sapt</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">sapt</span><span class="p">()</span>
    <span class="n">CTd</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&#39;SAPT CT ENERGY&#39;</span><span class="p">)</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s">&#39;Monomer Basis SAPT&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">change_file_namespace</span><span class="p">(</span><span class="n">p4const</span><span class="o">.</span><span class="n">PSIF_SAPT_MONOMERA</span><span class="p">,</span> <span class="s">&#39;monomerAm&#39;</span><span class="p">,</span> <span class="s">&#39;dimer&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">change_file_namespace</span><span class="p">(</span><span class="n">p4const</span><span class="o">.</span><span class="n">PSIF_SAPT_MONOMERB</span><span class="p">,</span> <span class="s">&#39;monomerBm&#39;</span><span class="p">,</span> <span class="s">&#39;dimer&#39;</span><span class="p">)</span>
    <span class="n">e_sapt</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">sapt</span><span class="p">()</span>
    <span class="n">CTm</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&#39;SAPT CT ENERGY&#39;</span><span class="p">)</span>
    <span class="n">CT</span> <span class="o">=</span> <span class="n">CTd</span> <span class="o">-</span> <span class="n">CTm</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;    SAPT Charge Transfer Analysis</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;  -----------------------------------------------------------------------------</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">line1</span> <span class="o">=</span> <span class="s">&#39;    SAPT Induction (Dimer Basis)      </span><span class="si">%10.4lf</span><span class="s"> mH    </span><span class="si">%10.4lf</span><span class="s"> kcal mol^-1</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">CTd</span> <span class="o">*</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="n">CTd</span> <span class="o">*</span> <span class="n">p4const</span><span class="o">.</span><span class="n">psi_hartree2kcalmol</span><span class="p">)</span>
    <span class="n">line2</span> <span class="o">=</span> <span class="s">&#39;    SAPT Induction (Monomer Basis)    </span><span class="si">%10.4lf</span><span class="s"> mH    </span><span class="si">%10.4lf</span><span class="s"> kcal mol^-1</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">CTm</span> <span class="o">*</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="n">CTm</span> <span class="o">*</span> <span class="n">p4const</span><span class="o">.</span><span class="n">psi_hartree2kcalmol</span><span class="p">)</span>
    <span class="n">line3</span> <span class="o">=</span> <span class="s">&#39;    SAPT Charge Transfer              </span><span class="si">%10.4lf</span><span class="s"> mH    </span><span class="si">%10.4lf</span><span class="s"> kcal mol^-1</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">CT</span> <span class="o">*</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="n">CT</span> <span class="o">*</span> <span class="n">p4const</span><span class="o">.</span><span class="n">psi_hartree2kcalmol</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">line1</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">line2</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">line3</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&#39;SAPT CT ENERGY&#39;</span><span class="p">,</span> <span class="n">CT</span><span class="p">)</span>

    <span class="n">molecule</span><span class="o">.</span><span class="n">reset_point_group</span><span class="p">(</span><span class="n">user_pg</span><span class="p">)</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">e_sapt</span>

</div>
<div class="viewcode-block" id="run_mrcc"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_mrcc">[docs]</a><span class="k">def</span> <span class="nf">run_mrcc</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function that prepares environment and input files</span>
<span class="sd">    for a calculation calling Kallay&#39;s MRCC code.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># TODO: Check to see if we really need to run the SCF code.</span>
    <span class="n">scf_helper</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">vscf</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&#39;SCF TOTAL ENERGY&#39;</span><span class="p">)</span>

    <span class="c"># The parse_arbitrary_order method provides us the following information</span>
    <span class="c"># We require that level be provided. level is a dictionary</span>
    <span class="c"># of settings to be passed to psi4.mrcc</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="s">&#39;level&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;level parameter was not provided.&#39;</span><span class="p">)</span>

    <span class="n">level</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;level&#39;</span><span class="p">]</span>

    <span class="c"># Fullname is the string we need to search for in iface</span>
    <span class="n">fullname</span> <span class="o">=</span> <span class="n">level</span><span class="p">[</span><span class="s">&#39;fullname&#39;</span><span class="p">]</span>

    <span class="c"># User can provide &#39;keep&#39; to the method.</span>
    <span class="c"># When provided, do not delete the MRCC scratch directory.</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="s">&#39;keep&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">keep</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;keep&#39;</span><span class="p">]</span>

    <span class="c"># Save current directory location</span>
    <span class="n">current_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

    <span class="c"># Need to move to the scratch directory, perferrably into a separate directory in that location</span>
    <span class="n">psi_io</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">IOManager</span><span class="o">.</span><span class="n">shared_object</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">psi_io</span><span class="o">.</span><span class="n">get_default_path</span><span class="p">())</span>

    <span class="c"># Make new directory specifically for mrcc</span>
    <span class="n">mrcc_tmpdir</span> <span class="o">=</span> <span class="s">&#39;mrcc_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
    <span class="k">if</span> <span class="s">&#39;path&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">mrcc_tmpdir</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;path&#39;</span><span class="p">]</span>

    <span class="c"># Check to see if directory already exists, if not, create.</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mrcc_tmpdir</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">mrcc_tmpdir</span><span class="p">)</span>

    <span class="c"># Move into the new directory</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">mrcc_tmpdir</span><span class="p">)</span>

    <span class="c"># Generate integrals and input file (dumps files to the current directory)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">mrcc_generate_input</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>

    <span class="c"># Load the fort.56 file</span>
    <span class="c"># and dump a copy into the outfile</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">===== Begin fort.56 input for MRCC ======</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;fort.56&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;===== End   fort.56 input for MRCC ======</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="c"># Close output file</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">close_outfile</span><span class="p">()</span>

    <span class="c"># Modify the environment:</span>
    <span class="c">#    PGI Fortan prints warning to screen if STOP is used</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;NO_STOP_MESSAGE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;1&#39;</span>

    <span class="c"># Obtain user&#39;s OMP_NUM_THREADS so that we don&#39;t blow it away.</span>
    <span class="n">omp_num_threads_found</span> <span class="o">=</span> <span class="s">&#39;OMP_NUM_THREADS&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>
    <span class="k">if</span> <span class="n">omp_num_threads_found</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">omp_num_threads_user</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;OMP_NUM_THREADS&#39;</span><span class="p">]</span>

    <span class="c"># If the user provided MRCC_OMP_NUM_THREADS set the environ to it</span>
    <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">has_option_changed</span><span class="p">(</span><span class="s">&#39;MRCC&#39;</span><span class="p">,</span> <span class="s">&#39;MRCC_OMP_NUM_THREADS&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;OMP_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;MRCC&#39;</span><span class="p">,</span> <span class="s">&#39;MRCC_OMP_NUM_THREADS&#39;</span><span class="p">))</span>

    <span class="c"># Call dmrcc, directing all screen output to the output file</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">outfile_name</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;stdout&#39;</span><span class="p">:</span>
            <span class="n">retcode</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s">&#39;dmrcc&#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">retcode</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s">&#39;dmrcc &gt;&gt; &#39;</span> <span class="o">+</span> <span class="n">current_directory</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">psi4</span><span class="o">.</span><span class="n">outfile_name</span><span class="p">(),</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">retcode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;MRCC was terminated by signal </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="o">-</span><span class="n">retcode</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">retcode</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;MRCC errored </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">retcode</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Execution failed: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c"># Restore the OMP_NUM_THREADS that the user set.</span>
    <span class="k">if</span> <span class="n">omp_num_threads_found</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">has_option_changed</span><span class="p">(</span><span class="s">&#39;MRCC&#39;</span><span class="p">,</span> <span class="s">&#39;MRCC_OMP_NUM_THREADS&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;OMP_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">omp_num_threads_user</span>

    <span class="c"># Scan iface file and grab the file energy.</span>
    <span class="n">e</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">file</span><span class="p">(</span><span class="s">&#39;iface&#39;</span><span class="p">):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="s">&quot;MP(2)&quot;</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="s">&quot;MP2&quot;</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="s">&#39; TOTAL ENERGY&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="s">&#39; CORRELATION ENERGY&#39;</span><span class="p">,</span> <span class="n">e</span> <span class="o">-</span> <span class="n">vscf</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">continue</span>

    <span class="c"># The last &#39;e&#39; in iface is the one the user requested.</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&#39;CURRENT ENERGY&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&#39;CURRENT CORRELATION ENERGY&#39;</span><span class="p">,</span> <span class="n">e</span> <span class="o">-</span> <span class="n">vscf</span><span class="p">)</span>

    <span class="c"># Load the iface file</span>
    <span class="n">iface</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;iface&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">iface_contents</span> <span class="o">=</span> <span class="n">iface</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="c"># Delete mrcc tempdir</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s">&#39;..&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># Delete unless we&#39;re told not to</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">keep</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="s">&#39;path&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">mrcc_tmpdir</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Unable to remove MRCC temporary directory </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c"># Revert to previous current directory location</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">current_directory</span><span class="p">)</span>

    <span class="c"># Reopen output file</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">reopen_outfile</span><span class="p">()</span>

    <span class="c"># If we&#39;re told to keep the files or the user provided a path, do nothing.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">keep</span> <span class="o">!=</span> <span class="bp">False</span> <span class="ow">or</span> <span class="p">(</span><span class="s">&#39;path&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">MRCC scratch files have been kept.</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;They can be found in &#39;</span> <span class="o">+</span> <span class="n">mrcc_tmpdir</span><span class="p">)</span>

    <span class="c"># Dump iface contents to output</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s">&#39;Full results from MRCC&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">iface_contents</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">e</span>

</div>
<div class="viewcode-block" id="run_fnodfcc"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_fnodfcc">[docs]</a><span class="k">def</span> <span class="nf">run_fnodfcc</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a DF-CCSD(T) computation.</span>

<span class="sd">    &gt;&gt;&gt; energy(&#39;df-ccsd(t)&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">kwargs_lower</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c"># stash user options</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;COMPUTE_TRIPLES&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;DFCC&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;NAT_ORBS&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;RUN_CEPA&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span><span class="s">&#39;DF_BASIS_SCF&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span><span class="s">&#39;DF_INTS_IO&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span><span class="s">&#39;SCF_TYPE&#39;</span><span class="p">])</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span> <span class="s">&#39;DFCC&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span> <span class="s">&#39;RUN_CEPA&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

    <span class="c"># throw an exception for open-shells</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span><span class="s">&#39;REFERENCE&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#39;RHF&#39;</span> <span class="p">):</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&quot;Error: </span><span class="si">%s</span><span class="s"> requires </span><span class="se">\&quot;</span><span class="s">reference rhf</span><span class="se">\&quot;</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="n">lowername</span><span class="p">)</span>

    <span class="c"># override symmetry:</span>
    <span class="n">molecule</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">()</span>
    <span class="n">user_pg</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">schoenflies_symbol</span><span class="p">()</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">reset_point_group</span><span class="p">(</span><span class="s">&#39;c1&#39;</span><span class="p">)</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">fix_orientation</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user_pg</span> <span class="o">!=</span> <span class="s">&#39;c1&#39;</span><span class="p">:</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;  FNOCC does not make use of molecular symmetry, further calculations in C1 point group.</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="c"># hack to ensure puream (or not) throughout</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;PUREAM&#39;</span><span class="p">,</span> <span class="n">psi4</span><span class="o">.</span><span class="n">MintsHelper</span><span class="p">()</span><span class="o">.</span><span class="n">basisset</span><span class="p">()</span><span class="o">.</span><span class="n">has_puream</span><span class="p">())</span>

    <span class="c"># triples?</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;df-ccsd&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span> <span class="s">&#39;COMPUTE_TRIPLES&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;df-ccsd(t)&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span> <span class="s">&#39;COMPUTE_TRIPLES&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;fno-df-ccsd&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span> <span class="s">&#39;COMPUTE_TRIPLES&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span> <span class="s">&#39;NAT_ORBS&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;fno-df-ccsd(t)&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span> <span class="s">&#39;COMPUTE_TRIPLES&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span> <span class="s">&#39;NAT_ORBS&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

    <span class="c"># set scf-type to df unless the user wants something else</span>
    <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">has_option_changed</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span><span class="s">&#39;SCF_TYPE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
       <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;SCF_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;DF&#39;</span><span class="p">)</span>

    <span class="n">scf_type</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span><span class="s">&#39;SCF_TYPE&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">scf_type</span> <span class="o">!=</span> <span class="s">&#39;CD&#39;</span> <span class="ow">and</span> <span class="n">scf_type</span> <span class="o">!=</span> <span class="s">&#39;DF&#39;</span> <span class="p">):</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&quot;Invalid scf_type for DFCC.&quot;</span><span class="p">)</span>

    <span class="c"># save DF or CD ints generated by SCF for use in CC</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span><span class="s">&#39;DF_INTS_IO&#39;</span><span class="p">,</span> <span class="s">&#39;SAVE&#39;</span><span class="p">)</span>

    <span class="c"># the default auxiliary basis</span>
    <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;DF_BASIS_CC&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
       <span class="n">basis</span>   <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&#39;BASIS&#39;</span><span class="p">)</span>
       <span class="n">dfbasis</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">corresponding_rifit</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
       <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;DF_BASIS_CC&#39;</span><span class="p">,</span><span class="n">dfbasis</span><span class="p">)</span>

    <span class="c"># make sure this module knows what df basis was used in the scf</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span><span class="s">&#39;SCF_TYPE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;DF&quot;</span> <span class="p">):</span>
        <span class="n">df_basis_scf</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span><span class="s">&#39;DF_BASIS_SCF&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df_basis_scf</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
           <span class="n">basis</span>        <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&#39;BASIS&#39;</span><span class="p">)</span>
           <span class="n">df_basis_scf</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">corresponding_jkfit</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>

        <span class="n">psi4</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_BASIS_SCF&#39;</span><span class="p">,</span><span class="n">df_basis_scf</span><span class="p">)</span>

    <span class="n">scf_helper</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">fnocc</span><span class="p">()</span>

    <span class="n">molecule</span><span class="o">.</span><span class="n">reset_point_group</span><span class="p">(</span><span class="n">user_pg</span><span class="p">)</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>

    <span class="c"># restore options</span>
    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&quot;CURRENT ENERGY&quot;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="run_fnocc"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_fnocc">[docs]</a><span class="k">def</span> <span class="nf">run_fnocc</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a QCISD(T), CCSD(T), MP2.5, MP3, and MP4 computation.</span>

<span class="sd">    &gt;&gt;&gt; energy(&#39;fno-ccsd(t)&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">kwargs_lower</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">&#39;level&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;level&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c"># stash user options:</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span><span class="s">&#39;WFN&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;RUN_MP2&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;RUN_MP3&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;RUN_MP4&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;RUN_CCSD&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;COMPUTE_TRIPLES&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;COMPUTE_MP4_TRIPLES&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;DFCC&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;RUN_CEPA&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;USE_DF_INTS&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;NAT_ORBS&#39;</span><span class="p">])</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;DFCC&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;RUN_CEPA&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;USE_DF_INTS&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

    <span class="c"># which method?</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;_ccsd&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;COMPUTE_TRIPLES&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;RUN_CCSD&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;_ccsd(t)&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;COMPUTE_TRIPLES&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;RUN_CCSD&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;fno-ccsd&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;COMPUTE_TRIPLES&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;RUN_CCSD&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;NAT_ORBS&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;fno-ccsd(t)&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;COMPUTE_TRIPLES&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;RUN_CCSD&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;NAT_ORBS&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;qcisd&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;COMPUTE_TRIPLES&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;RUN_CCSD&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;qcisd(t)&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;COMPUTE_TRIPLES&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;RUN_CCSD&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;fno-qcisd&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;COMPUTE_TRIPLES&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;RUN_CCSD&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;NAT_ORBS&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;fno-qcisd(t)&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;COMPUTE_TRIPLES&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;NAT_ORBS&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;RUN_CCSD&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;_mp2&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;RUN_MP2&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;fno-mp3&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;RUN_MP3&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;NAT_ORBS&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;fno-mp4&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;RUN_MP4&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;COMPUTE_MP4_TRIPLES&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;COMPUTE_TRIPLES&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;NAT_ORBS&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;mp4(sdq)&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;RUN_MP4&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;COMPUTE_MP4_TRIPLES&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;COMPUTE_TRIPLES&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;fno-mp4(sdq)&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;RUN_MP4&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;COMPUTE_MP4_TRIPLES&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;COMPUTE_TRIPLES&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;NAT_ORBS&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;fnocc-mp&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;RUN_MP3&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;fnocc-mp&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="mi">4</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;RUN_MP4&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;COMPUTE_MP4_TRIPLES&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;COMPUTE_TRIPLES&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

    <span class="c"># throw an exception for open-shells</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span><span class="s">&#39;REFERENCE&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#39;RHF&#39;</span> <span class="p">):</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&quot;Error: </span><span class="si">%s</span><span class="s"> requires </span><span class="se">\&quot;</span><span class="s">reference rhf</span><span class="se">\&quot;</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="n">lowername</span><span class="p">)</span>

    <span class="c"># scf</span>
    <span class="n">scf_helper</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c"># if the scf type is df/cd, then the ao integrals were never written to disk.</span>
    <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;DF&#39;</span> <span class="ow">or</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;CD&#39;</span><span class="p">:</span>
        <span class="c"># do we generate 4-index eri&#39;s with 3-index ones, or do we want conventional eri&#39;s?</span>
        <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span> <span class="s">&#39;USE_DF_INTS&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">mints</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">MintsHelper</span><span class="p">()</span>
            <span class="n">mints</span><span class="o">.</span><span class="n">integrals</span><span class="p">()</span>

    <span class="c"># if this is not cim or FNO-CC, run transqt2.  otherwise, libtrans will be used</span>
    <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;NAT_ORBS&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">and</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;RUN_MP2&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span> <span class="s">&#39;USE_DF_INTS&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;CCSD&#39;</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">transqt2</span><span class="p">()</span>

    <span class="c"># run ccsd</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">fnocc</span><span class="p">()</span>

    <span class="c"># set current correlation energy and total energy.  only need to treat mpn here.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;fnocc-mp&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
        <span class="n">emp3</span>     <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&quot;MP3 TOTAL ENERGY&quot;</span><span class="p">)</span>
        <span class="n">cemp3</span>    <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&quot;MP3 CORRELATION ENERGY&quot;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&quot;CURRENT ENERGY&quot;</span><span class="p">,</span><span class="n">emp3</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&quot;CURRENT CORRELATION ENERGY&quot;</span><span class="p">,</span><span class="n">cemp3</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span> <span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;fno-mp3&#39;</span> <span class="p">):</span>
        <span class="n">emp3</span>     <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&quot;MP3 TOTAL ENERGY&quot;</span><span class="p">)</span>
        <span class="n">cemp3</span>    <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&quot;MP3 CORRELATION ENERGY&quot;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&quot;CURRENT ENERGY&quot;</span><span class="p">,</span><span class="n">emp3</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&quot;CURRENT CORRELATION ENERGY&quot;</span><span class="p">,</span><span class="n">cemp3</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span> <span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;mp4(sdq)&#39;</span><span class="p">):</span>
        <span class="n">emp4sdq</span>  <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&quot;MP4(SDQ) TOTAL ENERGY&quot;</span><span class="p">)</span>
        <span class="n">cemp4sdq</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&quot;MP4(SDQ) CORRELATION ENERGY&quot;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&quot;CURRENT ENERGY&quot;</span><span class="p">,</span><span class="n">emp4sdq</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&quot;CURRENT CORRELATION ENERGY&quot;</span><span class="p">,</span><span class="n">cemp4sdq</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span> <span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;fno-mp4(sdq)&#39;</span><span class="p">):</span>
        <span class="n">emp4sdq</span>  <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&quot;MP4(SDQ) TOTAL ENERGY&quot;</span><span class="p">)</span>
        <span class="n">cemp4sdq</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&quot;MP4(SDQ) CORRELATION ENERGY&quot;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&quot;CURRENT ENERGY&quot;</span><span class="p">,</span><span class="n">emp4sdq</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&quot;CURRENT CORRELATION ENERGY&quot;</span><span class="p">,</span><span class="n">cemp4sdq</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span> <span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;fno-mp4&#39;</span><span class="p">):</span>
        <span class="n">emp4</span>     <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&quot;MP4 TOTAL ENERGY&quot;</span><span class="p">)</span>
        <span class="n">cemp4</span>    <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&quot;MP4 CORRELATION ENERGY&quot;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&quot;CURRENT ENERGY&quot;</span><span class="p">,</span><span class="n">emp4</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&quot;CURRENT CORRELATION ENERGY&quot;</span><span class="p">,</span><span class="n">cemp4</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;fnocc-mp&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="mi">4</span><span class="p">):</span>
        <span class="n">emp4</span>     <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&quot;MP4 TOTAL ENERGY&quot;</span><span class="p">)</span>
        <span class="n">cemp4</span>    <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&quot;MP4 CORRELATION ENERGY&quot;</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&quot;CURRENT ENERGY&quot;</span><span class="p">,</span><span class="n">emp4</span><span class="p">)</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&quot;CURRENT CORRELATION ENERGY&quot;</span><span class="p">,</span><span class="n">cemp4</span><span class="p">)</span>

    <span class="c"># restore options</span>
    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&quot;CURRENT ENERGY&quot;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="run_cepa"><a class="viewcode-back" href="../autodoc_driver.html#proc.run_cepa">[docs]</a><span class="k">def</span> <span class="nf">run_cepa</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function encoding sequence of PSI module calls for</span>
<span class="sd">    a cepa-like calculation.</span>

<span class="sd">    &gt;&gt;&gt; energy(&#39;cepa(1)&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">uppername</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">kwargs_lower</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c"># save user options</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span> <span class="s">&#39;NAT_ORBS&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span> <span class="s">&#39;RUN_CEPA&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span> <span class="s">&#39;USE_DF_INTS&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span> <span class="s">&#39;CEPA_NO_SINGLES&#39;</span><span class="p">])</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;RUN_CEPA&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;USE_DF_INTS&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

    <span class="c"># what type of cepa?</span>
    <span class="n">cepa_level</span> <span class="o">=</span> <span class="n">uppername</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;cepa(2)&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&quot;Error: </span><span class="si">%s</span><span class="s"> not implemented</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">lowername</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;dci&#39;</span><span class="p">):</span>
        <span class="n">cepa_level</span> <span class="o">=</span> <span class="s">&#39;CISD&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;sdci&#39;</span><span class="p">):</span>
        <span class="n">cepa_level</span> <span class="o">=</span> <span class="s">&#39;CISD&#39;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;fno-cepa(0)&#39;</span><span class="p">):</span>
        <span class="n">cepa_level</span> <span class="o">=</span> <span class="s">&#39;CEPA(0)&#39;</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span> <span class="s">&#39;NAT_ORBS&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;fno-cepa(1)&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span> <span class="s">&#39;NAT_ORBS&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">cepa_level</span> <span class="o">=</span> <span class="s">&#39;CEPA(1)&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;fno-cepa(3)&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span> <span class="s">&#39;NAT_ORBS&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">cepa_level</span> <span class="o">=</span> <span class="s">&#39;CEPA(3)&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;fno-acpf&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span> <span class="s">&#39;NAT_ORBS&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">cepa_level</span> <span class="o">=</span> <span class="s">&#39;ACPF&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;fno-aqcc&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span> <span class="s">&#39;NAT_ORBS&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">cepa_level</span> <span class="o">=</span> <span class="s">&#39;AQCC&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;fno-sdci&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span> <span class="s">&#39;NAT_ORBS&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">cepa_level</span> <span class="o">=</span> <span class="s">&#39;CISD&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;fno-dci&#39;</span><span class="p">):</span>
        <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span> <span class="s">&#39;NAT_ORBS&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">cepa_level</span> <span class="o">=</span> <span class="s">&#39;CISD&#39;</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span> <span class="s">&#39;CEPA_LEVEL&#39;</span><span class="p">,</span> <span class="n">cepa_level</span><span class="p">)</span>

    <span class="c"># throw an exception for open-shells</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span><span class="s">&#39;REFERENCE&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#39;RHF&#39;</span> <span class="p">):</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&quot;Error: </span><span class="si">%s</span><span class="s"> requires </span><span class="se">\&quot;</span><span class="s">reference rhf</span><span class="se">\&quot;</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="n">lowername</span><span class="p">)</span>

    <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;CCSD&#39;</span><span class="p">)</span>
    <span class="n">scf_helper</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c"># If the scf type is DF/CD, then the AO integrals were never written to disk</span>
    <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;DF&#39;</span> <span class="ow">or</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;SCF&#39;</span><span class="p">,</span> <span class="s">&#39;SCF_TYPE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;CD&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span> <span class="s">&#39;USE_DF_INTS&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">mints</span> <span class="o">=</span> <span class="n">psi4</span><span class="o">.</span><span class="n">MintsHelper</span><span class="p">()</span>
            <span class="n">mints</span><span class="o">.</span><span class="n">integrals</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;NAT_ORBS&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span> <span class="s">&#39;USE_DF_INTS&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s">&#39;TRANSQT2&#39;</span><span class="p">,</span> <span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="s">&#39;CCSD&#39;</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">transqt2</span><span class="p">()</span>

    <span class="c"># run cepa</span>
    <span class="n">psi4</span><span class="o">.</span><span class="n">fnocc</span><span class="p">()</span>

    <span class="c"># one-electron properties</span>
    <span class="k">if</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span> <span class="s">&#39;DIPMOM&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cepa_level</span> <span class="o">==</span> <span class="s">&quot;CEPA(1)&quot;</span> <span class="ow">or</span> <span class="n">cepa_level</span> <span class="o">==</span> <span class="s">&quot;CEPA(3)&quot;</span><span class="p">:</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&quot;    Error: one-electron properties not implemented for </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">lowername</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;FNOCC&#39;</span><span class="p">,</span><span class="s">&#39;NAT_ORBS&#39;</span><span class="p">):</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&quot;    Error: one-electron properties not implemented for </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">lowername</span><span class="p">)</span>
            <span class="n">psi4</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p4util</span><span class="o">.</span><span class="n">oeprop</span><span class="p">(</span><span class="s">&#39;DIPOLE&#39;</span><span class="p">,</span><span class="s">&#39;QUADRUPOLE&#39;</span><span class="p">,</span><span class="s">&#39;MULLIKEN_CHARGES&#39;</span><span class="p">,</span><span class="s">&#39;NO_OCCUPATIONS&#39;</span><span class="p">,</span><span class="n">title</span> <span class="o">=</span> <span class="n">cepa_level</span><span class="p">)</span>

    <span class="c"># restore options</span>
    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">psi4</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&quot;CURRENT ENERGY&quot;</span><span class="p">)</span>
</pre></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="../contents.html" title="Table Of Contents"
             >toc</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">PSI4 [beta5]</a> &raquo; </li>

          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    </div>

    <div class="footer">
        &copy; Copyright 2013, The Psi4 Project.
      Last updated on Jul 08, 2013.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
    <!-- cloud_sptheme 1.3 -->
  </body>
</html>