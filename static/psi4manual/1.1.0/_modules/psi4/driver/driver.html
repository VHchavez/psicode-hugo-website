<!-- 
#
# @BEGIN LICENSE
#
# Psi4: an open-source quantum chemistry software package
#
# Copyright (c) 2007-2017 The Psi4 Developers.
#
# The copyrights for code used from other parties are included in
# the corresponding files.
#
# This file is part of Psi4.
#
# Psi4 is free software; you can redistribute it and/or modify
# it under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation, version 3.
#
# Psi4 is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License along
# with Psi4; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
#
# @END LICENSE
# -->





<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>psi4.driver.driver</title>
    
    <link rel="stylesheet" href="../../../_static/psi4.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" type="text/css" />
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     'add49b9',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="../../../_static/cloud.js"></script>
    <link rel="shortcut icon" href="../../../_static/favicon-psi4.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body role="document">
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">Index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="../../../index.html" title="Table Of Contents"
             accesskey="C"><i class="fa fa-book fa-lg"></i></a> &nbsp; &nbsp;</li>
    <li><a href="http://psicode.org/"><i class="fa fa-home fa-lg"></i></a></li>
    <li><a href="http://github.com/psi4/psi4"><i class="fa fa-github fa-lg"></i></a></li>
    <li><a href="http://forum.psicode.org"><i class="fa fa-comments-o fa-lg"></i></a></li>
    <li><a href="https://github.com/psi4/psi4/edit/master/doc/sphinxman/source/_modules/psi4/driver/driver.rst"><i class="fa fa-pencil fa-lg"></i></a></li>
    <li style="color: #1a4162">&nbsp;&middot;&nbsp;</li>
    <li><a href="https://github.com/psi4/psi4/tree/add49b9">1.1</a></li>
    <li style="color: #1a4162">&nbsp;&middot;&nbsp;</li>
    <li class="nav-item nav-item-0"><a href="../../../index.html">
        <span style="font-family: Optima, sans-serif;">P<span style="font-size: 82%;">SI</span>4</span>
        </a><i class="fa fa-angle-double-right" style="color: #a2a7b3; text-shadow: none;"></i></li>

          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a><i class="fa fa-angle-double-right" style="color: #a2a7b3; text-shadow: none;"></i></li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for psi4.driver.driver</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># @BEGIN LICENSE</span>
<span class="c1">#</span>
<span class="c1"># Psi4: an open-source quantum chemistry software package</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2007-2017 The Psi4 Developers.</span>
<span class="c1">#</span>
<span class="c1"># The copyrights for code used from other parties are included in</span>
<span class="c1"># the corresponding files.</span>
<span class="c1">#</span>
<span class="c1"># This file is part of Psi4.</span>
<span class="c1">#</span>
<span class="c1"># Psi4 is free software; you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU Lesser General Public License as published by</span>
<span class="c1"># the Free Software Foundation, version 3.</span>
<span class="c1">#</span>
<span class="c1"># Psi4 is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU Lesser General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU Lesser General Public License along</span>
<span class="c1"># with Psi4; if not, write to the Free Software Foundation, Inc.,</span>
<span class="c1"># 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="c1">#</span>
<span class="c1"># @END LICENSE</span>
<span class="c1">#</span>

<span class="sd">&quot;&quot;&quot;Module with a *procedures* dictionary specifying available quantum</span>
<span class="sd">chemical methods and functions driving the main quantum chemical</span>
<span class="sd">functionality, namely single-point energies, geometry optimizations,</span>
<span class="sd">properties, and vibrational frequency calculations.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>

<span class="c1"># Import driver helpers</span>
<span class="kn">from</span> <span class="nn">psi4.driver</span> <span class="k">import</span> <span class="n">driver_util</span>
<span class="kn">from</span> <span class="nn">psi4.driver</span> <span class="k">import</span> <span class="n">driver_cbs</span>
<span class="kn">from</span> <span class="nn">psi4.driver</span> <span class="k">import</span> <span class="n">driver_nbody</span>
<span class="kn">from</span> <span class="nn">psi4.driver</span> <span class="k">import</span> <span class="n">p4util</span>
<span class="c1"># from psi4.driver.inputparser import parse_options_block</span>

<span class="kn">from</span> <span class="nn">psi4.driver.procrouting</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">psi4.driver.p4util.exceptions</span> <span class="k">import</span> <span class="o">*</span>
<span class="c1"># never import wrappers or aliases into this file</span>

<span class="k">def</span> <span class="nf">_find_derivative_type</span><span class="p">(</span><span class="n">ptype</span><span class="p">,</span> <span class="n">method_name</span><span class="p">,</span> <span class="n">user_dertype</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Figures out the derivative type (0, 1, 2) for a given method_name. Will</span>
<span class="sd">    first use user default and then the highest available derivative type for</span>
<span class="sd">    a given method.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">ptype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gradient&#39;</span><span class="p">,</span> <span class="s1">&#39;hessian&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;_find_derivative_type: ptype must either be gradient or hessian.&quot;</span><span class="p">)</span>

    <span class="n">dertype</span> <span class="o">=</span> <span class="s2">&quot;(auto)&quot;</span>

    <span class="c1"># If user type is None, try to find the highest derivative</span>
    <span class="k">if</span> <span class="n">user_dertype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ptype</span> <span class="o">==</span> <span class="s1">&#39;hessian&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">method_name</span> <span class="ow">in</span> <span class="n">procedures</span><span class="p">[</span><span class="s1">&#39;hessian&#39;</span><span class="p">]):</span>
            <span class="n">dertype</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="c1"># Will need special logic if we ever have managed Hessians</span>
        <span class="k">elif</span> <span class="n">method_name</span> <span class="ow">in</span> <span class="n">procedures</span><span class="p">[</span><span class="s1">&#39;gradient&#39;</span><span class="p">]:</span>
            <span class="n">dertype</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">procedures</span><span class="p">[</span><span class="s1">&#39;gradient&#39;</span><span class="p">][</span><span class="n">method_name</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;select_&#39;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">procedures</span><span class="p">[</span><span class="s1">&#39;gradient&#39;</span><span class="p">][</span><span class="n">method_name</span><span class="p">](</span><span class="n">method_name</span><span class="p">,</span> <span class="n">probe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">ManagedMethodError</span><span class="p">:</span>
                    <span class="n">dertype</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">method_name</span> <span class="ow">in</span> <span class="n">procedures</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]:</span>
            <span class="n">dertype</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Quick sanity check. Only *should* be able to be None or int, but hey, kids today...</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_dertype</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;_find_derivative_type: user_dertype should only be None or int!&quot;</span><span class="p">)</span>
        <span class="n">dertype</span> <span class="o">=</span> <span class="n">user_dertype</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s1">&#39;INTEGRAL_PACKAGE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;ERD&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dertype</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s1">&#39;INTEGRAL_PACKAGE ERD does not play nicely with derivatives, so stopping.&#39;</span><span class="p">)</span>

    <span class="c1"># Summary validation</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dertype</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">method_name</span> <span class="ow">in</span> <span class="n">procedures</span><span class="p">[</span><span class="s1">&#39;hessian&#39;</span><span class="p">]):</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">dertype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">method_name</span> <span class="ow">in</span> <span class="n">procedures</span><span class="p">[</span><span class="s1">&#39;gradient&#39;</span><span class="p">]):</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">dertype</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">method_name</span> <span class="ow">in</span> <span class="n">procedures</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]):</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">alternatives</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">alt_method_name</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">find_approximate_string_matches</span><span class="p">(</span><span class="n">method_name</span><span class="p">,</span> <span class="n">procedures</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt_method_name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">alternatives</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; Did you mean? </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">alt_method_name</span><span class="p">))</span>

        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Derivative method &#39;name&#39; </span><span class="si">%s</span><span class="s2"> and derivative level &#39;dertype&#39; </span><span class="si">%s</span><span class="s2"> are not available.</span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">method_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">dertype</span><span class="p">),</span> <span class="n">alternatives</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">dertype</span>

<div class="viewcode-block" id="energy"><a class="viewcode-back" href="../../../energy.html#psi4.driver.energy">[docs]</a><span class="k">def</span> <span class="nf">energy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Function to compute the single-point electronic energy.</span>

<span class="sd">    :returns: *float* |w--w| Total electronic energy in Hartrees. SAPT &amp; EFP return interaction energy.</span>

<span class="sd">    :returns: (*float*, :py:class:`~psi4.core.Wavefunction`) |w--w| energy and wavefunction when **return_wfn** specified.</span>

<span class="sd">    :PSI variables:</span>

<span class="sd">    .. hlist::</span>
<span class="sd">       :columns: 1</span>

<span class="sd">       * :psivar:`CURRENT ENERGY &lt;CURRENTENERGY&gt;`</span>
<span class="sd">       * :psivar:`CURRENT REFERENCE ENERGY &lt;CURRENTREFERENCEENERGY&gt;`</span>
<span class="sd">       * :psivar:`CURRENT CORRELATION ENERGY &lt;CURRENTCORRELATIONENERGY&gt;`</span>

<span class="sd">    :type name: string</span>
<span class="sd">    :param name: ``&#39;scf&#39;`` || ``&#39;mp2&#39;`` || ``&#39;ci5&#39;`` || etc.</span>

<span class="sd">        First argument, usually unlabeled. Indicates the computational method</span>
<span class="sd">        to be applied to the system.</span>

<span class="sd">    :type molecule: :ref:`molecule &lt;op_py_molecule&gt;`</span>
<span class="sd">    :param molecule: ``h2o`` || etc.</span>

<span class="sd">        The target molecule, if not the last molecule defined.</span>

<span class="sd">    :type return_wfn: :ref:`boolean &lt;op_py_boolean&gt;`</span>
<span class="sd">    :param return_wfn: ``&#39;on&#39;`` || |dl| ``&#39;off&#39;`` |dr|</span>

<span class="sd">        Indicate to additionally return the :py:class:`~psi4.core.Wavefunction`</span>
<span class="sd">        calculation result as the second element (after *float* energy) of a tuple.</span>

<span class="sd">    :type restart_file: string</span>
<span class="sd">    :param restart_file: ``[&#39;file.1, file.32]`` || ``./file`` || etc.</span>

<span class="sd">        Binary data files to be renamed for calculation restart.</span>

<span class="sd">    .. _`table:energy_gen`:</span>

<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | name                    | calls method                                                                                                  |</span>
<span class="sd">    +=========================+===============================================================================================================+</span>
<span class="sd">    | efp                     | effective fragment potential (EFP) :ref:`[manual] &lt;sec:libefp&gt;`                                               |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | scf                     | Hartree--Fock (HF) or density functional theory (DFT) :ref:`[manual] &lt;sec:scf&gt;`                               |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | hf                      | HF self consistent field (SCF) :ref:`[manual] &lt;sec:scf&gt;`                                                      |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | hf3c                    | HF with dispersion, BSSE, and basis set corrections :ref:`[manual] &lt;sec:gcp&gt;`                                 |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | pbeh3c                  | PBEh with dispersion, BSSE, and basis set corrections :ref:`[manual] &lt;sec:gcp&gt;`                               |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | dcft                    | density cumulant functional theory :ref:`[manual] &lt;sec:dcft&gt;`                                                 |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | mp2                     | 2nd-order |MollerPlesset| perturbation theory (MP2) :ref:`[manual] &lt;sec:dfmp2&gt;` :ref:`[details] &lt;tlmp2&gt;`      |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | mp3                     | 3rd-order |MollerPlesset| perturbation theory (MP3) :ref:`[manual] &lt;sec:occ_nonoo&gt;` :ref:`[details] &lt;tlmp3&gt;`  |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fno-mp3                 | MP3 with frozen natural orbitals :ref:`[manual] &lt;sec:fnocc&gt;`                                                  |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | mp2.5                   | average of MP2 and MP3 :ref:`[manual] &lt;sec:occ_nonoo&gt;` :ref:`[details] &lt;tlmp25&gt;`                              |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | mp4(sdq)                | 4th-order MP perturbation theory (MP4) less triples :ref:`[manual] &lt;sec:fnompn&gt;`                              |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fno-mp4(sdq)            | MP4 (less triples) with frozen natural orbitals :ref:`[manual] &lt;sec:fnocc&gt;`                                   |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | mp4                     | full MP4 :ref:`[manual] &lt;sec:fnompn&gt;` :ref:`[details] &lt;tlmp4&gt;`                                                |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fno-mp4                 | full MP4 with frozen natural orbitals :ref:`[manual] &lt;sec:fnocc&gt;`                                             |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | mp\ *n*                 | *n*\ th-order |MollerPlesset| (MP) perturbation theory :ref:`[manual] &lt;sec:arbpt&gt;`                            |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | zapt\ *n*               | *n*\ th-order z-averaged perturbation theory (ZAPT) :ref:`[manual] &lt;sec:arbpt&gt;`                               |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | omp2                    | orbital-optimized second-order MP perturbation theory :ref:`[manual] &lt;sec:occ_oo&gt;`                            |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | scs-omp2                | spin-component scaled OMP2 :ref:`[manual] &lt;sec:occ_oo&gt;`                                                       |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | scs(n)-omp2             | a special version of SCS-OMP2 for nucleobase interactions :ref:`[manual] &lt;sec:occ_oo&gt;`                        |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | scs-omp2-vdw            | a special version of SCS-OMP2 (from ethene dimers) :ref:`[manual] &lt;sec:occ_oo&gt;`                               |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sos-omp2                | spin-opposite scaled OMP2 :ref:`[manual] &lt;sec:occ_oo&gt;`                                                        |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sos-pi-omp2             | A special version of SOS-OMP2 for pi systems :ref:`[manual] &lt;sec:occ_oo&gt;`                                     |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | omp3                    | orbital-optimized third-order MP perturbation theory :ref:`[manual] &lt;sec:occ_oo&gt;`                             |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | scs-omp3                | spin-component scaled OMP3 :ref:`[manual] &lt;sec:occ_oo&gt;`                                                       |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | scs(n)-omp3             | a special version of SCS-OMP3 for nucleobase interactions :ref:`[manual] &lt;sec:occ_oo&gt;`                        |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | scs-omp3-vdw            | a special version of SCS-OMP3 (from ethene dimers) :ref:`[manual] &lt;sec:occ_oo&gt;`                               |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sos-omp3                | spin-opposite scaled OMP3 :ref:`[manual] &lt;sec:occ_oo&gt;`                                                        |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sos-pi-omp3             | A special version of SOS-OMP3 for pi systems :ref:`[manual] &lt;sec:occ_oo&gt;`                                     |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | omp2.5                  | orbital-optimized MP2.5 :ref:`[manual] &lt;sec:occ_oo&gt;`                                                          |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | lccsd, cepa(0)          | coupled electron pair approximation variant 0 :ref:`[manual] &lt;sec:fnocepa&gt;` :ref:`[details] &lt;tllccsd&gt;`        |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fno-lccsd, fno-cepa(0)  | CEPA(0) with frozen natural orbitals :ref:`[manual] &lt;sec:fnocc&gt;`                                              |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | cepa(1)                 | coupled electron pair approximation variant 1 :ref:`[manual] &lt;sec:fnocepa&gt;`                                   |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fno-cepa(1)             | CEPA(1) with frozen natural orbitals :ref:`[manual] &lt;sec:fnocc&gt;`                                              |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | cepa(3)                 | coupled electron pair approximation variant 3 :ref:`[manual] &lt;sec:fnocepa&gt;`                                   |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fno-cepa(3)             | CEPA(3) with frozen natural orbitals :ref:`[manual] &lt;sec:fnocc&gt;`                                              |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | acpf                    | averaged coupled-pair functional :ref:`[manual] &lt;sec:fnocepa&gt;`                                                |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fno-acpf                | ACPF with frozen natural orbitals :ref:`[manual] &lt;sec:fnocc&gt;`                                                 |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | aqcc                    | averaged quadratic coupled cluster :ref:`[manual] &lt;sec:fnocepa&gt;`                                              |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fno-aqcc                | AQCC with frozen natural orbitals :ref:`[manual] &lt;sec:fnocc&gt;`                                                 |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | qcisd                   | quadratic CI singles doubles (QCISD) :ref:`[manual] &lt;sec:fnocc&gt;`                                              |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fno-qcisd               | QCISD with frozen natural orbitals :ref:`[manual] &lt;sec:fnocc&gt;`                                                |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | lccd                    | Linear CCD :ref:`[manual] &lt;sec:occ_nonoo&gt;` :ref:`[details] &lt;tllccd&gt;`                                          |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fno-lccd                | LCCD with frozen natural orbitals :ref:`[manual] &lt;sec:fnocc&gt;`                                                 |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | olccd                   | orbital optimized LCCD :ref:`[manual] &lt;sec:occ_oo&gt;`                                                           |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | cc2                     | approximate coupled cluster singles and doubles (CC2) :ref:`[manual] &lt;sec:cc&gt;`                                |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | ccd                     | coupled cluster doubles  (CCD) :ref:`[manual] &lt;sec:occ_nonoo&gt;`                                                |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | ccsd                    | coupled cluster singles and doubles (CCSD) :ref:`[manual] &lt;sec:cc&gt;` :ref:`[details] &lt;tlccsd&gt;`                 |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | bccd                    | Brueckner coupled cluster doubles (BCCD) :ref:`[manual] &lt;sec:cc&gt;`                                             |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fno-ccsd                | CCSD with frozen natural orbitals :ref:`[manual] &lt;sec:fnocc&gt;`                                                 |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | qcisd(t)                | QCISD with perturbative triples :ref:`[manual] &lt;sec:fnocc&gt;`                                                   |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fno-qcisd(t)            | QCISD(T) with frozen natural orbitals :ref:`[manual] &lt;sec:fnocc&gt;`                                             |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | ccsd(t)                 | CCSD with perturbative triples (CCSD(T)) :ref:`[manual] &lt;sec:cc&gt;` :ref:`[details] &lt;tlccsdt&gt;`                  |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | ccsd(at)                | CCSD with asymmetric perturbative triples (CCSD(AT)) :ref:`[manual] &lt;sec:cc&gt;` :ref:`[details] &lt;tlccsdat&gt;`     |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | bccd(t)                 | BCCD with perturbative triples :ref:`[manual] &lt;sec:cc&gt;`                                                       |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fno-ccsd(t)             | CCSD(T) with frozen natural orbitals :ref:`[manual] &lt;sec:fnocc&gt;`                                              |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | cc3                     | approximate CC singles, doubles, and triples (CC3) :ref:`[manual] &lt;sec:cc&gt;`                                   |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | ccenergy                | **expert** full control over ccenergy module                                                                  |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | dfocc                   | **expert** full control over dfocc module                                                                     |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | cisd                    | configuration interaction (CI) singles and doubles (CISD) :ref:`[manual] &lt;sec:ci&gt;` :ref:`[details] &lt;tlcisd&gt;`  |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fno-cisd                | CISD with frozen natural orbitals :ref:`[manual] &lt;sec:fnocc&gt;`                                                 |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | cisdt                   | CI singles, doubles, and triples (CISDT) :ref:`[manual] &lt;sec:ci&gt;`                                             |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | cisdtq                  | CI singles, doubles, triples, and quadruples (CISDTQ) :ref:`[manual] &lt;sec:ci&gt;`                                |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | ci\ *n*                 | *n*\ th-order CI :ref:`[manual] &lt;sec:ci&gt;`                                                                     |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fci                     | full configuration interaction (FCI) :ref:`[manual] &lt;sec:ci&gt;`                                                 |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | detci                   | **expert** full control over detci module                                                                     |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | casscf                  | complete active space self consistent field (CASSCF)  :ref:`[manual] &lt;sec:ci&gt;`                                |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | rasscf                  | restricted active space self consistent field (RASSCF)  :ref:`[manual] &lt;sec:ci&gt;`                              |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | mcscf                   | multiconfigurational self consistent field (SCF) :ref:`[manual] &lt;sec:psimrcc&gt;`                                |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | psimrcc                 | Mukherjee multireference coupled cluster (Mk-MRCC) :ref:`[manual] &lt;sec:psimrcc&gt;`                              |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | dmrg-scf                | density matrix renormalization group SCF :ref:`[manual] &lt;sec:chemps2&gt;`                                        |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | dmrg-caspt2             | density matrix renormalization group CASPT2 :ref:`[manual] &lt;sec:chemps2&gt;`                                     |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | dmrg-ci                 | density matrix renormalization group CI :ref:`[manual] &lt;sec:chemps2&gt;`                                         |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt0                   | 0th-order symmetry adapted perturbation theory (SAPT) :ref:`[manual] &lt;sec:sapt&gt;`                              |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | ssapt0                  | 0th-order SAPT with special exchange scaling :ref:`[manual] &lt;sec:sapt&gt;`                                       |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fisapt0                 | 0th-order functional and/or intramolecular SAPT :ref:`[manual] &lt;sec:fisapt&gt;`                                  |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2                   | 2nd-order SAPT, traditional definition :ref:`[manual] &lt;sec:sapt&gt;`                                             |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+                  | SAPT including all 2nd-order terms :ref:`[manual] &lt;sec:sapt&gt;`                                                 |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+(3)               | SAPT including perturbative triples :ref:`[manual] &lt;sec:sapt&gt;`                                                |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+3                 | SAPT including all 3rd-order terms :ref:`[manual] &lt;sec:sapt&gt;`                                                 |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+(ccd)             | SAPT2+ with CC-based dispersion :ref:`[manual] &lt;sec:sapt&gt;`                                                    |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+(3)(ccd)          | SAPT2+(3) with CC-based dispersion :ref:`[manual] &lt;sec:sapt&gt;`                                                 |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+3(ccd)            | SAPT2+3 with CC-based dispersion :ref:`[manual] &lt;sec:sapt&gt;`                                                   |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+dmp2              | SAPT including all 2nd-order terms and MP2 correction :ref:`[manual] &lt;sec:sapt&gt;`                              |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+(3)dmp2           | SAPT including perturbative triples and MP2 correction :ref:`[manual] &lt;sec:sapt&gt;`                             |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+3dmp2             | SAPT including all 3rd-order terms and MP2 correction :ref:`[manual] &lt;sec:sapt&gt;`                              |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+(ccd)dmp2         | SAPT2+ with CC-based dispersion and MP2 correction :ref:`[manual] &lt;sec:sapt&gt;`                                 |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+(3)(ccd)dmp2      | SAPT2+(3) with CC-based dispersion and MP2 correction :ref:`[manual] &lt;sec:sapt&gt;`                              |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+3(ccd)dmp2        | SAPT2+3 with CC-based dispersion and MP2 correction :ref:`[manual] &lt;sec:sapt&gt;`                                |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt0-ct                | 0th-order SAPT plus charge transfer (CT) calculation :ref:`[manual] &lt;sec:saptct&gt;`                             |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2-ct                | SAPT2 plus CT :ref:`[manual] &lt;sec:saptct&gt;`                                                                    |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+-ct               | SAPT2+ plus CT :ref:`[manual] &lt;sec:saptct&gt;`                                                                   |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+(3)-ct            | SAPT2+(3) plus CT :ref:`[manual] &lt;sec:saptct&gt;`                                                                |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+3-ct              | SAPT2+3 plus CT :ref:`[manual] &lt;sec:saptct&gt;`                                                                  |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+(ccd)-ct          | SAPT2+(CCD) plus CT :ref:`[manual] &lt;sec:saptct&gt;`                                                              |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+(3)(ccd)-ct       | SAPT2+(3)(CCD) plus CT :ref:`[manual] &lt;sec:saptct&gt;`                                                           |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+3(ccd)-ct         | SAPT2+3(CCD) plus CT :ref:`[manual] &lt;sec:saptct&gt;`                                                             |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | adc                     | 2nd-order algebraic diagrammatic construction (ADC) :ref:`[manual] &lt;sec:adc&gt;`                                 |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | eom-cc2                 | EOM-CC2 :ref:`[manual] &lt;sec:eomcc&gt;`                                                                           |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | eom-ccsd                | equation of motion (EOM) CCSD :ref:`[manual] &lt;sec:eomcc&gt;`                                                     |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | eom-cc3                 | EOM-CC3 :ref:`[manual] &lt;sec:eomcc&gt;`                                                                           |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>

<span class="sd">    .. comment missing and why</span>
<span class="sd">    .. comment a certain isapt --- marginally released</span>
<span class="sd">    .. comment mrcc --- this is handled in its own table</span>
<span class="sd">    .. comment psimrcc_scf --- convenience fn</span>

<span class="sd">    .. include:: ../autodoc_dft_energy.rst</span>

<span class="sd">    .. include:: ../mrcc_table_energy.rst</span>

<span class="sd">    .. include:: ../cfour_table_energy.rst</span>

<span class="sd">    :examples:</span>

<span class="sd">    &gt;&gt;&gt; # [1] Coupled-cluster singles and doubles calculation with psi code</span>
<span class="sd">    &gt;&gt;&gt; energy(&#39;ccsd&#39;)</span>

<span class="sd">    &gt;&gt;&gt; # [2] Charge-transfer SAPT calculation with scf projection from small into</span>
<span class="sd">    &gt;&gt;&gt; #     requested basis, with specified projection fitting basis</span>
<span class="sd">    &gt;&gt;&gt; set basis_guess true</span>
<span class="sd">    &gt;&gt;&gt; set df_basis_guess jun-cc-pVDZ-JKFIT</span>
<span class="sd">    &gt;&gt;&gt; energy(&#39;sapt0-ct&#39;)</span>

<span class="sd">    &gt;&gt;&gt; # [3] Arbitrary-order MPn calculation</span>
<span class="sd">    &gt;&gt;&gt; energy(&#39;mp7&#39;)</span>

<span class="sd">    &gt;&gt;&gt; # [4] Converge scf as singlet, then run detci as triplet upon singlet reference</span>
<span class="sd">    &gt;&gt;&gt; # Note that the integral transformation is not done automatically when detci is run in a separate step.</span>
<span class="sd">    &gt;&gt;&gt; molecule H2 {\n0 1\nH\nH 1 0.74\n}</span>
<span class="sd">    &gt;&gt;&gt; set basis cc-pVDZ</span>
<span class="sd">    &gt;&gt;&gt; set reference rohf</span>
<span class="sd">    &gt;&gt;&gt; scf_e, scf_wfn = energy(&#39;scf&#39;, return_wfn=True)</span>
<span class="sd">    &gt;&gt;&gt; H2.set_multiplicity(3)</span>
<span class="sd">    &gt;&gt;&gt; core.MintsHelper(scf_wfn.basisset()).integrals()</span>
<span class="sd">    &gt;&gt;&gt; energy(&#39;detci&#39;, ref_wfn=scf_wfn)</span>

<span class="sd">    &gt;&gt;&gt; # [5] Run two CI calculations, keeping the integrals generated in the first one.</span>
<span class="sd">    &gt;&gt;&gt; molecule ne {\nNe\n}</span>
<span class="sd">    &gt;&gt;&gt; set basis cc-pVDZ</span>
<span class="sd">    &gt;&gt;&gt; cisd_e, cisd_wfn = energy(&#39;cisd&#39;, return_wfn=True)</span>
<span class="sd">    &gt;&gt;&gt; energy(&#39;fci&#39;, ref_wfn=cisd_wfn)</span>

<span class="sd">    &gt;&gt;&gt; # [6] Can automatically perform complete basis set extrapolations</span>
<span class="sd">    &gt;&gt;&gt; energy(&quot;CCSD/cc-pV[DT]Z&quot;)</span>

<span class="sd">    &gt;&gt;&gt; # [7] Can automatically perform delta corrections that include extrapolations</span>
<span class="sd">    &gt;&gt;&gt; # even with a user-defined extrapolation formula. See sample inputs named</span>
<span class="sd">    &gt;&gt;&gt; # cbs-xtpl* for more examples of this input style</span>
<span class="sd">    &gt;&gt;&gt; energy(&quot;MP2/aug-cc-pv([d,t]+d)z + d:ccsd(t)/cc-pvdz&quot;, corl_scheme=myxtplfn_2)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">kwargs_lower</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Bounce if name is function</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;__call__&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">name</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;custom function&#39;</span><span class="p">),</span> <span class="n">ptype</span><span class="o">=</span><span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Allow specification of methods to arbitrary order</span>
    <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">lowername</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="n">driver_util</span><span class="o">.</span><span class="n">parse_arbitrary_order</span><span class="p">(</span><span class="n">lowername</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">level</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level</span>

    <span class="c1"># Bounce to CP if bsse kwarg</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bsse_type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">driver_nbody</span><span class="o">.</span><span class="n">nbody_gufunc</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ptype</span><span class="o">=</span><span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Bounce to CBS if &quot;method/basis&quot; name</span>
    <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">lowername</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">driver_cbs</span><span class="o">.</span><span class="n">_cbs_gufunc</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ptype</span><span class="o">=</span><span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Commit to procedures[&#39;energy&#39;] call hereafter</span>
    <span class="n">return_wfn</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;return_wfn&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">core</span><span class="o">.</span><span class="n">clean_variables</span><span class="p">()</span>

    <span class="c1"># Make sure the molecule the user provided is the active one</span>
    <span class="n">molecule</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;molecule&#39;</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">())</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>

    <span class="c1">#for precallback in hooks[&#39;energy&#39;][&#39;pre&#39;]:</span>
    <span class="c1">#    precallback(lowername, **kwargs)</span>

    <span class="n">optstash</span> <span class="o">=</span> <span class="n">driver_util</span><span class="o">.</span><span class="n">_set_convergence_criterion</span><span class="p">(</span><span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="n">lowername</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

    <span class="c1"># Before invoking the procedure, we rename any file that should be read.</span>
    <span class="c1"># This is a workaround to do restarts with the current PSI4 capabilities</span>
    <span class="c1"># before actual, clean restarts are put in there</span>
    <span class="c1"># Restartfile is always converted to a single-element list if</span>
    <span class="c1"># it contains a single string</span>
    <span class="k">if</span> <span class="s1">&#39;restart_file&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">restartfile</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;restart_file&#39;</span><span class="p">]</span>  <span class="c1"># Option still available for procedure-specific action</span>
        <span class="k">if</span> <span class="n">restartfile</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">(</span><span class="n">restartfile</span><span class="p">):</span>
            <span class="n">restartfile</span> <span class="o">=</span> <span class="p">[</span><span class="n">restartfile</span><span class="p">]</span>
        <span class="c1"># Rename the files to be read to be consistent with psi4&#39;s file system</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">restartfile</span><span class="p">:</span>
            <span class="n">name_split</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\.&#39;</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
            <span class="n">filenum</span> <span class="o">=</span> <span class="n">name_split</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">name_split</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">filenum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">filenum</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">filenum</span> <span class="o">=</span> <span class="mi">32</span>  <span class="c1"># Default file number is the checkpoint one</span>
            <span class="n">psioh</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">IOManager</span><span class="o">.</span><span class="n">shared_object</span><span class="p">()</span>
            <span class="n">psio</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">shared_object</span><span class="p">()</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">psioh</span><span class="o">.</span><span class="n">get_file_path</span><span class="p">(</span><span class="n">filenum</span><span class="p">)</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">psio</span><span class="o">.</span><span class="n">get_default_namespace</span><span class="p">()</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;psi&#39;</span>
            <span class="n">targetfile</span> <span class="o">=</span> <span class="n">filepath</span> <span class="o">+</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">pid</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">namespace</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">filenum</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">targetfile</span><span class="p">)</span>

    <span class="n">wfn</span> <span class="o">=</span> <span class="n">procedures</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">][</span><span class="n">lowername</span><span class="p">](</span><span class="n">lowername</span><span class="p">,</span> <span class="n">molecule</span><span class="o">=</span><span class="n">molecule</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">postcallback</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">][</span><span class="s1">&#39;post&#39;</span><span class="p">]:</span>
        <span class="n">postcallback</span><span class="p">(</span><span class="n">lowername</span><span class="p">,</span> <span class="n">wfn</span><span class="o">=</span><span class="n">wfn</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">return_wfn</span><span class="p">:</span>  <span class="c1"># TODO current energy safer than wfn.energy() for now, but should be revisited</span>

        <span class="c1"># TODO place this with the associated call, very awkward to call this in other areas at the moment</span>
        <span class="k">if</span> <span class="n">lowername</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;efp&#39;</span><span class="p">,</span> <span class="s1">&#39;mrcc&#39;</span><span class="p">,</span> <span class="s1">&#39;dmrg&#39;</span><span class="p">,</span> <span class="s1">&#39;psimrcc&#39;</span><span class="p">]:</span>
            <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Warning! </span><span class="si">%s</span><span class="s2"> does not have an associated derived wavefunction.&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;The returned wavefunction is the incoming reference wavefunction.</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;sapt&#39;</span> <span class="ow">in</span> <span class="n">lowername</span><span class="p">:</span>
            <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Warning! </span><span class="si">%s</span><span class="s2"> does not have an associated derived wavefunction.&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;The returned wavefunction is the dimer SCF wavefunction.</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">),</span> <span class="n">wfn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="gradient"><a class="viewcode-back" href="../../../opt.html#psi4.driver.gradient">[docs]</a><span class="k">def</span> <span class="nf">gradient</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Function complementary to :py:func:~driver.optimize(). Carries out one gradient pass,</span>
<span class="sd">    deciding analytic or finite difference.</span>

<span class="sd">    :returns: :py:class:`~psi4.core.Matrix` |w--w| Total electronic gradient in Hartrees/Bohr.</span>

<span class="sd">    :returns: (:py:class:`~psi4.core.Matrix`, :py:class:`~psi4.core.Wavefunction`) |w--w| gradient and wavefunction when **return_wfn** specified.</span>

<span class="sd">    :examples:</span>

<span class="sd">    &gt;&gt;&gt; # [1] Single-point dft gradient getting the gradient</span>
<span class="sd">    &gt;&gt;&gt; #     in file, core.Matrix, and np.array forms</span>
<span class="sd">    &gt;&gt;&gt; set gradient_write on</span>
<span class="sd">    &gt;&gt;&gt; G, wfn = gradient(&#39;b3lyp-d&#39;, return_wfn=True)</span>
<span class="sd">    &gt;&gt;&gt; wfn.gradient().print_out()</span>
<span class="sd">    &gt;&gt;&gt; np.array(G)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">kwargs_lower</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Bounce to CP if bsse kwarg (someday)</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bsse_type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Gradient: Cannot specify bsse_type for gradient yet.&quot;</span><span class="p">)</span>

    <span class="c1"># Figure out what kind of gradient this is</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;__call__&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cbs&#39;</span><span class="p">,</span> <span class="s1">&#39;complete_basis_set&#39;</span><span class="p">]:</span>
            <span class="n">gradient_type</span> <span class="o">=</span> <span class="s1">&#39;cbs_wrapper&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Bounce to name if name is non-CBS function</span>
            <span class="n">gradient_type</span> <span class="o">=</span> <span class="s1">&#39;custom_function&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
        <span class="n">gradient_type</span> <span class="o">=</span> <span class="s1">&#39;cbs_gufunc&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gradient_type</span> <span class="o">=</span> <span class="s1">&#39;conventional&#39;</span>

    <span class="c1"># Figure out lowername, dertype, and func</span>
    <span class="c1"># If we have analytical gradients we want to pass to our wrappers, otherwise we want to run</span>
    <span class="c1"># finite-diference energy or cbs energies</span>
    <span class="c1"># TODO MP5/cc-pv[DT]Z behavior unkown due to &quot;levels&quot;</span>
    <span class="n">user_dertype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dertype&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gradient_type</span> <span class="o">==</span> <span class="s1">&#39;custom_function&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">user_dertype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dertype</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Gradient: Custom function passed in without a defined dertype, assuming fd-energy based gradient.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Gradient: Custom function passed in with a dertype of </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">user_dertype</span><span class="p">)</span>
            <span class="n">dertype</span> <span class="o">=</span> <span class="n">user_dertype</span>

        <span class="k">if</span> <span class="n">dertype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">name</span><span class="p">(</span><span class="n">gradient</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;custom function&#39;</span><span class="p">),</span> <span class="n">ptype</span><span class="o">=</span><span class="s1">&#39;gradient&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">optstash</span> <span class="o">=</span> <span class="n">driver_util</span><span class="o">.</span><span class="n">_set_convergence_criterion</span><span class="p">(</span><span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;scf&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
            <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">elif</span> <span class="n">gradient_type</span> <span class="o">==</span> <span class="s1">&#39;cbs_wrapper&#39;</span><span class="p">:</span>
        <span class="n">cbs_methods</span> <span class="o">=</span> <span class="n">driver_cbs</span><span class="o">.</span><span class="n">_cbs_wrapper_methods</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">dertype</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">_find_derivative_type</span><span class="p">(</span><span class="s1">&#39;gradient&#39;</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">user_dertype</span><span class="p">)</span> <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">cbs_methods</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">dertype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Bounce to CBS (directly) in pure-gradient mode if name is CBS and all parts have analytic grad. avail.</span>
            <span class="k">return</span> <span class="n">name</span><span class="p">(</span><span class="n">gradient</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;custom function&#39;</span><span class="p">),</span> <span class="n">ptype</span><span class="o">=</span><span class="s1">&#39;gradient&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">optstash</span> <span class="o">=</span> <span class="n">driver_util</span><span class="o">.</span><span class="n">_set_convergence_criterion</span><span class="p">(</span><span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="n">cbs_methods</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
            <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span>
            <span class="c1"># Pass through to G by E</span>

    <span class="k">elif</span> <span class="n">gradient_type</span> <span class="o">==</span> <span class="s1">&#39;cbs_gufunc&#39;</span><span class="p">:</span>
        <span class="n">cbs_methods</span> <span class="o">=</span> <span class="n">driver_cbs</span><span class="o">.</span><span class="n">_parse_cbs_gufunc_string</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dertype</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">_find_derivative_type</span><span class="p">(</span><span class="s1">&#39;gradient&#39;</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">user_dertype</span><span class="p">)</span> <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">cbs_methods</span><span class="p">])</span>
        <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dertype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Bounce to CBS in pure-gradient mode if &quot;method/basis&quot; name and all parts have analytic grad. avail.</span>
            <span class="k">return</span> <span class="n">driver_cbs</span><span class="o">.</span><span class="n">_cbs_gufunc</span><span class="p">(</span><span class="n">gradient</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ptype</span><span class="o">=</span><span class="s1">&#39;gradient&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Set method-dependent scf convergence criteria (test on procedures[&#39;energy&#39;] since that&#39;s guaranteed)</span>
            <span class="n">optstash</span> <span class="o">=</span> <span class="n">driver_util</span><span class="o">.</span><span class="n">_set_convergence_criterion</span><span class="p">(</span><span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="n">cbs_methods</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Allow specification of methods to arbitrary order</span>
        <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">lowername</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="n">driver_util</span><span class="o">.</span><span class="n">parse_arbitrary_order</span><span class="p">(</span><span class="n">lowername</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">level</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level</span>

        <span class="c1"># Prevent methods that do not have associated gradients</span>
        <span class="k">if</span> <span class="n">lowername</span> <span class="ow">in</span> <span class="n">energy_only_methods</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;gradient(&#39;</span><span class="si">%s</span><span class="s2">&#39;) does not have an associated gradient&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

        <span class="n">dertype</span> <span class="o">=</span> <span class="n">_find_derivative_type</span><span class="p">(</span><span class="s1">&#39;gradient&#39;</span><span class="p">,</span> <span class="n">lowername</span><span class="p">,</span> <span class="n">user_dertype</span><span class="p">)</span>

        <span class="c1"># Set method-dependent scf convergence criteria (test on procedures[&#39;energy&#39;] since that&#39;s guaranteed)</span>
        <span class="n">optstash</span> <span class="o">=</span> <span class="n">driver_util</span><span class="o">.</span><span class="n">_set_convergence_criterion</span><span class="p">(</span><span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="n">lowername</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

    <span class="c1"># Commit to procedures[] call hereafter</span>
    <span class="n">return_wfn</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;return_wfn&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">core</span><span class="o">.</span><span class="n">clean_variables</span><span class="p">()</span>

    <span class="c1"># no analytic derivatives for scf_type cd</span>
    <span class="k">if</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;SCF&#39;</span><span class="p">,</span> <span class="s1">&#39;SCF_TYPE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;CD&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dertype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;No analytic derivatives for SCF_TYPE CD.&quot;&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># Make sure the molecule the user provided is the active one</span>
    <span class="n">molecule</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;molecule&#39;</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">())</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>

    <span class="c1"># S/R: Mode of operation- whether finite difference opt run in one job or files farmed out</span>
    <span class="n">opt_mode</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;continuous&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">opt_mode</span> <span class="o">==</span> <span class="s1">&#39;continuous&#39;</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">opt_mode</span> <span class="o">==</span> <span class="s1">&#39;sow&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dertype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Optimize execution mode &#39;sow&#39; not valid for analytic gradient calculation.&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">opt_mode</span> <span class="o">==</span> <span class="s1">&#39;reap&#39;</span><span class="p">:</span>
        <span class="n">opt_linkage</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;linkage&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">opt_linkage</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Optimize execution mode &#39;reap&#39; requires a linkage option.&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Optimize execution mode &#39;</span><span class="si">%s</span><span class="s2">&#39; not valid.&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">opt_mode</span><span class="p">))</span>

    <span class="c1"># Does dertype indicate an analytic procedure both exists and is wanted?</span>
    <span class="k">if</span> <span class="n">dertype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;gradient() will perform analytic gradient computation.</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Perform the gradient calculation</span>
        <span class="n">wfn</span> <span class="o">=</span> <span class="n">procedures</span><span class="p">[</span><span class="s1">&#39;gradient&#39;</span><span class="p">][</span><span class="n">lowername</span><span class="p">](</span><span class="n">lowername</span><span class="p">,</span> <span class="n">molecule</span><span class="o">=</span><span class="n">molecule</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">return_wfn</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">wfn</span><span class="o">.</span><span class="n">gradient</span><span class="p">(),</span> <span class="n">wfn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">wfn</span><span class="o">.</span><span class="n">gradient</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;gradient() will perform gradient computation by finite difference of analytic energies.</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

        <span class="n">opt_iter</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;opt_iter&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">opt_iter</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">opt_iter</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">opt_iter</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Performing finite difference calculations&#39;</span><span class="p">)</span>

        <span class="c1"># Shifting the geometry so need to copy the active molecule</span>
        <span class="n">moleculeclone</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>

        <span class="c1"># Obtain list of displacements</span>
        <span class="c1"># print(&quot;about to generate displacements&quot;)</span>
        <span class="n">displacements</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">fd_geoms_1_0</span><span class="p">(</span><span class="n">moleculeclone</span><span class="p">)</span>
        <span class="c1"># print(displacements)</span>
        <span class="n">ndisp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">displacements</span><span class="p">)</span>
        <span class="c1"># print(&quot;generated displacments&quot;)</span>

        <span class="c1"># This version is pretty dependent on the reference geometry being last (as it is now)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot; </span><span class="si">%d</span><span class="s2"> displacements needed ...&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ndisp</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># S/R: Write instructions for sow/reap procedure to output file and reap input file</span>
        <span class="k">if</span> <span class="n">opt_mode</span> <span class="o">==</span> <span class="s1">&#39;sow&#39;</span><span class="p">:</span>
            <span class="n">instructionsO</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s2">    The optimization sow/reap procedure has been selected through mode=&#39;sow&#39;. In addition</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsO</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;    to this output file (which contains no quantum chemical calculations), this job</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsO</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;    has produced a number of input files (OPT-</span><span class="si">%s</span><span class="s2">-*.in) for individual components</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">opt_iter</span><span class="p">))</span>
            <span class="n">instructionsO</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;    and a single input file (OPT-master.in) with an optimize(mode=&#39;reap&#39;) command.</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsO</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;    These files may look very peculiar since they contain processed and pickled python</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsO</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;    rather than normal input. Follow the instructions in OPT-master.in to continue.</span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsO</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;    Alternatively, a single-job execution of the gradient may be accessed through</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsO</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;    the optimization wrapper option mode=&#39;continuous&#39;.</span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">instructionsO</span><span class="p">)</span>

            <span class="n">instructionsM</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s2">#    Follow the instructions below to carry out this optimization cycle.</span><span class="se">\n</span><span class="s2">#</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#    (1)  Run all of the OPT-</span><span class="si">%s</span><span class="s2">-*.in input files on any variety of computer architecture.</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">opt_iter</span><span class="p">))</span>
            <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#       The output file names must be as given below.</span><span class="se">\n</span><span class="s2">#</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">rgt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndisp</span><span class="p">):</span>
                <span class="n">pre</span> <span class="o">=</span> <span class="s1">&#39;OPT-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">opt_iter</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rgt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#             psi4 -i </span><span class="si">%-27s</span><span class="s2"> -o </span><span class="si">%-27s</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pre</span> <span class="o">+</span> <span class="s1">&#39;.in&#39;</span><span class="p">,</span> <span class="n">pre</span> <span class="o">+</span> <span class="s1">&#39;.out&#39;</span><span class="p">)</span>
            <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#</span><span class="se">\n</span><span class="s2">#    (2)  Gather all the resulting output files in a directory. Place input file</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#         OPT-master.in into that directory and run it. The job will be minimal in</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#         length and give summary results for the gradient step in its output file.</span><span class="se">\n</span><span class="s2">#</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">opt_iter</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#             psi4 -i </span><span class="si">%-27s</span><span class="s2"> -o </span><span class="si">%-27s</span><span class="se">\n</span><span class="s2">#</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;OPT-master.in&#39;</span><span class="p">,</span> <span class="s1">&#39;OPT-master.out&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#             psi4 -a -i </span><span class="si">%-27s</span><span class="s2"> -o </span><span class="si">%-27s</span><span class="se">\n</span><span class="s2">#</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;OPT-master.in&#39;</span><span class="p">,</span> <span class="s1">&#39;OPT-master.out&#39;</span><span class="p">)</span>
            <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#    After each optimization iteration, the OPT-master.in file is overwritten so return here</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#    for new instructions. With the use of the psi4 -a flag, OPT-master.out is not</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#    overwritten and so maintains a history of the job. To use the (binary) optimizer</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#    data file to accelerate convergence, the OPT-master jobs must run on the same computer.</span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;OPT-master.in&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fmaster</span><span class="p">:</span>
                <span class="n">fmaster</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# This is a psi4 input file auto-generated from the gradient() wrapper.</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                <span class="n">fmaster</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">p4util</span><span class="o">.</span><span class="n">format_molecule_for_input</span><span class="p">(</span><span class="n">moleculeclone</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                <span class="n">fmaster</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">p4util</span><span class="o">.</span><span class="n">format_options_for_input</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                <span class="n">p4util</span><span class="o">.</span><span class="n">format_kwargs_for_input</span><span class="p">(</span><span class="n">fmaster</span><span class="p">,</span> <span class="n">lmode</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">return_wfn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dertype</span><span class="o">=</span><span class="n">dertype</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">fmaster</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s2">&quot;&quot;&quot;retE, retwfn = optimize(&#39;</span><span class="si">%s</span><span class="s2">&#39;, **kwargs)</span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lowername</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                <span class="n">fmaster</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">instructionsM</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">displacement</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">displacements</span><span class="p">):</span>
            <span class="n">rfile</span> <span class="o">=</span> <span class="s1">&#39;OPT-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">opt_iter</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Build string of title banner</span>
            <span class="n">banners</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">banners</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;core.print_out(&#39;</span><span class="se">\\</span><span class="s2">n&#39;)</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">banners</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;p4util.banner(&#39; Gradient </span><span class="si">%d</span><span class="s2"> Computation: Displacement </span><span class="si">%d</span><span class="s2"> &#39;)</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">opt_iter</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">banners</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;core.print_out(&#39;</span><span class="se">\\</span><span class="s2">n&#39;)</span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="n">opt_mode</span> <span class="o">==</span> <span class="s1">&#39;continuous&#39;</span><span class="p">:</span>

                <span class="c1"># print progress to file and screen</span>
                <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s1">&#39;Loading displacement </span><span class="si">%d</span><span class="s1"> of </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndisp</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot; </span><span class="si">%d</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">ndisp</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

                <span class="c1"># Load in displacement into the active molecule</span>
                <span class="n">moleculeclone</span><span class="o">.</span><span class="n">set_geometry</span><span class="p">(</span><span class="n">displacement</span><span class="p">)</span>

                <span class="c1"># Perform the energy calculation</span>
                <span class="n">E</span><span class="p">,</span> <span class="n">wfn</span> <span class="o">=</span> <span class="n">energy</span><span class="p">(</span><span class="n">lowername</span><span class="p">,</span> <span class="n">return_wfn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">molecule</span><span class="o">=</span><span class="n">moleculeclone</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">))</span>

            <span class="c1"># S/R: Write each displaced geometry to an input file</span>
            <span class="k">elif</span> <span class="n">opt_mode</span> <span class="o">==</span> <span class="s1">&#39;sow&#39;</span><span class="p">:</span>
                <span class="n">moleculeclone</span><span class="o">.</span><span class="n">set_geometry</span><span class="p">(</span><span class="n">displacement</span><span class="p">)</span>

                <span class="c1"># S/R: Prepare molecule, options, and kwargs</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.in&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rfile</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">freagent</span><span class="p">:</span>
                    <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# This is a psi4 input file auto-generated from the gradient() wrapper.</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                    <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">p4util</span><span class="o">.</span><span class="n">format_molecule_for_input</span><span class="p">(</span><span class="n">moleculeclone</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                    <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">p4util</span><span class="o">.</span><span class="n">format_options_for_input</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                    <span class="n">p4util</span><span class="o">.</span><span class="n">format_kwargs_for_input</span><span class="p">(</span><span class="n">freagent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                    <span class="c1"># S/R: Prepare function call and energy save</span>
                    <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s2">&quot;&quot;&quot;electronic_energy = energy(&#39;</span><span class="si">%s</span><span class="s2">&#39;, **kwargs)</span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lowername</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                    <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s2">&quot;&quot;&quot;core.print_out(&#39;</span><span class="se">\\</span><span class="s2">nGRADIENT RESULT: computation </span><span class="si">%d</span><span class="s2"> for item </span><span class="si">%d</span><span class="s2"> &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                    <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;yields electronic energy </span><span class="si">%20.12f</span><span class="se">\\</span><span class="s2">n&#39; % (electronic_energy))</span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

            <span class="c1"># S/R: Read energy from each displaced geometry output file and save in energies array</span>
            <span class="k">elif</span> <span class="n">opt_mode</span> <span class="o">==</span> <span class="s1">&#39;reap&#39;</span><span class="p">:</span>
                <span class="n">exec</span><span class="p">(</span><span class="n">banners</span><span class="p">)</span>
                <span class="n">core</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s1">&#39;NUCLEAR REPULSION ENERGY&#39;</span><span class="p">,</span> <span class="n">moleculeclone</span><span class="o">.</span><span class="n">nuclear_repulsion_energy</span><span class="p">())</span>
                <span class="n">energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p4util</span><span class="o">.</span><span class="n">extract_sowreap_from_output</span><span class="p">(</span><span class="n">rfile</span><span class="p">,</span> <span class="s1">&#39;GRADIENT&#39;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">opt_linkage</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>

        <span class="c1"># S/R: Quit sow after writing files. Initialize skeleton wfn to receive grad for reap</span>
        <span class="k">if</span> <span class="n">opt_mode</span> <span class="o">==</span> <span class="s1">&#39;sow&#39;</span><span class="p">:</span>
            <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">return_wfn</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># any point to building a dummy wfn here?</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">opt_mode</span> <span class="o">==</span> <span class="s1">&#39;reap&#39;</span><span class="p">:</span>
            <span class="n">core</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">,</span> <span class="n">energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">wfn</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Wavefunction</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s1">&#39;BASIS&#39;</span><span class="p">))</span>

        <span class="c1"># Compute the gradient; last item in &#39;energies&#39; is undisplaced</span>
        <span class="n">core</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s1">&#39;FINDIF&#39;</span><span class="p">,</span> <span class="s1">&#39;GRADIENT_WRITE&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">fd_1_0</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">energies</span><span class="p">)</span>
        <span class="n">G</span><span class="o">.</span><span class="n">print_out</span><span class="p">()</span>
        <span class="n">wfn</span><span class="o">.</span><span class="n">set_gradient</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>

        <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">return_wfn</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">wfn</span><span class="o">.</span><span class="n">gradient</span><span class="p">(),</span> <span class="n">wfn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">wfn</span><span class="o">.</span><span class="n">gradient</span><span class="p">()</span></div>


<div class="viewcode-block" id="property"><a class="viewcode-back" href="../../../prop.html#psi4.driver.property">[docs]</a><span class="k">def</span> <span class="nf">property</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Function to compute various properties.</span>

<span class="sd">    :aliases: prop()</span>

<span class="sd">    :returns: none.</span>

<span class="sd">    .. caution:: Some features are not yet implemented. Buy a developer a coffee.</span>

<span class="sd">       - This function at present has a limited functionality.</span>
<span class="sd">         Consult the keywords sections of other modules for further property capabilities.</span>

<span class="sd">    +--------------------+-----------------------------------------------+----------------+---------------------------------------------------------------+</span>
<span class="sd">    | Name               | Calls Method                                  | Reference      | Supported Properties                                          |</span>
<span class="sd">    +====================+===============================================+================+===============================================================+</span>
<span class="sd">    | scf                | Self-consistent field method(s)               | RHF/ROHF/UHF   | Listed :ref:`here &lt;sec:oeprop&gt;`                               |</span>
<span class="sd">    +--------------------+-----------------------------------------------+----------------+---------------------------------------------------------------+</span>
<span class="sd">    | hf                 | HF Self-consistent field method(s)            | RHF/ROHF/UHF   | Listed :ref:`here &lt;sec:oeprop&gt;`                               |</span>
<span class="sd">    +--------------------+-----------------------------------------------+----------------+---------------------------------------------------------------+</span>
<span class="sd">    | mp2                | MP2 with density fitting only (mp2_type df)   | RHF            | Listed :ref:`here &lt;sec:oeprop&gt;`                               |</span>
<span class="sd">    +--------------------+-----------------------------------------------+----------------+---------------------------------------------------------------+</span>
<span class="sd">    | cc2                | 2nd-order approximate CCSD                    | RHF            | dipole, quadrupole, polarizability, rotation, roa_tensor      |</span>
<span class="sd">    +--------------------+-----------------------------------------------+----------------+---------------------------------------------------------------+</span>
<span class="sd">    | ccsd               | Coupled cluster singles and doubles (CCSD)    | RHF            | dipole, quadrupole, polarizability, rotation, roa_tensor      |</span>
<span class="sd">    +--------------------+-----------------------------------------------+----------------+---------------------------------------------------------------+</span>
<span class="sd">    | eom-cc2            | 2nd-order approximate EOM-CCSD                | RHF            | oscillator_strength, rotational_strength                      |</span>
<span class="sd">    +--------------------+-----------------------------------------------+----------------+---------------------------------------------------------------+</span>
<span class="sd">    | eom-ccsd           | Equation-of-motion CCSD (EOM-CCSD)            | RHF            | oscillator_strength, rotational_strength                      |</span>
<span class="sd">    +--------------------+-----------------------------------------------+----------------+---------------------------------------------------------------+</span>
<span class="sd">    | cisd, cisdt,       | Configuration interaction                     | RHF/ROHF       | Listed :ref:`here &lt;sec:oeprop&gt;`, transition_dipole,           |</span>
<span class="sd">    | cisdt, cisdtq,     |                                               |                | transition_quadrupole                                         |</span>
<span class="sd">    | ci5, ..., fci      |                                               |                |                                                               |</span>
<span class="sd">    +--------------------+-----------------------------------------------+----------------+---------------------------------------------------------------+</span>
<span class="sd">    | casscf, rasscf     | Multi-configurational SCF                     | RHF/ROHF       | Listed :ref:`here &lt;sec:oeprop&gt;`, transition_dipole,           |</span>
<span class="sd">    |                    |                                               |                | transition_quadrupole                                         |</span>
<span class="sd">    +--------------------+-----------------------------------------------+----------------+---------------------------------------------------------------+</span>

<span class="sd">    :type name: string</span>
<span class="sd">    :param name: ``&#39;ccsd&#39;`` || etc.</span>

<span class="sd">        First argument, usually unlabeled. Indicates the computational method</span>
<span class="sd">        to be applied to the system.</span>

<span class="sd">    :type properties: array of strings</span>
<span class="sd">    :param properties: |dl| ``[]`` |dr| || ``[&#39;rotation&#39;, &#39;polarizability&#39;, &#39;oscillator_strength&#39;, &#39;roa&#39;]`` || etc.</span>

<span class="sd">        Indicates which properties should be computed. Defaults to dipole and quadrupole.</span>

<span class="sd">    :type molecule: :ref:`molecule &lt;op_py_molecule&gt;`</span>
<span class="sd">    :param molecule: ``h2o`` || etc.</span>

<span class="sd">        The target molecule, if not the last molecule defined.</span>

<span class="sd">    :examples:</span>

<span class="sd">    &gt;&gt;&gt; # [1] Optical rotation calculation</span>
<span class="sd">    &gt;&gt;&gt; property(&#39;cc2&#39;, properties=[&#39;rotation&#39;])</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">kwargs_lower</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">return_wfn</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;return_wfn&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Make sure the molecule the user provided is the active one</span>
    <span class="n">molecule</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;molecule&#39;</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">())</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>

    <span class="c1"># Allow specification of methods to arbitrary order</span>
    <span class="n">lowername</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="n">driver_util</span><span class="o">.</span><span class="n">parse_arbitrary_order</span><span class="p">(</span><span class="n">lowername</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">level</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level</span>

    <span class="n">properties</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;properties&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;dipole&#39;</span><span class="p">,</span> <span class="s1">&#39;quadrupole&#39;</span><span class="p">])</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>

    <span class="n">optstash</span> <span class="o">=</span> <span class="n">driver_util</span><span class="o">.</span><span class="n">_set_convergence_criterion</span><span class="p">(</span><span class="s1">&#39;property&#39;</span><span class="p">,</span> <span class="n">lowername</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">wfn</span> <span class="o">=</span> <span class="n">procedures</span><span class="p">[</span><span class="s1">&#39;property&#39;</span><span class="p">][</span><span class="n">lowername</span><span class="p">](</span><span class="n">lowername</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">return_wfn</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">),</span> <span class="n">wfn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="optimize"><a class="viewcode-back" href="../../../opt.html#psi4.driver.optimize">[docs]</a><span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Function to perform a geometry optimization.</span>

<span class="sd">    :aliases: opt()</span>

<span class="sd">    :returns: *float* |w--w| Total electronic energy of optimized structure in Hartrees.</span>

<span class="sd">    :returns: (*float*, :py:class:`~psi4.core.Wavefunction`) |w--w| energy and wavefunction when **return_wfn** specified.</span>

<span class="sd">    :raises: psi4.ConvergenceError if |optking__geom_maxiter| exceeded without reaching geometry convergence.</span>

<span class="sd">    :PSI variables:</span>

<span class="sd">    .. hlist::</span>
<span class="sd">       :columns: 1</span>

<span class="sd">       * :psivar:`CURRENT ENERGY &lt;CURRENTENERGY&gt;`</span>

<span class="sd">    :type name: string</span>
<span class="sd">    :param name: ``&#39;scf&#39;`` || ``&#39;mp2&#39;`` || ``&#39;ci5&#39;`` || etc.</span>

<span class="sd">        First argument, usually unlabeled. Indicates the computational method</span>
<span class="sd">        to be applied to the database. May be any valid argument to</span>
<span class="sd">        :py:func:`~driver.energy`.</span>

<span class="sd">    :type molecule: :ref:`molecule &lt;op_py_molecule&gt;`</span>
<span class="sd">    :param molecule: ``h2o`` || etc.</span>

<span class="sd">        The target molecule, if not the last molecule defined.</span>

<span class="sd">    :type return_wfn: :ref:`boolean &lt;op_py_boolean&gt;`</span>
<span class="sd">    :param return_wfn: ``&#39;on&#39;`` || |dl| ``&#39;off&#39;`` |dr|</span>

<span class="sd">        Indicate to additionally return the :py:class:`~psi4.core.Wavefunction`</span>
<span class="sd">        calculation result as the second element (after *float* energy) of a tuple.</span>

<span class="sd">    :type func: :ref:`function &lt;op_py_function&gt;`</span>
<span class="sd">    :param func: |dl| ``gradient`` |dr| || ``energy`` || ``cbs``</span>

<span class="sd">        Indicates the type of calculation to be performed on the molecule.</span>
<span class="sd">        The default dertype accesses ``&#39;gradient&#39;`` or ``&#39;energy&#39;``, while</span>
<span class="sd">        ``&#39;cbs&#39;`` performs a multistage finite difference calculation.</span>
<span class="sd">        If a nested series of python functions is intended (see :ref:`sec:intercalls`),</span>
<span class="sd">        use keyword ``opt_func`` instead of ``func``.</span>

<span class="sd">    :type mode: string</span>
<span class="sd">    :param mode: |dl| ``&#39;continuous&#39;`` |dr| || ``&#39;sow&#39;`` || ``&#39;reap&#39;``</span>

<span class="sd">        For a finite difference of energies optimization, indicates whether</span>
<span class="sd">        the calculations required to complete the</span>
<span class="sd">        optimization are to be run in one file (``&#39;continuous&#39;``) or are to be</span>
<span class="sd">        farmed out in an embarrassingly parallel fashion</span>
<span class="sd">        (``&#39;sow&#39;``/``&#39;reap&#39;``). For the latter, run an initial job with</span>
<span class="sd">        ``&#39;sow&#39;`` and follow instructions in its output file. For maximum</span>
<span class="sd">        flexibility, ``return_wfn`` is always on in ``&#39;reap&#39;`` mode.</span>

<span class="sd">    :type dertype: :ref:`dertype &lt;op_py_dertype&gt;`</span>
<span class="sd">    :param dertype: ``&#39;gradient&#39;`` || ``&#39;energy&#39;``</span>

<span class="sd">        Indicates whether analytic (if available) or finite difference</span>
<span class="sd">        optimization is to be performed.</span>

<span class="sd">    :type hessian_with: string</span>
<span class="sd">    :param hessian_with: ``&#39;scf&#39;`` || ``&#39;mp2&#39;`` || etc.</span>

<span class="sd">        Indicates the computational method with which to perform a hessian</span>
<span class="sd">        analysis to guide the geometry optimization.</span>

<span class="sd">    .. warning:: Optimizations where the molecule is specified in Z-matrix format</span>
<span class="sd">       with dummy atoms will result in the geometry being converted to a Cartesian representation.</span>

<span class="sd">    .. note:: Analytic gradients area available for all methods in the table</span>
<span class="sd">        below. Optimizations with other methods in the energy table proceed</span>
<span class="sd">        by finite differences.</span>

<span class="sd">    .. _`table:grad_gen`:</span>

<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | name                    | calls method                                                                                                  |</span>
<span class="sd">    +=========================+===============================================================================================================+</span>
<span class="sd">    | efp                     | efp-only optimizations                                                                                        |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | scf                     | Hartree--Fock (HF) or density functional theory (DFT) :ref:`[manual] &lt;sec:scf&gt;`                               |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | hf                      | HF self consistent field (SCF) :ref:`[manual] &lt;sec:scf&gt;`                                                      |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | dcft                    | density cumulant functional theory :ref:`[manual] &lt;sec:dcft&gt;`                                                 |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | mp2                     | 2nd-order |MollerPlesset| perturbation theory (MP2) :ref:`[manual] &lt;sec:dfmp2&gt;` :ref:`[details] &lt;tlmp2&gt;`      |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | mp3                     | 3rd-order |MollerPlesset| perturbation theory (MP3) :ref:`[manual] &lt;sec:occ_nonoo&gt;` :ref:`[details] &lt;tlmp3&gt;`  |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | mp2.5                   | average of MP2 and MP3 :ref:`[manual] &lt;sec:occ_nonoo&gt;` :ref:`[details] &lt;tlmp25&gt;`                              |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | omp2                    | orbital-optimized second-order MP perturbation theory :ref:`[manual] &lt;sec:occ_oo&gt;`                            |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | omp3                    | orbital-optimized third-order MP perturbation theory :ref:`[manual] &lt;sec:occ_oo&gt;`                             |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | omp2.5                  | orbital-optimized MP2.5 :ref:`[manual] &lt;sec:occ_oo&gt;`                                                          |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | lccd                    | Linear CCD :ref:`[manual] &lt;sec:occ_nonoo&gt;` :ref:`[details] &lt;tllccd&gt;`                                          |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | olccd                   | orbital optimized LCCD :ref:`[manual] &lt;sec:occ_oo&gt;`                                                           |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | ccd                     | coupled cluster doubles  (CCD) :ref:`[manual] &lt;sec:occ_nonoo&gt;`                                                |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | ccsd                    | coupled cluster singles and doubles (CCSD) :ref:`[manual] &lt;sec:cc&gt;` :ref:`[details] &lt;tlccsd&gt;`                 |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | ccsd(t)                 | CCSD with perturbative triples (CCSD(T)) :ref:`[manual] &lt;sec:cc&gt;` :ref:`[details] &lt;tlccsdt&gt;`                  |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | eom-ccsd                | equation of motion (EOM) CCSD :ref:`[manual] &lt;sec:eomcc&gt;`                                                     |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>

<span class="sd">    .. _`table:grad_scf`:</span>


<span class="sd">    .. include:: ../autodoc_dft_opt.rst</span>

<span class="sd">    .. include:: ../cfour_table_grad.rst</span>


<span class="sd">    :examples:</span>

<span class="sd">    &gt;&gt;&gt; # [1] Analytic hf optimization</span>
<span class="sd">    &gt;&gt;&gt; optimize(&#39;hf&#39;)</span>

<span class="sd">    &gt;&gt;&gt; # [2] Finite difference mp5 optimization with gradient</span>
<span class="sd">    &gt;&gt;&gt; #     printed to output file</span>
<span class="sd">    &gt;&gt;&gt; e, wfn = opt(&#39;mp5&#39;, return_wfn=&#39;yes&#39;)</span>
<span class="sd">    &gt;&gt;&gt; wfn.gradient().print_out()</span>

<span class="sd">    &gt;&gt;&gt; # [3] Forced finite difference hf optimization run in</span>
<span class="sd">    &gt;&gt;&gt; #     embarrassingly parallel fashion</span>
<span class="sd">    &gt;&gt;&gt; optimize(&#39;hf&#39;, dertype=&#39;energy&#39;, mode=&#39;sow&#39;)</span>

<span class="sd">    &gt;&gt;&gt; # [4] Can automatically perform complete basis set extrapolations</span>
<span class="sd">    &gt;&gt;&gt; optimize(&#39;MP2/cc-pV([D,T]+d)Z&#39;)</span>

<span class="sd">    &gt;&gt;&gt; # [5] Can automatically perform delta corrections that include extrapolations</span>
<span class="sd">    &gt;&gt;&gt; # even with a user-defined extrapolation formula. See sample inputs named</span>
<span class="sd">    &gt;&gt;&gt; # cbs-xtpl* for more examples of this input style</span>
<span class="sd">    &gt;&gt;&gt; optimize(&quot;MP2/aug-cc-pv([d,t]+d)z + d:ccsd(t)/cc-pvdz&quot;, corl_scheme=myxtplfn_2)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">kwargs_lower</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;__call__&#39;</span><span class="p">):</span>
        <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">custom_gradient</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">custom_gradient</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">return_wfn</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;return_wfn&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># For CBS wrapper, need to set retention on INTCO file</span>
    <span class="k">if</span> <span class="n">custom_gradient</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">lowername</span><span class="p">):</span>
        <span class="n">core</span><span class="o">.</span><span class="n">IOManager</span><span class="o">.</span><span class="n">shared_object</span><span class="p">()</span><span class="o">.</span><span class="n">set_specific_retention</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bsse_type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Optimize: Does not currently support &#39;bsse_type&#39; arguements&quot;</span><span class="p">)</span>

    <span class="n">full_hess_every</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;OPTKING&#39;</span><span class="p">,</span> <span class="s1">&#39;FULL_HESS_EVERY&#39;</span><span class="p">)</span>
    <span class="n">steps_since_last_hessian</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">custom_gradient</span> <span class="ow">and</span> <span class="n">core</span><span class="o">.</span><span class="n">has_option_changed</span><span class="p">(</span><span class="s1">&#39;OPTKING&#39;</span><span class="p">,</span> <span class="s1">&#39;FULL_HESS_EVERY&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Optimize: Does not support custom Hessian&#39;s yet.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hessian_with_method</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hessian_with&#39;</span><span class="p">,</span> <span class="n">lowername</span><span class="p">)</span>

    <span class="c1"># are we in sow/reap mode?</span>
    <span class="n">opt_mode</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;continuous&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">opt_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;continuous&#39;</span><span class="p">,</span> <span class="s1">&#39;sow&#39;</span><span class="p">,</span> <span class="s1">&#39;reap&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Optimize execution mode &#39;</span><span class="si">%s</span><span class="s2">&#39; not valid.&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">opt_mode</span><span class="p">))</span>

    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s1">&#39;OPTKING&#39;</span><span class="p">,</span> <span class="s1">&#39;INTRAFRAG_STEP_LIMIT&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;FINDIF&#39;</span><span class="p">,</span> <span class="s1">&#39;HESSIAN_WRITE&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;OPTKING&#39;</span><span class="p">,</span> <span class="s1">&#39;CART_HESS_READ&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;SCF&#39;</span><span class="p">,</span> <span class="s1">&#39;GUESS_PERSIST&#39;</span><span class="p">],</span>  <span class="c1"># handle on behalf of cbs()</span>
        <span class="p">[</span><span class="s1">&#39;SCF&#39;</span><span class="p">,</span> <span class="s1">&#39;GUESS&#39;</span><span class="p">])</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;opt_iter&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Make sure the molecule the user provided is the active one</span>
    <span class="n">molecule</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;molecule&#39;</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">())</span>

    <span class="c1"># If we are feezing cartesian, do not orient or COM</span>
    <span class="k">if</span> <span class="n">core</span><span class="o">.</span><span class="n">get_local_option</span><span class="p">(</span><span class="s2">&quot;OPTKING&quot;</span><span class="p">,</span> <span class="s2">&quot;FROZEN_CARTESIAN&quot;</span><span class="p">):</span>
        <span class="n">molecule</span><span class="o">.</span><span class="n">fix_orientation</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">molecule</span><span class="o">.</span><span class="n">fix_com</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>

    <span class="c1"># Shifting the geometry so need to copy the active molecule</span>
    <span class="n">moleculeclone</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>

    <span class="n">initial_sym</span> <span class="o">=</span> <span class="n">moleculeclone</span><span class="o">.</span><span class="n">schoenflies_symbol</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;OPTKING&#39;</span><span class="p">,</span> <span class="s1">&#39;GEOM_MAXITER&#39;</span><span class="p">):</span>
        <span class="n">current_sym</span> <span class="o">=</span> <span class="n">moleculeclone</span><span class="o">.</span><span class="n">schoenflies_symbol</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">initial_sym</span> <span class="o">!=</span> <span class="n">current_sym</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Point group changed! (</span><span class="si">%s</span><span class="s2"> &lt;-- </span><span class="si">%s</span><span class="s2">) You should restart &quot;&quot;&quot;</span>
                                  <span class="sd">&quot;&quot;&quot;using the last geometry in the output, after &quot;&quot;&quot;</span>
                                  <span class="sd">&quot;&quot;&quot;carefully making sure all symmetry-dependent &quot;&quot;&quot;</span>
                                  <span class="sd">&quot;&quot;&quot;input, such as DOCC, is correct.&quot;&quot;&quot;</span> <span class="o">%</span>
                                  <span class="p">(</span><span class="n">current_sym</span><span class="p">,</span> <span class="n">initial_sym</span><span class="p">))</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;opt_iter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>

        <span class="c1"># Use orbitals from previous iteration as a guess</span>
        <span class="c1">#   set within loop so that can be influenced by fns to optimize (e.g., cbs)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">opt_mode</span> <span class="o">==</span> <span class="s1">&#39;continuous&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;SCF&#39;</span><span class="p">,</span> <span class="s1">&#39;GUESS_PERSIST&#39;</span><span class="p">)):</span>
            <span class="n">core</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s1">&#39;SCF&#39;</span><span class="p">,</span> <span class="s1">&#39;GUESS&#39;</span><span class="p">,</span> <span class="s1">&#39;READ&#39;</span><span class="p">)</span>

        <span class="c1"># Before computing gradient, save previous molecule and wavefunction if this is an IRC optimization</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;OPTKING&#39;</span><span class="p">,</span> <span class="s1">&#39;OPT_TYPE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;IRC&#39;</span><span class="p">):</span>
            <span class="n">old_thisenergy</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">)</span>

        <span class="c1"># Compute the gradient</span>
        <span class="n">G</span><span class="p">,</span> <span class="n">wfn</span> <span class="o">=</span> <span class="n">gradient</span><span class="p">(</span><span class="n">lowername</span><span class="p">,</span> <span class="n">return_wfn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">molecule</span><span class="o">=</span><span class="n">moleculeclone</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">thisenergy</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">)</span>

        <span class="c1"># above, used to be getting energy as last of energy list from gradient()</span>
        <span class="c1"># thisenergy below should ultimately be testing on wfn.energy()</span>

        <span class="c1"># S/R: Quit after getting new displacements or if forming gradient fails</span>
        <span class="k">if</span> <span class="n">opt_mode</span> <span class="o">==</span> <span class="s1">&#39;sow&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">opt_mode</span> <span class="o">==</span> <span class="s1">&#39;reap&#39;</span> <span class="ow">and</span> <span class="n">thisenergy</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">core</span><span class="o">.</span><span class="n">set_gradient</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>

        <span class="c1"># S/R: Move opt data file from last pass into namespace for this pass</span>
        <span class="k">if</span> <span class="n">opt_mode</span> <span class="o">==</span> <span class="s1">&#39;reap&#39;</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">core</span><span class="o">.</span><span class="n">IOManager</span><span class="o">.</span><span class="n">shared_object</span><span class="p">()</span><span class="o">.</span><span class="n">set_specific_retention</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">core</span><span class="o">.</span><span class="n">IOManager</span><span class="o">.</span><span class="n">shared_object</span><span class="p">()</span><span class="o">.</span><span class="n">set_specific_path</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;./&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;opt_datafile&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">restartfile</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;opt_datafile&#39;</span><span class="p">)</span>
                <span class="c1">#if core.me() == 0:  TODO ask Ryan</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">restartfile</span><span class="p">,</span> <span class="n">p4util</span><span class="o">.</span><span class="n">get_psifile</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># opt_func = kwargs.get(&#39;opt_func&#39;, kwargs.get(&#39;func&#39;, energy))</span>
        <span class="c1"># if opt_func.__name__ == &#39;complete_basis_set&#39;:</span>
        <span class="c1">#     core.IOManager.shared_object().set_specific_retention(1, True)</span>

        <span class="k">if</span> <span class="n">full_hess_every</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">core</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s1">&#39;HESSIAN_WRITE&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># compute Hessian as requested; frequency wipes out gradient so stash it</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">full_hess_every</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">steps_since_last_hessian</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">full_hess_every</span><span class="p">):</span>
            <span class="n">G</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_gradient</span><span class="p">()</span>  <span class="c1"># TODO</span>
            <span class="n">core</span><span class="o">.</span><span class="n">IOManager</span><span class="o">.</span><span class="n">shared_object</span><span class="p">()</span><span class="o">.</span><span class="n">set_specific_retention</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">core</span><span class="o">.</span><span class="n">IOManager</span><span class="o">.</span><span class="n">shared_object</span><span class="p">()</span><span class="o">.</span><span class="n">set_specific_path</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;./&#39;</span><span class="p">)</span>
            <span class="n">frequencies</span><span class="p">(</span><span class="n">hessian_with_method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">steps_since_last_hessian</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">core</span><span class="o">.</span><span class="n">set_gradient</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
            <span class="n">core</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s1">&#39;CART_HESS_READ&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">full_hess_every</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">core</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s1">&#39;CART_HESS_READ&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">pass</span>
            <span class="c1"># Do nothing; user said to read existing hessian once</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">core</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s1">&#39;CART_HESS_READ&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">steps_since_last_hessian</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Take step. communicate to/from/within optking through legacy_molecule</span>
        <span class="n">core</span><span class="o">.</span><span class="n">set_legacy_molecule</span><span class="p">(</span><span class="n">moleculeclone</span><span class="p">)</span>
        <span class="n">optking_rval</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">optking</span><span class="p">()</span>
        <span class="n">moleculeclone</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_legacy_molecule</span><span class="p">()</span>
        <span class="n">moleculeclone</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">optking_rval</span> <span class="o">==</span> <span class="n">core</span><span class="o">.</span><span class="n">PsiReturnType</span><span class="o">.</span><span class="n">EndLoop</span><span class="p">:</span>
            <span class="c1"># if this is the end of an IRC run, set wfn, energy, and molecule to that</span>
            <span class="c1"># of the last optimized IRC point</span>
            <span class="k">if</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;OPTKING&#39;</span><span class="p">,</span> <span class="s1">&#39;OPT_TYPE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;IRC&#39;</span><span class="p">:</span>
                <span class="n">thisenergy</span> <span class="o">=</span> <span class="n">old_thisenergy</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Optimizer: Optimization complete!&#39;</span><span class="p">)</span>
            <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    Final optimized geometry and variables:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">moleculeclone</span><span class="o">.</span><span class="n">print_in_input_format</span><span class="p">()</span>
            <span class="c1"># Check if user wants to see the intcos; if so, don&#39;t delete them.</span>
            <span class="k">if</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;OPTKING&#39;</span><span class="p">,</span> <span class="s1">&#39;INTCOS_GENERATE_EXIT&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;OPTKING&#39;</span><span class="p">,</span> <span class="s1">&#39;KEEP_INTCOS&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">core</span><span class="o">.</span><span class="n">opt_clean</span><span class="p">()</span>
            <span class="c1"># Changing environment to optimized geometry as expected by user</span>
            <span class="n">molecule</span><span class="o">.</span><span class="n">set_geometry</span><span class="p">(</span><span class="n">moleculeclone</span><span class="o">.</span><span class="n">geometry</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">postcallback</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;optimize&#39;</span><span class="p">][</span><span class="s1">&#39;post&#39;</span><span class="p">]:</span>
                <span class="n">postcallback</span><span class="p">(</span><span class="n">lowername</span><span class="p">,</span> <span class="n">wfn</span><span class="o">=</span><span class="n">wfn</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">core</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>

            <span class="c1"># S/R: Clean up opt input file</span>
            <span class="k">if</span> <span class="n">opt_mode</span> <span class="o">==</span> <span class="s1">&#39;reap&#39;</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;OPT-master.in&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fmaster</span><span class="p">:</span>
                    <span class="n">fmaster</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# This is a psi4 input file auto-generated from the gradient() wrapper.</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                    <span class="n">fmaster</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# Optimization complete!</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

            <span class="c1"># Cleanup binary file 1</span>
            <span class="k">if</span> <span class="n">custom_gradient</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">lowername</span><span class="p">):</span>
                <span class="n">core</span><span class="o">.</span><span class="n">IOManager</span><span class="o">.</span><span class="n">shared_object</span><span class="p">()</span><span class="o">.</span><span class="n">set_specific_retention</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

            <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">return_wfn</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">thisenergy</span><span class="p">,</span> <span class="n">wfn</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">thisenergy</span>

        <span class="k">elif</span> <span class="n">optking_rval</span> <span class="o">==</span> <span class="n">core</span><span class="o">.</span><span class="n">PsiReturnType</span><span class="o">.</span><span class="n">Failure</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Optimizer: Optimization failed!&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;OPTKING&#39;</span><span class="p">,</span> <span class="s1">&#39;KEEP_INTCOS&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">core</span><span class="o">.</span><span class="n">opt_clean</span><span class="p">()</span>
            <span class="n">molecule</span><span class="o">.</span><span class="n">set_geometry</span><span class="p">(</span><span class="n">moleculeclone</span><span class="o">.</span><span class="n">geometry</span><span class="p">())</span>
            <span class="n">core</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
            <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">thisenergy</span>

        <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    Structure for next step:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">moleculeclone</span><span class="o">.</span><span class="n">print_in_input_format</span><span class="p">()</span>

        <span class="c1"># S/R: Preserve opt data file for next pass and switch modes to get new displacements</span>
        <span class="k">if</span> <span class="n">opt_mode</span> <span class="o">==</span> <span class="s1">&#39;reap&#39;</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;opt_datafile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">get_psifile</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sow&#39;</span>

        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;OPTKING&#39;</span><span class="p">,</span> <span class="s1">&#39;INTCOS_GENERATE_EXIT&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;OPTKING&#39;</span><span class="p">,</span> <span class="s1">&#39;KEEP_INTCOS&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">core</span><span class="o">.</span><span class="n">opt_clean</span><span class="p">()</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
    <span class="k">raise</span> <span class="n">ConvergenceError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;geometry optimization&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="hessian"><a class="viewcode-back" href="../../../freq.html#psi4.driver.hessian">[docs]</a><span class="k">def</span> <span class="nf">hessian</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Function complementary to :py:func:`~frequency`. Computes force</span>
<span class="sd">    constants, deciding analytic, finite difference of gradients, or</span>
<span class="sd">    finite difference of energies.</span>

<span class="sd">    :returns: :py:class:`~psi4.core.Matrix` |w--w| Total non-mass-weighted electronic Hessian in Hartrees/Bohr/Bohr.</span>

<span class="sd">    :returns: (:py:class:`~psi4.core.Matrix`, :py:class:`~psi4.core.Wavefunction`) |w--w| Hessian and wavefunction when **return_wfn** specified.</span>

<span class="sd">    :examples:</span>

<span class="sd">    &gt;&gt;&gt; # [1] Frequency calculation without thermochemical analysis</span>
<span class="sd">    &gt;&gt;&gt; hessian(&#39;mp3&#39;)</span>

<span class="sd">    &gt;&gt;&gt; # [2] Frequency calc w/o thermo analysis getting the Hessian</span>
<span class="sd">    &gt;&gt;&gt; #     in file, core.Matrix, and np.array forms</span>
<span class="sd">    &gt;&gt;&gt; set hessian_write on</span>
<span class="sd">    &gt;&gt;&gt; H, wfn = hessian(&#39;ccsd&#39;, return_wfn=True)</span>
<span class="sd">    &gt;&gt;&gt; wfn.hessian().print_out()</span>
<span class="sd">    &gt;&gt;&gt; np.array(H)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">kwargs_lower</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Bounce to CP if bsse kwarg (someday)</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bsse_type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Hessian: Cannot specify bsse_type for hessian yet.&quot;</span><span class="p">)</span>

    <span class="c1"># Figure out what kind of gradient this is</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;__call__&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cbs&#39;</span><span class="p">,</span> <span class="s1">&#39;complete_basis_set&#39;</span><span class="p">]:</span>
            <span class="n">gradient_type</span> <span class="o">=</span> <span class="s1">&#39;cbs_wrapper&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Bounce to name if name is non-CBS function</span>
            <span class="n">gradient_type</span> <span class="o">=</span> <span class="s1">&#39;custom_function&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
        <span class="n">gradient_type</span> <span class="o">=</span> <span class="s1">&#39;cbs_gufunc&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gradient_type</span> <span class="o">=</span> <span class="s1">&#39;conventional&#39;</span>

    <span class="k">if</span> <span class="n">gradient_type</span> <span class="o">!=</span> <span class="s1">&#39;conventional&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Hessian: Does not yet support more advanced input or custom functions.&quot;</span><span class="p">)</span>

    <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1"># Check if this is a CBS extrapolation</span>
    <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">lowername</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">driver_cbs</span><span class="o">.</span><span class="n">_cbs_gufunc</span><span class="p">(</span><span class="s1">&#39;hessian&#39;</span><span class="p">,</span> <span class="n">lowername</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">return_wfn</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;return_wfn&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">core</span><span class="o">.</span><span class="n">clean_variables</span><span class="p">()</span>
    <span class="n">dertype</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c1"># Prevent methods that do not have associated energies</span>
    <span class="k">if</span> <span class="n">lowername</span> <span class="ow">in</span> <span class="n">energy_only_methods</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;hessian(&#39;</span><span class="si">%s</span><span class="s2">&#39;) does not have an associated hessian&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s1">&#39;FINDIF&#39;</span><span class="p">,</span> <span class="s1">&#39;HESSIAN_WRITE&#39;</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="c1"># Allow specification of methods to arbitrary order</span>
    <span class="n">lowername</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="n">driver_util</span><span class="o">.</span><span class="n">parse_arbitrary_order</span><span class="p">(</span><span class="n">lowername</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">level</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level</span>

    <span class="n">dertype</span> <span class="o">=</span> <span class="n">_find_derivative_type</span><span class="p">(</span><span class="s1">&#39;hessian&#39;</span><span class="p">,</span> <span class="n">lowername</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;freq_dertype&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dertype&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)))</span>

    <span class="c1"># Make sure the molecule the user provided is the active one</span>
    <span class="n">molecule</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;molecule&#39;</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">())</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>

    <span class="c1"># S/R: Mode of operation- whether finite difference freq run in one job or files farmed out</span>
    <span class="n">freq_mode</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;continuous&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">freq_mode</span> <span class="o">==</span> <span class="s1">&#39;continuous&#39;</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">freq_mode</span> <span class="o">==</span> <span class="s1">&#39;sow&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dertype</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Frequency execution mode &#39;sow&#39; not valid for analytic Hessian calculation.&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">freq_mode</span> <span class="o">==</span> <span class="s1">&#39;reap&#39;</span><span class="p">:</span>
        <span class="n">freq_linkage</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;linkage&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">freq_linkage</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Frequency execution mode &#39;reap&#39; requires a linkage option.&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Frequency execution mode &#39;</span><span class="si">%s</span><span class="s2">&#39; not valid.&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">freq_mode</span><span class="p">))</span>

    <span class="c1"># Set method-dependent scf convergence criteria (test on procedures[&#39;energy&#39;] since that&#39;s guaranteed)</span>
    <span class="n">optstash_conv</span> <span class="o">=</span> <span class="n">driver_util</span><span class="o">.</span><span class="n">_set_convergence_criterion</span><span class="p">(</span><span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="n">lowername</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

    <span class="c1"># Select certain irreps</span>
    <span class="n">irrep</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;irrep&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">irrep</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">pass</span>  <span class="c1"># do all irreps</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">irrep</span> <span class="o">=</span> <span class="n">driver_util</span><span class="o">.</span><span class="n">parse_cotton_irreps</span><span class="p">(</span><span class="n">irrep</span><span class="p">,</span> <span class="n">molecule</span><span class="o">.</span><span class="n">schoenflies_symbol</span><span class="p">())</span>
        <span class="n">irrep</span> <span class="o">-=</span> <span class="mi">1</span>  <span class="c1"># A1 irrep is externally 1, internally 0</span>
        <span class="k">if</span> <span class="n">dertype</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;hessian() switching to finite difference by gradients for partial Hessian calculation.</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">dertype</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Does an analytic procedure exist for the requested method?</span>
    <span class="k">if</span> <span class="n">dertype</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;hessian() will perform analytic frequency computation.</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># We have the desired method. Do it.</span>
        <span class="n">wfn</span> <span class="o">=</span> <span class="n">procedures</span><span class="p">[</span><span class="s1">&#39;hessian&#39;</span><span class="p">][</span><span class="n">lowername</span><span class="p">](</span><span class="n">lowername</span><span class="p">,</span> <span class="n">molecule</span><span class="o">=</span><span class="n">molecule</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
        <span class="n">optstash_conv</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

        <span class="c1"># TODO: check that current energy&#39;s being set to the right figure when this code is actually used</span>
        <span class="n">core</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">,</span> <span class="n">wfn</span><span class="o">.</span><span class="n">energy</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">return_wfn</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">wfn</span><span class="o">.</span><span class="n">hessian</span><span class="p">(),</span> <span class="n">wfn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">wfn</span><span class="o">.</span><span class="n">hessian</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">dertype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;hessian() will perform frequency computation by finite difference of analytic gradients.</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Shifting the geometry so need to copy the active molecule</span>
        <span class="n">moleculeclone</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>

        <span class="c1"># Obtain list of displacements</span>
        <span class="n">displacements</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">fd_geoms_freq_1</span><span class="p">(</span><span class="n">moleculeclone</span><span class="p">,</span> <span class="n">irrep</span><span class="p">)</span>
        <span class="n">moleculeclone</span><span class="o">.</span><span class="n">reinterpret_coordentry</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">moleculeclone</span><span class="o">.</span><span class="n">fix_orientation</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Record undisplaced symmetry for projection of diplaced point groups</span>
        <span class="n">core</span><span class="o">.</span><span class="n">set_parent_symmetry</span><span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">schoenflies_symbol</span><span class="p">())</span>

        <span class="n">ndisp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">displacements</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot; </span><span class="si">%d</span><span class="s2"> displacements needed.&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">ndisp</span><span class="p">)</span>
        <span class="n">gradients</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># S/R: Write instructions for sow/reap procedure to output file and reap input file</span>
        <span class="k">if</span> <span class="n">freq_mode</span> <span class="o">==</span> <span class="s1">&#39;sow&#39;</span><span class="p">:</span>
            <span class="n">instructionsO</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s2">#    The frequency sow/reap procedure has been selected through mode=&#39;sow&#39;. In addition</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsO</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#    to this output file (which contains no quantum chemical calculations), this job</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsO</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#    has produced a number of input files (FREQ-*.in) for individual components</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsO</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#    and a single input file (FREQ-master.in) with a frequency(mode=&#39;reap&#39;) command.</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsO</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#    These files may look very peculiar since they contain processed and pickled python</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsO</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#    rather than normal input. Follow the instructions below (repeated in FREQ-master.in)</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsO</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#    to continue.</span><span class="se">\n</span><span class="s2">#</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsO</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#    Alternatively, a single-job execution of the hessian may be accessed through</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsO</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#    the frequency wrapper option mode=&#39;continuous&#39;.</span><span class="se">\n</span><span class="s2">#</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">instructionsO</span><span class="p">)</span>

            <span class="n">instructionsM</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s2">#    Follow the instructions below to carry out this frequency computation.</span><span class="se">\n</span><span class="s2">#</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#    (1)  Run all of the FREQ-*.in input files on any variety of computer architecture.</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#       The output file names must be as given below (these are the defaults when executed</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#       as `psi4 FREQ-1.in`, etc.).</span><span class="se">\n</span><span class="s2">#</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">rgt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndisp</span><span class="p">):</span>
                <span class="n">pre</span> <span class="o">=</span> <span class="s1">&#39;FREQ-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rgt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#             psi4 -i </span><span class="si">%-27s</span><span class="s2"> -o </span><span class="si">%-27s</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pre</span> <span class="o">+</span> <span class="s1">&#39;.in&#39;</span><span class="p">,</span> <span class="n">pre</span> <span class="o">+</span> <span class="s1">&#39;.out&#39;</span><span class="p">)</span>
            <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#</span><span class="se">\n</span><span class="s2">#    (2)  Gather all the resulting output files in a directory. Place input file</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#         FREQ-master.in into that directory and run it. The job will be minimal in</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#         length and give summary results for the frequency computation in its output file.</span><span class="se">\n</span><span class="s2">#</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#             psi4 -i </span><span class="si">%-27s</span><span class="s2"> -o </span><span class="si">%-27s</span><span class="se">\n</span><span class="s2">#</span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;FREQ-master.in&#39;</span><span class="p">,</span> <span class="s1">&#39;FREQ-master.out&#39;</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;FREQ-master.in&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fmaster</span><span class="p">:</span>
                <span class="n">fmaster</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# This is a psi4 input file auto-generated from the hessian() wrapper.</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                <span class="n">fmaster</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">p4util</span><span class="o">.</span><span class="n">format_molecule_for_input</span><span class="p">(</span><span class="n">moleculeclone</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                <span class="n">fmaster</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">p4util</span><span class="o">.</span><span class="n">format_options_for_input</span><span class="p">(</span><span class="n">moleculeclone</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
                <span class="n">p4util</span><span class="o">.</span><span class="n">format_kwargs_for_input</span><span class="p">(</span><span class="n">fmaster</span><span class="p">,</span> <span class="n">lmode</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">return_wfn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">freq_dertype</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">fmaster</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s2">&quot;&quot;&quot;retE, retwfn = </span><span class="si">%s</span><span class="s2">(&#39;</span><span class="si">%s</span><span class="s2">&#39;, **kwargs)</span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">frequency</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">lowername</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                <span class="n">fmaster</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">instructionsM</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
            <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">instructionsM</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">displacement</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">displacements</span><span class="p">):</span>
            <span class="n">rfile</span> <span class="o">=</span> <span class="s1">&#39;FREQ-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Build string of title banner</span>
            <span class="n">banners</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">banners</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;core.print_out(&#39;</span><span class="se">\\</span><span class="s2">n&#39;)</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">banners</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;p4util.banner(&#39; Hessian Computation: Gradient Displacement </span><span class="si">%d</span><span class="s2"> &#39;)</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">banners</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;core.print_out(&#39;</span><span class="se">\\</span><span class="s2">n&#39;)</span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="n">freq_mode</span> <span class="o">==</span> <span class="s1">&#39;continuous&#39;</span><span class="p">:</span>

                <span class="c1"># print progress to file and screen</span>
                <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s1">&#39;Loading displacement </span><span class="si">%d</span><span class="s1"> of </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndisp</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot; </span><span class="si">%d</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">ndisp</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

                <span class="c1"># Load in displacement into the active molecule (xyz coordinates only)</span>
                <span class="n">moleculeclone</span><span class="o">.</span><span class="n">set_geometry</span><span class="p">(</span><span class="n">displacement</span><span class="p">)</span>

                <span class="c1"># Perform the gradient calculation</span>
                <span class="n">G</span><span class="p">,</span> <span class="n">wfn</span> <span class="o">=</span> <span class="n">gradient</span><span class="p">(</span><span class="n">lowername</span><span class="p">,</span> <span class="n">molecule</span><span class="o">=</span><span class="n">moleculeclone</span><span class="p">,</span> <span class="n">return_wfn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">gradients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wfn</span><span class="o">.</span><span class="n">gradient</span><span class="p">())</span>
                <span class="n">energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">))</span>

                <span class="c1"># clean may be necessary when changing irreps of displacements</span>
                <span class="n">core</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>

            <span class="c1"># S/R: Write each displaced geometry to an input file</span>
            <span class="k">elif</span> <span class="n">freq_mode</span> <span class="o">==</span> <span class="s1">&#39;sow&#39;</span><span class="p">:</span>
                <span class="n">moleculeclone</span><span class="o">.</span><span class="n">set_geometry</span><span class="p">(</span><span class="n">displacement</span><span class="p">)</span>

                <span class="c1"># S/R: Prepare molecule, options, kwargs, function call and energy save</span>
                <span class="c1">#      forcexyz in molecule writer S/R enforcement of !reinterpret_coordentry above</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.in&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rfile</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">freagent</span><span class="p">:</span>
                    <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# This is a psi4 input file auto-generated from the hessian() wrapper.</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">p4util</span><span class="o">.</span><span class="n">format_molecule_for_input</span><span class="p">(</span><span class="n">moleculeclone</span><span class="p">,</span> <span class="n">forcexyz</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                    <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">p4util</span><span class="o">.</span><span class="n">format_options_for_input</span><span class="p">(</span><span class="n">moleculeclone</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;return_wfn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">p4util</span><span class="o">.</span><span class="n">format_kwargs_for_input</span><span class="p">(</span><span class="n">freagent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;G, wfn = </span><span class="si">%s</span><span class="s2">(&#39;</span><span class="si">%s</span><span class="s2">&#39;, **kwargs)</span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gradient</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">lowername</span><span class="p">))</span>
                    <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;core.print_out(&#39;</span><span class="se">\\</span><span class="s2">nHESSIAN RESULT: computation </span><span class="si">%d</span><span class="s2"> for item </span><span class="si">%d</span><span class="s2"> &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;yields electronic gradient </span><span class="si">%r</span><span class="se">\\</span><span class="s2">n&#39; % (p4util.mat2arr(wfn.gradient())))</span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
                    <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;core.print_out(&#39;</span><span class="se">\\</span><span class="s2">nHESSIAN RESULT: computation </span><span class="si">%d</span><span class="s2"> for item </span><span class="si">%d</span><span class="s2"> &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;yields electronic energy </span><span class="si">%20.12f</span><span class="se">\\</span><span class="s2">n&#39; % (get_variable(&#39;CURRENT ENERGY&#39;)))</span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># S/R: Read energy from each displaced geometry output file and save in energies array</span>
            <span class="k">elif</span> <span class="n">freq_mode</span> <span class="o">==</span> <span class="s1">&#39;reap&#39;</span><span class="p">:</span>
                <span class="n">exec</span><span class="p">(</span><span class="n">banners</span><span class="p">)</span>
                <span class="n">core</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s1">&#39;NUCLEAR REPULSION ENERGY&#39;</span><span class="p">,</span> <span class="n">moleculeclone</span><span class="o">.</span><span class="n">nuclear_repulsion_energy</span><span class="p">())</span>
                <span class="n">pygrad</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">extract_sowreap_from_output</span><span class="p">(</span><span class="n">rfile</span><span class="p">,</span> <span class="s1">&#39;HESSIAN&#39;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">freq_linkage</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;electronic gradient&#39;</span><span class="p">)</span>
                <span class="n">p4mat</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="n">moleculeclone</span><span class="o">.</span><span class="n">natom</span><span class="p">(),</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">p4mat</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">pygrad</span><span class="p">)</span>
                <span class="n">p4mat</span><span class="o">.</span><span class="n">print_out</span><span class="p">()</span>
                <span class="n">gradients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p4mat</span><span class="p">)</span>
                <span class="n">energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p4util</span><span class="o">.</span><span class="n">extract_sowreap_from_output</span><span class="p">(</span><span class="n">rfile</span><span class="p">,</span> <span class="s1">&#39;HESSIAN&#39;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">freq_linkage</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>

        <span class="c1"># S/R: Quit sow after writing files. Initialize skeleton wfn to receive grad for reap</span>
        <span class="k">if</span> <span class="n">freq_mode</span> <span class="o">==</span> <span class="s1">&#39;sow&#39;</span><span class="p">:</span>
            <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
            <span class="n">optstash_conv</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">return_wfn</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">freq_mode</span> <span class="o">==</span> <span class="s1">&#39;reap&#39;</span><span class="p">:</span>
            <span class="n">wfn</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Wavefunction</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s1">&#39;BASIS&#39;</span><span class="p">))</span>

        <span class="c1"># Assemble Hessian from gradients</span>
        <span class="c1">#   Final disp is undisp, so wfn has mol, G, H general to freq calc</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">fd_freq_1</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">gradients</span><span class="p">,</span> <span class="n">irrep</span><span class="p">)</span>  <span class="c1"># TODO or moleculeclone?</span>
        <span class="n">wfn</span><span class="o">.</span><span class="n">set_hessian</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
        <span class="n">wfn</span><span class="o">.</span><span class="n">set_frequencies</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">get_frequencies</span><span class="p">())</span>

        <span class="c1"># The last item in the list is the reference energy, return it</span>
        <span class="n">core</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">,</span> <span class="n">energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">core</span><span class="o">.</span><span class="n">set_parent_symmetry</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
        <span class="n">optstash_conv</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">return_wfn</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">wfn</span><span class="o">.</span><span class="n">hessian</span><span class="p">(),</span> <span class="n">wfn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">wfn</span><span class="o">.</span><span class="n">hessian</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;hessian() will perform frequency computation by finite difference of analytic energies.</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Set method-dependent scf convergence criteria (test on procedures[&#39;energy&#39;] since that&#39;s guaranteed)</span>
        <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
        <span class="n">optstash_conv</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
        <span class="n">optstash_conv</span> <span class="o">=</span> <span class="n">driver_util</span><span class="o">.</span><span class="n">_set_convergence_criterion</span><span class="p">(</span><span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="n">lowername</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="c1"># Shifting the geometry so need to copy the active molecule</span>
        <span class="n">moleculeclone</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>

        <span class="c1"># Obtain list of displacements</span>
        <span class="n">displacements</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">fd_geoms_freq_0</span><span class="p">(</span><span class="n">moleculeclone</span><span class="p">,</span> <span class="n">irrep</span><span class="p">)</span>
        <span class="n">moleculeclone</span><span class="o">.</span><span class="n">fix_orientation</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">moleculeclone</span><span class="o">.</span><span class="n">reinterpret_coordentry</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Record undisplaced symmetry for projection of diplaced point groups</span>
        <span class="n">core</span><span class="o">.</span><span class="n">set_parent_symmetry</span><span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">schoenflies_symbol</span><span class="p">())</span>

        <span class="n">ndisp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">displacements</span><span class="p">)</span>

        <span class="c1"># This version is pretty dependent on the reference geometry being last (as it is now)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%d</span><span class="s1"> displacements needed.&#39;</span> <span class="o">%</span> <span class="n">ndisp</span><span class="p">)</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># S/R: Write instructions for sow/reap procedure to output file and reap input file</span>
        <span class="k">if</span> <span class="n">freq_mode</span> <span class="o">==</span> <span class="s1">&#39;sow&#39;</span><span class="p">:</span>
            <span class="n">instructionsO</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s2">#    The frequency sow/reap procedure has been selected through mode=&#39;sow&#39;. In addition</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsO</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#    to this output file (which contains no quantum chemical calculations), this job</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsO</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#    has produced a number of input files (FREQ-*.in) for individual components</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsO</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#    and a single input file (FREQ-master.in) with a frequency(mode=&#39;reap&#39;) command.</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsO</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#    These files may look very peculiar since they contain processed and pickled python</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsO</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#    rather than normal input. Follow the instructions below (repeated in FREQ-master.in)</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsO</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#    to continue.</span><span class="se">\n</span><span class="s2">#</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsO</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#    Alternatively, a single-job execution of the hessian may be accessed through</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsO</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#    the frequency wrapper option mode=&#39;continuous&#39;.</span><span class="se">\n</span><span class="s2">#</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">instructionsO</span><span class="p">)</span>

            <span class="n">instructionsM</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s2">#    Follow the instructions below to carry out this frequency computation.</span><span class="se">\n</span><span class="s2">#</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#    (1)  Run all of the FREQ-*.in input files on any variety of computer architecture.</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#       The output file names must be as given below (these are the defaults when executed</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#       as `psi4 FREQ-1.in`, etc.).</span><span class="se">\n</span><span class="s2">#</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">rgt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndisp</span><span class="p">):</span>
                <span class="n">pre</span> <span class="o">=</span> <span class="s1">&#39;FREQ-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rgt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#             psi4 -i </span><span class="si">%-27s</span><span class="s2"> -o </span><span class="si">%-27s</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pre</span> <span class="o">+</span> <span class="s1">&#39;.in&#39;</span><span class="p">,</span> <span class="n">pre</span> <span class="o">+</span> <span class="s1">&#39;.out&#39;</span><span class="p">)</span>
            <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#</span><span class="se">\n</span><span class="s2">#    (2)  Gather all the resulting output files in a directory. Place input file</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#         FREQ-master.in into that directory and run it. The job will be minimal in</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#         length and give summary results for the frequency computation in its output file.</span><span class="se">\n</span><span class="s2">#</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">instructionsM</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;#             psi4 -i </span><span class="si">%-27s</span><span class="s2"> -o </span><span class="si">%-27s</span><span class="se">\n</span><span class="s2">#</span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;FREQ-master.in&#39;</span><span class="p">,</span> <span class="s1">&#39;FREQ-master.out&#39;</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;FREQ-master.in&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fmaster</span><span class="p">:</span>
                <span class="n">fmaster</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# This is a psi4 input file auto-generated from the hessian() wrapper.</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                <span class="n">fmaster</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">p4util</span><span class="o">.</span><span class="n">format_molecule_for_input</span><span class="p">(</span><span class="n">moleculeclone</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                <span class="n">fmaster</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">p4util</span><span class="o">.</span><span class="n">format_options_for_input</span><span class="p">(</span><span class="n">moleculeclone</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
                <span class="n">p4util</span><span class="o">.</span><span class="n">format_kwargs_for_input</span><span class="p">(</span><span class="n">fmaster</span><span class="p">,</span> <span class="n">lmode</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">return_wfn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">freq_dertype</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">fmaster</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s2">&quot;&quot;&quot;retE, retwfn = </span><span class="si">%s</span><span class="s2">(&#39;</span><span class="si">%s</span><span class="s2">&#39;, **kwargs)</span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">frequency</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">lowername</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                <span class="n">fmaster</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">instructionsM</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
            <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">instructionsM</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">displacement</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">displacements</span><span class="p">):</span>
            <span class="n">rfile</span> <span class="o">=</span> <span class="s1">&#39;FREQ-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Build string of title banner</span>
            <span class="n">banners</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">banners</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;core.print_out(&#39;</span><span class="se">\\</span><span class="s2">n&#39;)</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">banners</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;p4util.banner(&#39; Hessian Computation: Energy Displacement </span><span class="si">%d</span><span class="s2"> &#39;)</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">banners</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;core.print_out(&#39;</span><span class="se">\\</span><span class="s2">n&#39;)</span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="n">freq_mode</span> <span class="o">==</span> <span class="s1">&#39;continuous&#39;</span><span class="p">:</span>

                <span class="c1"># print progress to file and screen</span>
                <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">p4util</span><span class="o">.</span><span class="n">banner</span><span class="p">(</span><span class="s1">&#39;Loading displacement </span><span class="si">%d</span><span class="s1"> of </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndisp</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot; </span><span class="si">%d</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">ndisp</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

                <span class="c1"># Load in displacement into the active molecule</span>
                <span class="n">moleculeclone</span><span class="o">.</span><span class="n">set_geometry</span><span class="p">(</span><span class="n">displacement</span><span class="p">)</span>

                <span class="c1"># Perform the energy calculation</span>
                <span class="n">E</span><span class="p">,</span> <span class="n">wfn</span> <span class="o">=</span> <span class="n">energy</span><span class="p">(</span><span class="n">lowername</span><span class="p">,</span> <span class="n">return_wfn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">molecule</span><span class="o">=</span><span class="n">moleculeclone</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">))</span>

                <span class="c1"># clean may be necessary when changing irreps of displacements</span>
                <span class="n">core</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>

            <span class="c1"># S/R: Write each displaced geometry to an input file</span>
            <span class="k">elif</span> <span class="n">freq_mode</span> <span class="o">==</span> <span class="s1">&#39;sow&#39;</span><span class="p">:</span>
                <span class="n">moleculeclone</span><span class="o">.</span><span class="n">set_geometry</span><span class="p">(</span><span class="n">displacement</span><span class="p">)</span>

                <span class="c1"># S/R: Prepare molecule, options, kwargs, function call and energy save</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.in&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rfile</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">freagent</span><span class="p">:</span>
                    <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# This is a psi4 input file auto-generated from the gradient() wrapper.</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">p4util</span><span class="o">.</span><span class="n">format_molecule_for_input</span><span class="p">(</span><span class="n">moleculeclone</span><span class="p">,</span> <span class="n">forcexyz</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                    <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">p4util</span><span class="o">.</span><span class="n">format_options_for_input</span><span class="p">(</span><span class="n">moleculeclone</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                    <span class="n">p4util</span><span class="o">.</span><span class="n">format_kwargs_for_input</span><span class="p">(</span><span class="n">freagent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;electronic_energy = </span><span class="si">%s</span><span class="s2">(&#39;</span><span class="si">%s</span><span class="s2">&#39;, **kwargs)</span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">energy</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">lowername</span><span class="p">))</span>
                    <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;core.print_out(&#39;</span><span class="se">\\</span><span class="s2">nHESSIAN RESULT: computation </span><span class="si">%d</span><span class="s2"> for item </span><span class="si">%d</span><span class="s2"> &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;yields electronic energy </span><span class="si">%20.12f</span><span class="se">\\</span><span class="s2">n&#39; % (electronic_energy))</span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># S/R: Read energy from each displaced geometry output file and save in energies array</span>
            <span class="k">elif</span> <span class="n">freq_mode</span> <span class="o">==</span> <span class="s1">&#39;reap&#39;</span><span class="p">:</span>
                <span class="n">exec</span><span class="p">(</span><span class="n">banners</span><span class="p">)</span>
                <span class="n">core</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s1">&#39;NUCLEAR REPULSION ENERGY&#39;</span><span class="p">,</span> <span class="n">moleculeclone</span><span class="o">.</span><span class="n">nuclear_repulsion_energy</span><span class="p">())</span>
                <span class="n">energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p4util</span><span class="o">.</span><span class="n">extract_sowreap_from_output</span><span class="p">(</span><span class="n">rfile</span><span class="p">,</span> <span class="s1">&#39;HESSIAN&#39;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">freq_linkage</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>

        <span class="c1"># S/R: Quit sow after writing files. Initialize skeleton wfn to receive grad for reap</span>
        <span class="k">if</span> <span class="n">freq_mode</span> <span class="o">==</span> <span class="s1">&#39;sow&#39;</span><span class="p">:</span>
            <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
            <span class="n">optstash_conv</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">return_wfn</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">freq_mode</span> <span class="o">==</span> <span class="s1">&#39;reap&#39;</span><span class="p">:</span>
        <span class="c1">#    core.set_variable(&#39;CURRENT ENERGY&#39;, energies[-1])</span>
            <span class="n">wfn</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Wavefunction</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s1">&#39;BASIS&#39;</span><span class="p">))</span>

        <span class="c1"># Assemble Hessian from energies</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">fd_freq_0</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">energies</span><span class="p">,</span> <span class="n">irrep</span><span class="p">)</span>
        <span class="n">wfn</span><span class="o">.</span><span class="n">set_hessian</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
        <span class="n">wfn</span><span class="o">.</span><span class="n">set_frequencies</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">get_frequencies</span><span class="p">())</span>

        <span class="c1"># The last item in the list is the reference energy, return it</span>
        <span class="n">core</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">,</span> <span class="n">energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">core</span><span class="o">.</span><span class="n">set_parent_symmetry</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
        <span class="n">optstash_conv</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">return_wfn</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">wfn</span><span class="o">.</span><span class="n">hessian</span><span class="p">(),</span> <span class="n">wfn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">wfn</span><span class="o">.</span><span class="n">hessian</span><span class="p">()</span></div>


<div class="viewcode-block" id="frequency"><a class="viewcode-back" href="../../../freq.html#psi4.driver.frequency">[docs]</a><span class="k">def</span> <span class="nf">frequency</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Function to compute harmonic vibrational frequencies.</span>

<span class="sd">    :aliases: frequencies(), freq()</span>

<span class="sd">    :returns: *float* |w--w| Total electronic energy in Hartrees.</span>

<span class="sd">    :returns: (*float*, :py:class:`~psi4.core.Wavefunction`) |w--w| energy and wavefunction when **return_wfn** specified.</span>

<span class="sd">    :type name: string</span>
<span class="sd">    :param name: ``&#39;scf&#39;`` || ``&#39;mp2&#39;`` || ``&#39;ci5&#39;`` || etc.</span>

<span class="sd">        First argument, usually unlabeled. Indicates the computational method</span>
<span class="sd">        to be applied to the system.</span>

<span class="sd">    :type molecule: :ref:`molecule &lt;op_py_molecule&gt;`</span>
<span class="sd">    :param molecule: ``h2o`` || etc.</span>

<span class="sd">        The target molecule, if not the last molecule defined.</span>

<span class="sd">    :type return_wfn: :ref:`boolean &lt;op_py_boolean&gt;`</span>
<span class="sd">    :param return_wfn: ``&#39;on&#39;`` || |dl| ``&#39;off&#39;`` |dr|</span>

<span class="sd">        Indicate to additionally return the :py:class:`~psi4.core.Wavefunction`</span>
<span class="sd">        calculation result as the second element (after *float* energy) of a tuple.</span>
<span class="sd">        Arrays of frequencies and the Hessian can be accessed through the wavefunction.</span>

<span class="sd">    :type func: :ref:`function &lt;op_py_function&gt;`</span>
<span class="sd">    :param func: |dl| ``gradient`` |dr| || ``energy`` || ``cbs``</span>

<span class="sd">        Indicates the type of calculation to be performed on the molecule.</span>
<span class="sd">        The default dertype accesses ``&#39;gradient&#39;`` or ``&#39;energy&#39;``, while</span>
<span class="sd">        ``&#39;cbs&#39;`` performs a multistage finite difference calculation.</span>
<span class="sd">        If a nested series of python functions is intended (see :ref:`sec:intercalls`),</span>
<span class="sd">        use keyword ``freq_func`` instead of ``func``.</span>

<span class="sd">    :type mode: string</span>
<span class="sd">    :param mode: |dl| ``&#39;continuous&#39;`` |dr| || ``&#39;sow&#39;`` || ``&#39;reap&#39;``</span>

<span class="sd">        For a finite difference of energies or gradients frequency, indicates</span>
<span class="sd">        whether the calculations required to complete the frequency are to be run</span>
<span class="sd">        in one file (``&#39;continuous&#39;``) or are to be farmed out in an</span>
<span class="sd">        embarrassingly parallel fashion (``&#39;sow&#39;``/``&#39;reap&#39;``)/ For the latter,</span>
<span class="sd">        run an initial job with ``&#39;sow&#39;`` and follow instructions in its output file.</span>
<span class="sd">        For maximum flexibility, ``return_wfn`` is always on in ``&#39;reap&#39;`` mode.</span>

<span class="sd">    :type dertype: :ref:`dertype &lt;op_py_dertype&gt;`</span>
<span class="sd">    :param dertype: |dl| ``&#39;hessian&#39;`` |dr| || ``&#39;gradient&#39;`` || ``&#39;energy&#39;``</span>

<span class="sd">        Indicates whether analytic (if available- they&#39;re not), finite</span>
<span class="sd">        difference of gradients (if available) or finite difference of</span>
<span class="sd">        energies is to be performed.</span>

<span class="sd">    :type irrep: int or string</span>
<span class="sd">    :param irrep: |dl| ``-1`` |dr| || ``1`` || ``&#39;b2&#39;`` || ``&#39;App&#39;`` || etc.</span>

<span class="sd">        Indicates which symmetry block (:ref:`Cotton &lt;table:irrepOrdering&gt;` ordering) of vibrational</span>
<span class="sd">        frequencies to be computed. ``1``, ``&#39;1&#39;``, or ``&#39;a1&#39;`` represents</span>
<span class="sd">        :math:`a_1`, requesting only the totally symmetric modes.</span>
<span class="sd">        ``-1`` indicates a full frequency calculation.</span>

<span class="sd">    .. note:: Analytic hessians are only available for RHF. For all other methods, Frequencies will</span>
<span class="sd">        proceed through finite differences according to availability of gradients or energies.</span>

<span class="sd">    .. _`table:freq_gen`:</span>

<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | name                    | calls method                                                                                                  |</span>
<span class="sd">    +=========================+===============================================================================================================+</span>
<span class="sd">    | scf                     | Hartree--Fock (HF) :ref:`[manual] &lt;sec:scf&gt;`                                                                  |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>

<span class="sd">    :examples:</span>

<span class="sd">    &gt;&gt;&gt; # [1] Frequency calculation for all modes through highest available derivatives</span>
<span class="sd">    &gt;&gt;&gt; frequency(&#39;ccsd&#39;)</span>

<span class="sd">    &gt;&gt;&gt; # [2] Frequency calculation for b2 modes through finite difference of gradients</span>
<span class="sd">    &gt;&gt;&gt; #     printing lowest mode frequency to screen and Hessian to output</span>
<span class="sd">    &gt;&gt;&gt; E, wfn = frequencies(&#39;scf&#39;, dertype=1, irrep=4, return_wfn=True)</span>
<span class="sd">    &gt;&gt;&gt; print wfn.frequencies().get(0, 0)</span>
<span class="sd">    &gt;&gt;&gt; wfn.hessian().print_out()</span>

<span class="sd">    &gt;&gt;&gt; # [3] Frequency calculation at default conditions and Hessian reuse at STP</span>
<span class="sd">    &gt;&gt;&gt; E, wfn = freq(&#39;mp2&#39;, return_wfn=True)</span>
<span class="sd">    &gt;&gt;&gt; set t 273.15</span>
<span class="sd">    &gt;&gt;&gt; set p 100000</span>
<span class="sd">    &gt;&gt;&gt; thermo(wfn, wfn.frequencies())</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">kwargs_lower</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Bounce (someday) if name is function</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;__call__&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Frequency: Cannot use custom function&quot;</span><span class="p">)</span>

    <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="n">old_global_basis</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">lowername</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;+&quot;</span> <span class="ow">in</span> <span class="n">lowername</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;[&quot;</span> <span class="ow">in</span> <span class="n">lowername</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">lowername</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Frequency: Cannot extrapolate or delta correct frequencies yet.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">old_global_basis</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s2">&quot;BASIS&quot;</span><span class="p">)</span>
            <span class="n">lowername</span><span class="p">,</span> <span class="n">new_basis</span> <span class="o">=</span> <span class="n">lowername</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="n">core</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s1">&#39;BASIS&#39;</span><span class="p">,</span> <span class="n">new_basis</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bsse_type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValdiationError</span><span class="p">(</span><span class="s2">&quot;Frequency: Does not currently support &#39;bsse_type&#39; arguements&quot;</span><span class="p">)</span>

    <span class="n">return_wfn</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;return_wfn&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># are we in sow/reap mode?</span>
    <span class="n">freq_mode</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;continuous&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">freq_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;continuous&#39;</span><span class="p">,</span> <span class="s1">&#39;sow&#39;</span><span class="p">,</span> <span class="s1">&#39;reap&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Frequency execution mode &#39;</span><span class="si">%s</span><span class="s2">&#39; not valid.&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">freq_mode</span><span class="p">))</span>

    <span class="c1"># Make sure the molecule the user provided is the active one</span>
    <span class="n">molecule</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;molecule&#39;</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">())</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>

    <span class="c1"># Compute the hessian</span>
    <span class="n">H</span><span class="p">,</span> <span class="n">wfn</span> <span class="o">=</span> <span class="n">hessian</span><span class="p">(</span><span class="n">lowername</span><span class="p">,</span> <span class="n">return_wfn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">molecule</span><span class="o">=</span><span class="n">molecule</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># S/R: Quit after getting new displacements</span>
    <span class="k">if</span> <span class="n">freq_mode</span> <span class="o">==</span> <span class="s1">&#39;sow&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="n">wfn</span><span class="o">.</span><span class="n">frequencies</span><span class="p">()</span><span class="o">.</span><span class="n">print_out</span><span class="p">()</span>
    <span class="n">core</span><span class="o">.</span><span class="n">thermo</span><span class="p">(</span><span class="n">wfn</span><span class="p">,</span> <span class="n">wfn</span><span class="o">.</span><span class="n">frequencies</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">postcallback</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">][</span><span class="s1">&#39;post&#39;</span><span class="p">]:</span>
        <span class="n">postcallback</span><span class="p">(</span><span class="n">lowername</span><span class="p">,</span> <span class="n">wfn</span><span class="o">=</span><span class="n">wfn</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Reset old global basis if needed</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">old_global_basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">core</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s2">&quot;BASIS&quot;</span><span class="p">,</span> <span class="n">old_global_basis</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_wfn</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">),</span> <span class="n">wfn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="gdma"><a class="viewcode-back" href="../../../gdma.html#psi4.driver.gdma">[docs]</a><span class="k">def</span> <span class="nf">gdma</span><span class="p">(</span><span class="n">wfn</span><span class="p">,</span> <span class="n">datafile</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function to use wavefunction information in *wfn* and, if specified,</span>
<span class="sd">    additional commands in *filename* to run GDMA analysis.</span>

<span class="sd">    .. include:: ../autodoc_abbr_options_c.rst</span>

<span class="sd">    .. versionadded:: 0.6</span>

<span class="sd">    :returns: None</span>

<span class="sd">    :type wfn: :py:class:`~psi4.core.Wavefunction`</span>
<span class="sd">    :param wfn: set of molecule, basis, orbitals from which to generate DMA analysis</span>

<span class="sd">    :type datafile: string</span>
<span class="sd">    :param datafile: optional control file (see GDMA manual) to peform more complicated DMA</span>
<span class="sd">                     analyses.  If this option is used, the File keyword must be set to read</span>
<span class="sd">                     a filename.fchk, where filename is provided by |globals__writer_file_label| .</span>

<span class="sd">    :examples:</span>

<span class="sd">    &gt;&gt;&gt; # [1] DMA analysis from MP2 wavefunction.  N.B. gradient must be requested to generate MP2 density.</span>
<span class="sd">    &gt;&gt;&gt; grad, wfn = gradient(&#39;mp2&#39;, return_wfn=True)</span>
<span class="sd">    &gt;&gt;&gt; gdma(wfn)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Start by writing a G* checkpoint file, for the GDMA code to read in</span>
    <span class="n">fw</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">FCHKWriter</span><span class="p">(</span><span class="n">wfn</span><span class="p">)</span>
    <span class="n">molname</span> <span class="o">=</span> <span class="n">wfn</span><span class="o">.</span><span class="n">molecule</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_writer_file_prefix</span><span class="p">(</span><span class="n">molname</span><span class="p">)</span>
    <span class="n">fchkfile</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;.fchk&#39;</span>
    <span class="n">fw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fchkfile</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">datafile</span><span class="p">:</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="n">datafile</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">densname</span> <span class="o">=</span> <span class="n">wfn</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">densname</span> <span class="o">==</span> <span class="s2">&quot;DFT&quot;</span><span class="p">:</span>
            <span class="n">densname</span> <span class="o">=</span> <span class="s2">&quot;SCF&quot;</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="s1">&#39;psi4_dma_datafile.dma&#39;</span>
        <span class="n">radii</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;GDMA&#39;</span><span class="p">,</span> <span class="s1">&#39;GDMA_RADIUS&#39;</span><span class="p">)</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;GDMA&#39;</span><span class="p">,</span> <span class="s1">&#39;GDMA_ORIGIN&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">commands</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;File </span><span class="si">%s</span><span class="s2"> Density </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fchkfile</span><span class="p">,</span> <span class="n">densname</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Angstrom</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;GDMA&#39;</span><span class="p">,</span> <span class="s1">&#39;GDMA_MULTIPOLE_UNITS&#39;</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Multipoles</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">origin</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Origin </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">origin</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;The GDMA origin array should contain three entries: x, y, and z.&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Switch </span><span class="si">%f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;GDMA&#39;</span><span class="p">,</span> <span class="s1">&#39;GDMA_SWITCH&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">radii</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Radius </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">radii</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Limit </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;GDMA&#39;</span><span class="p">,</span> <span class="s1">&#39;GDMA_LIMIT&#39;</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Start</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Finish</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">core</span><span class="o">.</span><span class="n">run_gdma</span><span class="p">(</span><span class="n">wfn</span><span class="p">,</span> <span class="n">commands</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fchkfile</span><span class="p">)</span>
    <span class="c1"># If we generated the DMA control file, we should clean up here</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">datafile</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span></div>


<div class="viewcode-block" id="fchk"><a class="viewcode-back" href="../../../fchk.html#psi4.driver.fchk">[docs]</a><span class="k">def</span> <span class="nf">fchk</span><span class="p">(</span><span class="n">wfn</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function to write wavefunction information in *wfn* to *filename* in</span>
<span class="sd">    Gaussian FCHK format.</span>

<span class="sd">    .. versionadded:: 0.6</span>

<span class="sd">    :returns: None</span>

<span class="sd">    :type filename: string</span>
<span class="sd">    :param filename: destination file name for FCHK file</span>

<span class="sd">    :type wfn: :py:class:`~psi4.core.Wavefunction`</span>
<span class="sd">    :param wfn: set of molecule, basis, orbitals from which to generate fchk file</span>

<span class="sd">    :examples:</span>

<span class="sd">    &gt;&gt;&gt; # [1] FCHK file for DFT calculation</span>
<span class="sd">    &gt;&gt;&gt; E, wfn = energy(&#39;b3lyp&#39;, return_wfn=True)</span>
<span class="sd">    &gt;&gt;&gt; fchk(wfn, &#39;mycalc.fchk&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fw</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">FCHKWriter</span><span class="p">(</span><span class="n">wfn</span><span class="p">)</span>
    <span class="n">fw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></div>


<div class="viewcode-block" id="molden"><a class="viewcode-back" href="../../../molden.html#psi4.driver.molden">[docs]</a><span class="k">def</span> <span class="nf">molden</span><span class="p">(</span><span class="n">wfn</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">density_a</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">density_b</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dovirtual</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function to write wavefunction information in *wfn* to *filename* in</span>
<span class="sd">    molden format. Will write natural orbitals from *density* (MO basis) if supplied.</span>
<span class="sd">    Warning! Most post-SCF Wavefunctions do not build the density as this is often</span>
<span class="sd">    much more costly than the energy. In addition, the Wavefunction density attributes</span>
<span class="sd">    (Da and Db) return the SO density and must be transformed to the MO basis</span>
<span class="sd">    to use with this function.</span>

<span class="sd">    .. versionadded:: 0.5</span>
<span class="sd">       *wfn* parameter passed explicitly</span>

<span class="sd">    :returns: None</span>

<span class="sd">    :type wfn: :py:class:`~psi4.core.Wavefunction`</span>
<span class="sd">    :param wfn: set of molecule, basis, orbitals from which to generate cube files</span>

<span class="sd">    :type filename: string</span>
<span class="sd">    :param filename: destination file name for MOLDEN file (optional)</span>

<span class="sd">    :type density_a: :py:class:`~psi4.core.Matrix`</span>
<span class="sd">    :param density_a: density in the MO basis to build alpha NO&#39;s from (optional)</span>

<span class="sd">    :type density_b: :py:class:`~psi4.core.Matrix`</span>
<span class="sd">    :param density_b: density in the MO basis to build beta NO&#39;s from, assumes restricted if not supplied (optional)</span>

<span class="sd">    :type dovirtual: bool</span>
<span class="sd">    :param dovirtual: do write all the MOs to the MOLDEN file (true) or discard the unoccupied MOs, not valid for NO&#39;s (false) (optional)</span>

<span class="sd">    :examples:</span>

<span class="sd">    &gt;&gt;&gt; # [1] Molden file for DFT calculation</span>
<span class="sd">    &gt;&gt;&gt; E, wfn = energy(&#39;b3lyp&#39;, return_wfn=True)</span>
<span class="sd">    &gt;&gt;&gt; molden(wfn, &#39;mycalc.molden&#39;)</span>

<span class="sd">    &gt;&gt;&gt; # [2] Molden file for CI/MCSCF computation using NO roots</span>
<span class="sd">    &gt;&gt;&gt; E, wfn = energy(&#39;ci&#39;, return_wfn=True)</span>
<span class="sd">    &gt;&gt;&gt; molden(wfn, &#39;no_root1.molden&#39;, density_a=wfn.opdm(0, 0, &quot;A&quot;, True))</span>

<span class="sd">    &gt;&gt;&gt; # [3] The following does NOT work, please see below</span>
<span class="sd">    &gt;&gt;&gt; E, wfn = energy(&#39;ccsd&#39;, return_wfn=True)</span>
<span class="sd">    &gt;&gt;&gt; molden(wfn, &#39;ccsd_no.molden&#39;, density_a=wfn.Da())</span>

<span class="sd">    &gt;&gt;&gt; # [4] This WILL work, note the transformation of Da (SO-&gt;MO)</span>
<span class="sd">    &gt;&gt;&gt; E, wfn = property(&#39;ccsd&#39;, properties=[&#39;dipole&#39;], return_wfn=True)</span>
<span class="sd">    &gt;&gt;&gt; Da_so = wfn.Da()</span>
<span class="sd">    &gt;&gt;&gt; Da_mo = Matrix.triplet(wfn.Ca(), Da_so, wfn.Ca(), True, False, False)</span>
<span class="sd">    &gt;&gt;&gt; molden(wfn, &#39;ccsd_no.molden&#39;, density_a=Da_mo)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_writer_file_prefix</span><span class="p">(</span><span class="n">wfn</span><span class="o">.</span><span class="n">molecule</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;.molden&quot;</span>

    <span class="k">if</span> <span class="n">dovirtual</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dovirt</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s2">&quot;SCF&quot;</span><span class="p">,</span> <span class="s2">&quot;MOLDEN_WITH_VIRTUAL&quot;</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">dovirt</span> <span class="o">=</span> <span class="n">dovirtual</span>

    <span class="k">if</span> <span class="n">density_a</span><span class="p">:</span>
        <span class="n">nmopi</span> <span class="o">=</span> <span class="n">wfn</span><span class="o">.</span><span class="n">nmopi</span><span class="p">()</span>
        <span class="n">nsopi</span> <span class="o">=</span> <span class="n">wfn</span><span class="o">.</span><span class="n">nsopi</span><span class="p">()</span>

        <span class="n">NO_Ra</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="s2">&quot;NO Alpha Rotation Matrix&quot;</span><span class="p">,</span> <span class="n">nmopi</span><span class="p">,</span> <span class="n">nmopi</span><span class="p">)</span>
        <span class="n">NO_occa</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="n">nmopi</span><span class="p">)</span>
        <span class="n">density_a</span><span class="o">.</span><span class="n">diagonalize</span><span class="p">(</span><span class="n">NO_Ra</span><span class="p">,</span> <span class="n">NO_occa</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">DiagonalizeOrder</span><span class="o">.</span><span class="n">Descending</span><span class="p">)</span>
        <span class="n">NO_Ca</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="s2">&quot;Ca Natural Orbitals&quot;</span><span class="p">,</span> <span class="n">nsopi</span><span class="p">,</span> <span class="n">nmopi</span><span class="p">)</span>
        <span class="n">NO_Ca</span><span class="o">.</span><span class="n">gemm</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">wfn</span><span class="o">.</span><span class="n">Ca</span><span class="p">(),</span> <span class="n">NO_Ra</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">density_b</span><span class="p">:</span>
            <span class="n">NO_Rb</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="s2">&quot;NO Beta Rotation Matrix&quot;</span><span class="p">,</span> <span class="n">nmopi</span><span class="p">,</span> <span class="n">nmopi</span><span class="p">)</span>
            <span class="n">NO_occb</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="n">nmopi</span><span class="p">)</span>
            <span class="n">density_b</span><span class="o">.</span><span class="n">diagonalize</span><span class="p">(</span><span class="n">NO_Rb</span><span class="p">,</span> <span class="n">NO_occb</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">DiagonalizeOrder</span><span class="o">.</span><span class="n">Descending</span><span class="p">)</span>
            <span class="n">NO_Cb</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="s2">&quot;Cb Natural Orbitals&quot;</span><span class="p">,</span> <span class="n">nsopi</span><span class="p">,</span> <span class="n">nmopi</span><span class="p">)</span>
            <span class="n">NO_Cb</span><span class="o">.</span><span class="n">gemm</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">wfn</span><span class="o">.</span><span class="n">Cb</span><span class="p">(),</span> <span class="n">NO_Rb</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">NO_occb</span> <span class="o">=</span> <span class="n">NO_occa</span>
            <span class="n">NO_Cb</span> <span class="o">=</span> <span class="n">NO_Ca</span>

        <span class="n">mw</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">MoldenWriter</span><span class="p">(</span><span class="n">wfn</span><span class="p">)</span>
        <span class="n">mw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">NO_Ca</span><span class="p">,</span> <span class="n">NO_Cb</span><span class="p">,</span> <span class="n">NO_occa</span><span class="p">,</span> <span class="n">NO_occb</span><span class="p">,</span> <span class="n">NO_occa</span><span class="p">,</span> <span class="n">NO_occb</span><span class="p">,</span> <span class="n">dovirt</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">occa</span> <span class="o">=</span> <span class="n">wfn</span><span class="o">.</span><span class="n">occupation_a</span><span class="p">()</span>
            <span class="n">occb</span> <span class="o">=</span> <span class="n">wfn</span><span class="o">.</span><span class="n">occupation_b</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">!Molden warning: This wavefunction does not have occupation numbers.</span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="s2">&quot;Writing zero&#39;s for occupation numbers</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">occa</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="n">wfn</span><span class="o">.</span><span class="n">nmopi</span><span class="p">())</span>
            <span class="n">occb</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="n">wfn</span><span class="o">.</span><span class="n">nmopi</span><span class="p">())</span>

        <span class="n">mw</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">MoldenWriter</span><span class="p">(</span><span class="n">wfn</span><span class="p">)</span>
        <span class="n">mw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">wfn</span><span class="o">.</span><span class="n">Ca</span><span class="p">(),</span> <span class="n">wfn</span><span class="o">.</span><span class="n">Cb</span><span class="p">(),</span> <span class="n">wfn</span><span class="o">.</span><span class="n">epsilon_a</span><span class="p">(),</span> <span class="n">wfn</span><span class="o">.</span><span class="n">epsilon_b</span><span class="p">(),</span> <span class="n">occa</span><span class="p">,</span> <span class="n">occb</span><span class="p">,</span> <span class="n">dovirt</span><span class="p">)</span></div>


<span class="c1"># Aliases</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">optimize</span>
<span class="n">freq</span> <span class="o">=</span> <span class="n">frequency</span>
<span class="n">frequencies</span> <span class="o">=</span> <span class="n">frequency</span>
<span class="n">prop</span> <span class="o">=</span> <span class="nb">property</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
        <p class="logo"><a href="../../../index.html" title="index">
          <img class="logo" src="../../../_static/psi4square.png" alt="Logo"/>
        </a></p><!-- 
#
# @BEGIN LICENSE
#
# Psi4: an open-source quantum chemistry software package
#
# Copyright (c) 2007-2017 The Psi4 Developers.
#
# The copyrights for code used from other parties are included in
# the corresponding files.
#
# This file is part of Psi4.
#
# Psi4 is free software; you can redistribute it and/or modify
# it under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation, version 3.
#
# Psi4 is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License along
# with Psi4; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
#
# @END LICENSE
# -->


<div id="searchbox" style="display: none" role="search">
  <!--<h3>Quick search</h3>-->
    <form class="search" action="../../../search.html" method="get">
      <!--<div><input type="text" name="q" placeholder="search docs" /></div>-->
      <div><input type="text" name="q" placeholder="&#xF002;" style="font-family:FontAwesome, Ariel" /></div>
      <!--<div><input type="submit" value="Go" /></div>-->
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >Index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="../../../index.html" title="Table Of Contents"
             ><i class="fa fa-book fa-lg"></i></a> &nbsp; &nbsp;</li>
    <li><a href="http://psicode.org/"><i class="fa fa-home fa-lg"></i></a></li>
    <li><a href="http://github.com/psi4/psi4"><i class="fa fa-github fa-lg"></i></a></li>
    <li><a href="http://forum.psicode.org"><i class="fa fa-comments-o fa-lg"></i></a></li>
    <li><a href="https://github.com/psi4/psi4/edit/master/doc/sphinxman/source/_modules/psi4/driver/driver.rst"><i class="fa fa-pencil fa-lg"></i></a></li>
    <li style="color: #1a4162">&nbsp;&middot;&nbsp;</li>
    <li><a href="https://github.com/psi4/psi4/tree/add49b9">1.1</a></li>
    <li style="color: #1a4162">&nbsp;&middot;&nbsp;</li>
    <li class="nav-item nav-item-0"><a href="../../../index.html">
        <span style="font-family: Optima, sans-serif;">P<span style="font-size: 82%;">SI</span>4</span>
        </a><i class="fa fa-angle-double-right" style="color: #a2a7b3; text-shadow: none;"></i></li>

          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a><i class="fa fa-angle-double-right" style="color: #a2a7b3; text-shadow: none;"></i></li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, The Psi4 Project.
      Last updated on Wednesday, 17 May 2017 05:47AM.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.6.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>